
console.log('widebundle loaded');
if(typeof wideBundle == 'undefined' && Shopify && Shopify.shop == 'widebundle-job-test.myshopify.com'){
var wideBundle = wideBundle || {};
wideBundle.settings = {"id":"58410","shop":"widebundle-job-test.myshopify.com","charge_id":"31494242591","status":"active","price":"18","currency":"\u20ac{{amount}}","currency_format":"mix","option1_title":"Select your offer:","atc_background":"#a72121","hover_color":"#a72121","atc_color":"#ffffff","atc_text":"Add To Cart","atc_font_size":"1.2em","atc_font":"auto","atc_radius":"5px","atc_size":"small","atc_animation":"no","border_color":"#bc2323","border_size":"2px","unselected_border_size":"2px","option_select_color":"#000000","option_select_background":"#ffffff","option_select_default_settings":"1","background_color":"#fceaea","price_color":"#bc2323","price_compared_color":"#989898","price_size":"0.9em","unselected_price_fontsize":"0.9em","unselected_compare_price_fontsize":"0.9em","selected_price_fontsize":"0.9em","selected_compare_price_fontsize":"0.9em","offer_color":"#333232","title_best":"Best Offer!","color_best":"#000000","link_choice":"form","installed":"1","affiliate_id":"0","ref":null,"onboarding":"3","economic_color":"#000000","economic_text":"You save {{percent}}% ({{amount}})","economic_display":"1","option_color":"#333232","enabled":"1","review":"0","onboarding_guided":"1","ask_referal":"1","price_separator":".","form_id":"product-form form[data-type=\"add-to-cart-form\"]","price_id":"not checked","select_id":"0","email_given":"0","email_perso":null,"before_code":"","after_code":"","trustbadge":"","offer_selected_color":"#333232","best_selected_color":"#000000","message_border_size":"0px","unselected_message_border_size":"0px","message_border_color":"#000000","unselected_message_border_color":"#000000","message_border_radius":"0px","unselected_message_border_radius":"0px","message_background_color":"#ffffff","unselected_message_background_color":"#ffffff","message_background_transparency":"00","unselected_message_background_transparency":"00","price_selected_color":"#bc2323","price_compared_selected_color":"#989898","economic_selected_color":"#000000","update_price":"0","design_code":"2","svg_number":"4","svg_size":"1.2em","display_quantity":"0","bg_button_quantity":"#ffffff","color_button_quantity":"#000000","bg_input_quantity":"#ffffff","color_input_quantity":"#000000","style_blinking":"none","style_title":"none","style_economic":"none","style_price":"none","style_compared_price":"none","style_variants_selected":"bold","style_blinking_selected":"bold","style_title_selected":"bold","style_economic_selected":"bold","style_price_selected":"bold","preview_heading_color":"#000000","preview_heading_position":"left","preview_heading_font_size":"0.9em","preview_heading_font_style":"none","heading_line_color":"#000000","heading_line_size":"2px","heading_line_display":"0","style_compared_price_selected":"bold","offers_heading_font_size":"0.9em","auto_round":"0","country_code":"FR","shopify_plan":"partner_test","no_decimal":"0","add_pixel":"1","utm_source":"","custom_css":null,"currency_code":"EUR","shop_creation":"2023-11-27 21:14:32","shop_id":"84362330399","referer":"Word of mouth","plan":"advanced","thumbnail_size":"m","thumbnail_color":"#e9e9e9","unselected_thumbnail_size":"m","unselected_thumbnail_color":"#e9e9e9","unselected_border_color":"#c6c6c6","unselected_background_color":"#ffffff","unselected_background_transparency":"00","font_unselected_custom_sentence":"auto","font_selected_custom_sentence":"auto","atc_content_text":"Out of stock","enable_atc_button":"0","current_amount":null,"billing_cycle":null,"current_sales":null,"legacy_amount":null,"priority_support":"0","advanced_price":"31","priority_price":"2","color_best_banner":"#000000","best_selected_color_banner":"#000000"};
wideBundle.domain = 'https://widebundle.com/';
wideBundle.shop = wideBundle.settings.shop;
wideBundle.templates = [];
wideBundle.templates = Object.keys(wideBundle.templates).map(key => wideBundle.templates[key]);
//Get the position of word in url
function posInUrl(text, subStrings) {
    var positions = {};
    subStrings.forEach(subString => {
      positions[subString] = text.indexOf(encodeURI(subString));
    });
    return positions;
}

//Check if a child is descendant of a parent
function isDescendant(parent, child){
    if(!parent){
      return false;
    }
    let node = child.parentNode;
    while (node != null) {
      if (node === parent) {
        return true;
      }
      node = node.parentNode;
    }
    return false;
};

//Get closest parent form
function getClosestParentForm(child){
  let node = child.parentNode;
  while (node) {
      if (node.tagName === "FORM") {
          return node;
      }
      node = node.parentNode;
  }
  return null;
}

//Add some style to the page
function addStyleToPage(styles, attribute = ''){
    var css = document.createElement('style');
    if (attribute !== '') {
      css.setAttribute('wb-' + attribute, '');
    }
    css.type = 'text/css';
    if (css.styleSheet)
        css.styleSheet.cssText = styles;
    else
        css.appendChild(document.createTextNode(styles));
    document.getElementsByTagName("head")[0].appendChild(css);
}

//Check if string is json
function isJsonString(str) {
  try {
      JSON.parse(str);
  } catch (e) {
      return false;
  }
  return true;
}

//Get SVG codes
function AddSVG(){
  var size = wideBundle.settings.svg_size;
  var color = wideBundle.settings.atc_color;
  var svg = wideBundle.settings.svg_number;

  if(svg == 1){
    svgCode = '<svg style=\'margin-right:10px;fill:'+color+';\' height=\''+size+'\' width=\''+size+'\' viewBox=\'0 -31 512.00033 512\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'m166 300.003906h271.003906c6.710938 0 12.597656-4.4375 14.414063-10.882812l60.003906-210.003906c1.289063-4.527344.40625-9.390626-2.433594-13.152344-2.84375-3.75-7.265625-5.964844-11.984375-5.964844h-365.632812l-10.722656-48.25c-1.523438-6.871094-7.617188-11.75-14.648438-11.75h-91c-8.289062 0-15 6.710938-15 15 0 8.292969 6.710938 15 15 15h78.960938l54.167968 243.75c-15.9375 6.929688-27.128906 22.792969-27.128906 41.253906 0 24.8125 20.1875 45 45 45h271.003906c8.292969 0 15-6.707031 15-15 0-8.289062-6.707031-15-15-15h-271.003906c-8.261719 0-15-6.722656-15-15s6.738281-15 15-15zm0 0\'/><path d=\'m151 405.003906c0 24.816406 20.1875 45 45.003906 45 24.8125 0 45-20.183594 45-45 0-24.8125-20.1875-45-45-45-24.816406 0-45.003906 20.1875-45.003906 45zm0 0\'/><path d=\'m362.003906 405.003906c0 24.816406 20.1875 45 45 45 24.816406 0 45-20.183594 45-45 0-24.8125-20.183594-45-45-45-24.8125 0-45 20.1875-45 45zm0 0\'/></svg>';
    return svgCode;
  }
  else if(svg == 2){
    svgCode = '<svg version=\'1.1\' id=\'Layer_1\' xmlns=\'http://www.w3.org/2000/svg\' height=\''+size+'\' width=\''+size+'\' xmlns:xlink=\'http://www.w3.org/1999/xlink\' x=\'0px\' y=\'0px\'	 viewBox=\'0 0 512 512\' style=\'enable-background:new 0 0 512 512;margin-right:10px;fill:'+color+';\' xml:space=\'preserve\'><g>	<g>		<path d=\'M402.351,381.058h-203.32l-11.806-47.224h266.587L512,101.085H129.038L108.882,20.46H0v33.4h82.804l82.208,328.827			c-24.053,5.971-41.938,27.737-41.938,53.611c0,30.461,24.781,55.242,55.241,55.242c30.459,0,55.241-24.781,55.241-55.242			c0-7.755-1.613-15.138-4.511-21.841h122.577c-2.897,6.703-4.511,14.086-4.511,21.841c0,30.461,24.781,55.242,55.241,55.242			c30.459,0,55.241-24.781,55.241-55.242C457.592,405.84,432.811,381.058,402.351,381.058z M287.029,300.434h-37.08l-8.284-66.275			h45.365V300.434z M411.912,134.484h57.31l-16.568,66.275h-49.026L411.912,134.484z M399.453,234.16h44.85l-16.568,66.275h-36.566			L399.453,234.16z M320.428,134.484h57.824l-8.284,66.275h-49.539V134.484z M320.428,234.159h45.365l-8.284,66.275h-37.08V234.159z			 M287.029,134.484v66.275h-49.539l-8.284-66.275H287.029z M137.388,134.484h58.158l8.284,66.275h-49.873L137.388,134.484z			 M162.307,234.159h45.699l8.284,66.275h-37.414L162.307,234.159z M178.315,458.141c-12.043,0-21.841-9.798-21.841-21.842			c0-12.043,9.798-21.841,21.841-21.841s21.841,9.798,21.841,21.841C200.156,448.343,190.358,458.141,178.315,458.141z			 M402.351,458.141c-12.043,0-21.841-9.798-21.841-21.842c0-12.043,9.798-21.841,21.841-21.841			c12.043,0,21.841,9.798,21.841,21.841C424.192,448.343,414.394,458.141,402.351,458.141z\'/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
    return svgCode;
  }
  else if(svg == 3){
    svgCode = '<svg version=\'1.1\' id=\'Capa_1\' xmlns=\'http://www.w3.org/2000/svg\' xmlns:xlink=\'http://www.w3.org/1999/xlink\' x=\'0px\' y=\'0px\'	 viewBox=\'0 0 502.187 502.187\' style=\'enable-background:new 0 0 502.187 502.187;margin-right:10px;fill:'+color+';\' height=\''+size+'\' width=\''+size+'\' xml:space=\'preserve\'><g>	<g>		<polygon points=\'277.333,112.427 277.333,48.427 234.667,48.427 234.667,112.427 170.667,112.427 170.667,155.093 			234.667,155.093 234.667,219.093 277.333,219.093 277.333,155.093 341.333,155.093 341.333,112.427 		\'/>	</g></g><g>	<g>		<circle cx=\'170.667\' cy=\'432.427\' r=\'42.667\'/>	</g></g><g>	<g>		<circle cx=\'341.333\' cy=\'432.427\' r=\'42.667\'/>	</g></g><g>	<g>		<rect y=\'27.093\' width=\'85.333\' height=\'42.667\'/>	</g></g><g>	<g>		<polygon points=\'384,112.427 384,155.093 436.48,155.093 370.133,304.427 146.56,304.427 106.88,27.093 85.333,27.093 			64.213,30.08 109.44,347.093 397.867,347.093 502.187,112.427 		\'/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
    return svgCode;
  }
  else if(svg == 4){
    svgCode = '<svg version=\'1.1\' id=\'Capa_1\' xmlns=\'http://www.w3.org/2000/svg\' xmlns:xlink=\'http://www.w3.org/1999/xlink\' x=\'0px\' y=\'0px\'	 height=\''+size+'\' width=\''+size+'\' viewBox=\'0 0 45.402 45.402\' style=\'margin-right:10px;fill:'+color+';enable-background:new 0 0 45.402 45.402;\'	 xml:space=\'preserve\'><g>	<path d=\'M41.267,18.557H26.832V4.134C26.832,1.851,24.99,0,22.707,0c-2.283,0-4.124,1.851-4.124,4.135v14.432H4.141		c-2.283,0-4.139,1.851-4.138,4.135c-0.001,1.141,0.46,2.187,1.207,2.934c0.748,0.749,1.78,1.222,2.92,1.222h14.453V41.27		c0,1.142,0.453,2.176,1.201,2.922c0.748,0.748,1.777,1.211,2.919,1.211c2.282,0,4.129-1.851,4.129-4.133V26.857h14.435		c2.283,0,4.134-1.867,4.133-4.15C45.399,20.425,43.548,18.557,41.267,18.557z\'/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
    return svgCode;
  }
  else if(svg == 5){
    svgCode = '<svg style=\'margin-right:10px;fill:'+color+';\' id=\'Layer_1\' enable-background=\'new 0 0 512 512\' height=\''+size+'\' width=\''+size+'\' viewBox=\'0 0 512 512\' xmlns=\'http://www.w3.org/2000/svg\'><g><path d=\'m512 213.206h-55.385l-46.288-119.318-27.969 10.849 42.08 108.469h-141.111l90.415-142.055h-53.912v-71.15h-127.705v71.15h-53.919l90.458 142.055h-141.08l42.079-108.469-27.969-10.849-46.288 119.318h-55.406v60.004h512z\'/><path d=\'m64.868 511.999h382.263l31.391-208.789h-445.044zm266.149-171.306h30v103.822h-30zm-60.004 0h30v103.822h-30zm-60.004 0h30v103.822h-30zm-60.004 0h30v103.822h-30z\'/></g></svg>';
    return svgCode;
  }
  else{
    return '';
  }
}

//Get base URL
function getShopifyBaseUrl() {
  if (Shopify?.routes?.root) {
    return Shopify.routes.root;
  }
  return "/";
}

//Compare 2 arrays
function arraysEqual(_arr1, _arr2) {

  if (!Array.isArray(_arr1) || ! Array.isArray(_arr2) || _arr1.length !== _arr2.length)
    return false;

  var arr1 = _arr1.concat().sort();
  var arr2 = _arr2.concat().sort();
  for (var i = 0; i < arr1.length; i++) {
      if (arr1[i] !== arr2[i])
          return false;
  }
  return true;
}

//Check if a text contains only numbers
function containsOnlyNumbers(text) {
  return /^\d+$/.test(text);
}

//Send the event change on element
function fireChangeEvent(node){
  if('createEvent' in document){
    var evt = document.createEvent('HTMLEvents');
    evt.initEvent('change', false, true);
    node.dispatchEvent(evt);
  }
  else{
    node.fireEvent('onchange');
  }
  setTimeout(function() {
    if('createEvent' in document){
      var evt = document.createEvent('HTMLEvents');
      evt.initEvent('change', false, true);
      node.dispatchEvent(evt);
    }
    else{
      node.fireEvent('onchange');
    }
  }, 100);
}

//Trigger mouse event
function triggerMouseEvent (node, eventType) {
  var clickEvent = document.createEvent ('MouseEvents');
  clickEvent.initEvent (eventType, true, true);
  node.dispatchEvent (clickEvent);
}

//Dispatch click event
function dispatchClick(node){
  if('createEvent' in document){
    var evt = document.createEvent('HTMLEvents');
    evt.initEvent('click', false, true);
    node.dispatchEvent(evt);
  }
  else{
    node.fireEvent('click');
  }
  setTimeout(function() {
    if('createEvent' in document){
      var evt = document.createEvent('HTMLEvents');
      evt.initEvent('click', false, true);
      node.dispatchEvent(evt);
    }
    else{
      node.fireEvent('click');
    }
  }, 100);
}

//Frire un event
function eventFire(el, etype){
  if (el.fireEvent) {
    el.fireEvent('on' + etype);
  } else {
    var evObj = document.createEvent('Events');
    evObj.initEvent(etype, true, false);
    el.dispatchEvent(evObj);
  }
}

//Some shops are using this function even if we don't need it anymore at least it won't send an error
function showAndReduceForm() {
  return;
}

//Copy style from an element to another
function copyStyle(sourceElement, targetElement) {
  const sourceStyle = window.getComputedStyle(sourceElement);

  for (let i = 0; i < sourceStyle.length; i++) {
    const styleProperty = sourceStyle[i];
    targetElement.style[styleProperty] = sourceStyle.getPropertyValue(styleProperty);
  }

  const styleSheets = document.styleSheets;
  //For hover
  for (const styleSheet of styleSheets) {
    let cssRules;
    try {
      cssRules = styleSheet.cssRules;
    } catch (e) {
      // Skip CORS protected stylesheets
      continue;
    }

    for (const cssRule of cssRules) {
      if (cssRule.selectorText && cssRule.selectorText.includes(':hover')) {
        const sourceSelector = cssRule.selectorText.replace(':hover', '').trim();

        if (sourceElement.matches(sourceSelector)) {
          const targetSelector = sourceSelector + '[data-copied-style="true"]';
          const hoverStyle = cssRule.cssText.replace(cssRule.selectorText, targetSelector);
          const styleElement = document.createElement('style');

          styleElement.innerHTML = hoverStyle;
          document.head.appendChild(styleElement);

          targetElement.setAttribute('data-copied-style', 'true');
          break;
        }
      }
    }
  }
}

function AddGoogleFont(fontFamily) {
  if (!document.querySelector(`link[data-wb-font="${fontFamily}"]`)) {
    const link = document.createElement("link");
    link.setAttribute("data-wb-font", fontFamily);
    link.rel = "stylesheet";
    link.type = "text/css";
    link.href = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/\s/g, "+")}:ital,wght@0,400;0,700;1,400;1,700&display=swap`;
    document.head.appendChild(link);
  }
}

function GetLoadingGifBase64() {
  return "data:image/gif;base64,R0lGODlhPAA8APMAAOjo6NPT09fX19vb29/f3+Dg4Ofn5+jo6Ozs7PLy8vn5+QAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJCgAAACH/C0ltYWdlTWFnaWNrDmdhbW1hPTAuNDU0NTQ1ACH+KU9wdGltaXplZCB3aXRoIGh0dHBzOi8vZXpnaWYuY29tL29wdGltaXplACwAAAAAPAA8AAAE/xDISau9OOvNu/9glyRhaU7jeK5emrKskrkqhsCZousXTVqIg/CGq+x4Ft9FyCwaj7KKssJsOifQKGVKqQqv2KyURvUSwQDxljwJetEUtYQL8B7gcTnXzTzj01AobHVvMEcYWVFTdn4UBgUFBhxyeYcAi4UVj5CQkjmJWmGHSoyam5yRG6ChgJYuEnZdp6gFdxqrSBKBF3y2ErO0npO4ujsafb+0qMIfxCbKnAa+Ic4gwJ3MJ6Al19mGu9bLeJbcnX/nzbi5MAQD7u/wAwQW6pQlBO3x+vLzovXr9/YJ7FfsH8AQ+QTGI9jKIIuECt8xbKgOB8SBBdBpVHXQwwABAp3+2OvwEaSAAWC2hRAQwCRIlDhWlWDp0mQMmSVK1nxZomLBW7l2uoTZwSdFROR0CiX6SWVBYw2frlNak2MieoHEjKTKsym5SlDVjASwk+kFcGDD7rpqQafZHF5zyRkr4a0JthS14B2HlhLdInv9/v32Ne+Twk5GKkabmLHhw1BTIn4MmRXgyWMdX45rOczGs5o/A50senTn0qhTr4gAACH5BAkKAAAAIf8LSW1hZ2VNYWdpY2sOZ2FtbWE9MC40NTQ1NDUALAAAAAA8ADwAgwAAANfX19vb29/f3+Dg4Ofn5+jo6Ozs7PLy8vX19fn5+QAAAAAAAAAAAAAAAAAAAAT/EMhJq7046827/2CnjGFpSiN5rmKqsqeSua+VJDBGX7RsI0BcrrKz9C4JIHBILFKOlaQSIWQCoE/nZEq1Zl1NMEWqrHp7PpSWHPSGU1/4hI1wv+VXJ91sz4v9eFx1MH93KlB7FwcGjAccWHGHRVx8EouMjRpoNWpiO4kUl5iZmptpgJIqbGaio6QzpqdaY1OhrqOOLaYTeEhUQq2uuSCxJ7e4Mbshx68rmyXHw0OQHq3SZ5wfl9d93Y+x2SYGBeTl5uUGhuAsBQTu7/DxBZHgpyXx+Pj06yv5/u77iq1o9+/dAALz1KHJMQ6hP3LpvEn8Zu8DgQEDulHrQECARwEZt608CzEggMkAHkMSGgligICTHw86U1bC5UmUKUvw86PBJUgJGE1+jPlBYKdwAEqepODT402MFBfyKiLmpkkKF52+NCkTllR6qGRsPalSQtaPKAls2Bj2qAqrAi40Nam2VC+wbQGMFXqhgM+yyf5gsRpg4lcsSmFKhARpb2GNjLUk5tuHGjXHgKfNyksBrp2NGzG72cyZwt66IgtNVQ1U8eeKq+9O6Jh5olvYtqPizm13N+/fwFlEAAAh+QQJCgAAACH/C0ltYWdlTWFnaWNrDmdhbW1hPTAuNDU0NTQ1ACwAAAAAPAA8AIMAAADX19fb29vf39/g4ODn5+fo6Ojs7Ozy8vL19fX5+fkAAAAAAAAAAAAAAAAAAAAE/xDISau9OOvNu/8gp4xhaU4jea5dmrKskrnqJcMYbet7jaOu3svC+wGDFdqNojQyi8fhE+mUNKdS67UK2Gqp3yzXS4Zyu9u094ymqsEneHR4VS4riHxCZA6r6n0ACXmEezN2d34yTWuChI+Gh3ZJPEheg4+PfIh3gW0+maEenDVilCqYoXklpCeqhXGcJa8IkSuIs6pVjRyibKYesGzDIKTAJQfJysvLRMaeHgcG09TV1gdYz4kh1t3d2c8s3uPT4MYs0uTXp+Ew6Qbv09LzxPUtPiAF+sO8GwUEAAkU2DUpRMCDBn7ICvHvIMACCWPhKmHA4cGBIc590TBgAIEJDbUtCvyg8dM2CR0DBBgwwUBIhxA3FVQkQaVKlCoFCGAJUiTADQvBARhgc+XQnQJuVngZEGMOXleKKtWZtOMFpk6fHruStCjOlAI+Wqj4EMeWrjknECW6M0M5GDPRKh0agGpbYl7kCqAwwO5efnml8tWp0uovM1L/qu1qeEwfvRbA3iUoB3IFtn0VOwkkN8CFzDrPcC6qeQIBqjwdZ5Dq+QLA1PYqJI5dgqhN2LQ99K2bu7dvNhEAACH5BAkKAAAAIf8LSW1hZ2VNYWdpY2sOZ2FtbWE9MC40NTQ1NDUALAAAAAA8ADwAgwAAANfX19vb29/f3+Dg4Ofn5+jo6Ozs7PLy8vX19fn5+QAAAAAAAAAAAAAAAAAAAAT/EMhJq7046827/2CnjGFpSiN5rmKqsqeSua9VwxR90fKe4jaXTxj8AXO6Cq9oPKKSSGK06QQspzder2q9PqVfKtfbBZO5ZalXi1ZC19AVGKu6sofbWXxiT57DYm53dIBpN4ZzTGR9dXtah4qLiYV8j5B4g4FRlZYllnkgn3KdIaIwj56DQH8crKuXrbBts3qfoCcIuQgJur26graaH77ExHS2LMXKucemuMvFzaTPvbzLkagwugnc17TfsbceB+QHba4aBwbrBuZO2SDq5evup/Af8uTs5KP38e3z6KWaJiCAAA0FEhaQUE4dO4EenAEIQNEghgIEMhKg4HBfw3CqsQpWDCBhgMkBEjBqXDhBn8dyGqZNGElRgoCbAjaqXFnBJT1+tSaJrIiSAE4BKAFozMiy58sNe2zSPKj0KNWdTC+4rLeCJkkJRo9OwLrx21CKVKuKTbmUQNM2XimExUmBLK2zFifMvUnBQNu3VeLKtVqBLGAgeJPqJVyhbdnAI9MuXlv3LxeaF/ZKHrsUzdDNYBlX8JsVzQCkGDRnSAgu9VHFrUGcvvk49gcCJ23r3t0mAgAh+QQJCgAAACH/C0ltYWdlTWFnaWNrDmdhbW1hPTAuNDU0NTQ1ACwAAAAAPAA8AIMAAADT09PX19fb29vf39/g4ODn5+fo6Ojs7Ozy8vL19fX5+fkAAAAAAAAAAAAAAAAE/xDISau9OOvNu/9gt4xhaUpjeq5iSrLrkrnvVcMVbev7jaOunspCk/0mRSKPUjQeAc3cEjl9JpnV6JM6vXKH2+/NC62GteUg0HxeeskntvaKlvqE93SQLofb/XwqdXpsWE1OhEZqcId5ho1iGF2NiBqUTmBCa4cllyaUMZAhoDCco4OlhZaqqZUfamGxn5eOp7RKtLUtuWO8uhy+vb4swYjFxMG4nq23ss4gA9EnCdQKsgMCAgECAyXU3wlb2NnkAt7g3z/l5d0h6ODWJ+Pl2wIEJu/wIfPr3BMEA+5lQEAQgYR84DwQWBegYbYC/6IFxEDwgEWDBxFS48CPHYUCEsInAjhgoKSEihcpKNAYLsPCfu0oAJQo0ECBmwYAVNxZYWU+DQbWDYBYASRNiAdu4jyJ8sCFnxpeirQwM5rApEpz6iyY0oLPjTBCTsW6lCnKZxIMiBU4UmkBrQAUIDgwly7atRTIvqUwt65dWUZp8nULF0CCvgWdVZU2OGsFxInDBA5IdILewma7blnM1jJhC4ctaj5StbNnxxb8/n1iACCBynk/g66LMYxNzKfLXiCINsPl3ids3nQKvARJk8WTK38WAQAh+QQJCgAAACH/C0ltYWdlTWFnaWNrDmdhbW1hPTAuNDU0NTQ1ACwAAAAAPAA8AIMAAADX19fb29vf39/g4ODn5+fo6Ojs7Ozy8vL19fX5+fn8/PwAAAAAAAAAAAAAAAAE/xDISau9OOvNu/9gpyhhaU7jeK5emrIsibnqDGf0pSz8IluuGzBo6fF+FNdCWNn5aslc8wllApzPITFJRVqPL+7I16R5meAxt+cdh63R1HLCrsp5cO14Dqj/qEd5elBdf103W2VSNHN+ZxKJM05VdHtzZhJPPRdGbzpuckNGkEFKeBRGhxp7Soo7MlSkkXdSOJO0cTuSaiimkRlpoHyeeqSOlCJKbie+xCBmoSGMYIhmfB/T19W/HJiCV8gtzt/kGwPn6OnpQtDeFQHw8fLzAyyphe4AAvP88zH3cvLt60fw3y1LoCgMINhPQAxWdzp5GSCgosWLFuvBiNjuUbmPFv/OEWAWTgjFjCXy3SBwEqU0UCVDtMSYEmLMDjMxjqwp8SaGnBc1AihAVAOCoyiO+VSIMaPQAgSiFsBwtGouS6c0AK0odGhUqRIQHBgbtirSXtk2EGgqoKsEqF+nAhhrwMABAGaPJnCVMMPaoG69fiUwdeyBunfnjrWqJ5BWlxYGE5ZwuK7dsIb1fhp3YecFuF8NULaLeELms+UMSJar2HBivAfyfgQdlYJrshPyIihHe7JpxLglJDiamdzqCgiAvy6beW+e3qJtWw6eezFqK7RZ/55uQfduOJIvuL7c3axz7HHFGyZfYTjj5wWid6fLvjxIDOvr3/9gWf/+Dq79J+AEgN9EAAAh+QQJCgAAACH/C0ltYWdlTWFnaWNrDmdhbW1hPTAuNDU0NTQ1ACwAAAAAPAA8AIMAAADX19fb29vf39/g4ODn5+fo6Ojs7Ozy8vL19fX5+fkAAAAAAAAAAAAAAAAAAAAE/xDISau9OOvNu/9gp4xhaUpjeq5iSrKrkrnvJcMYbet7jU+8Cu0mdP2KRqRKuTwChhYok+h8BlFXa/Y4pEqBW+dX2ySXq+bat4uOBtfhkCBAF/SSUvadQ+8H7i95YXoYA359dlNYKoSLYxeHfomOgUuPXWcWhpF9FHFXmJkYc5x0YFRulaElpXUmoT4gpJwlsDizfrWNt4e6SW2dr6JtxBwDAsjJysgEP7Ciy9HKAyzPY8fS0tQx1r8A2NnR1TQJthMF4dHbJ93eAATg4evc3cX2HwX57LFOBQT/BAr4GnbCH0CAA90VPHgwoUIQBhn+E+jw4YaIEgNKOMBRQ5NnH6UyAqQI4ICBkwcwlCsDcoNIjRNMnjwpAYFNBJS8rNJgICPJCTNn1ryJc9dODD0Z/twY1EDKBERxpgHEr0LEpUCbSoBKNCcqSh6wxmyaEgDXm6cIHpE5s6zZqGnV4mBLc8JZm57i/KDrlMJdqV6LNTVQ4e+Ur3PJFoarCI3ixV0POw7q1i7jxk7YVrYcmQkxjps5o82B+N7Wy6ZDoE794Szr17DvRQAAIfkECQoAAAAh/wtJbWFnZU1hZ2ljaw5nYW1tYT0wLjQ1NDU0NQAsAAAAADwAPACDAAAA19fX29vb39/f4ODg5+fn6Ojo7Ozs8vLy9fX1+fn5AAAAAAAAAAAAAAAAAAAABP8QyEmrvTjrzbv/YKeMYWlKY3quYkqy60Bg7nspcEYE/HDXNFWuIuDxfi6kcCgpGgWWGq4inTIBA2OPCuQmrxNtAEqRer9grJiM6k7M6YnTWHYDqvFJVsuG3/15AHNHbWiAJwQDijMWO3yFQnhKHANOAj4Wg2N/X4eQSxcFlXuKmBSDZECSb1VWGJU8ArKXjBJ7dJxTh602GKIBlbNbck9BhryuGoqzsmOXcrIancgly5aXMibIyR+JzLOmH9QwBMyjJa1gwbLhHp5MpSdogfQcBff4Bgb49wZD270mFCBAkAA/ggMRsgBoZ19BgwYPFlzIENS+ew8TPiToT17FXhfLN2bEWEvbx2QX+anEl+NjvZcbDhg44JEbE5n69KGzkwNnTp0h0vX8+XPnKhM+ic40KRREUqU0ARw4gECajW0flP6MCgCBV6/GemHdoDUnhQRfweb65GoshqdmK6RVq2pX0wsIoFqYCxbOu6MXfHKVO5ctW5s8MwwmnDaB4cf0EkxNy+pYYjBTJ1etDOodE6+Zp9aZB/hKWtGjQeVSPYSv49QBV9uEwTdK4tK0G9uexzl27q9KfF/OATz47D8wjSc36nu51ebOo0s/EQEAIfkECQoAAAAh/wtJbWFnZU1hZ2ljaw5nYW1tYT0wLjQ1NDU0NQAsAAAAADwAPACDAAAA19fX29vb39/f4ODg5+fn6Ojo7Ozs8vLy9fX1+fn5/Pz8AAAAAAAAAAAAAAAABP8QyEmrvTjrzbv/YDcIQ2iekhCsBOqK6yq8b5ENcTBjCp0Vo0HLgovtLIpkz1cZCUiXouyiVCyYzeez1MwdJ9YqluLcEr3IhXgsIQTNZDSlqmRPys+hRKqrJNVJdhRacHtyEkoLileCe1pBd4eAVmqNZIRHfEeKay8GBaAYBJhcmhKLnX51GwUErqFEmIZGiH+KF4uTGq2uvQUGFaOEJXwlVYsVuZNLPwS8rzZkZVwqfQB0jGC2dBufoL3Ql4Vu2qu1icsdB9/gr8AAbgNcPKu2y38gn+2+KMf3KPr2RQOBjRMzF+z4hSiYzUfAVyboBLLjbeBCc5YycjjAsaPHjlj/JIq8cMCAyZMoUR54oeyeRAolU8pE+YJSrkQvJ8ScObOmGoP2/kyUsJOnyprb0N08CIBjyo4GYq6koVTkUI1YMSRAkKDfVTZbEYjtejGVj7Bi00YUitEF2rRi11IyG+ItXK5yl37tYPcuWU4azNkc6eGuX22AMAAtp/QWB8NpyZ5bhepUOsb2Gl6APFbVmsVAmV7DtpcCZMmYA6GaOKkSkpwZ4KKew230GpuJX7fVOpt2J9hLM5QOsXooJ8CWa1tSdpC5791jMjdEd7CxJX+ekSNGJohw6jS67MD+7ucyG+VzFusejhT6YNG22bdXrF53Vlz1739Ar78D3f4ABvhCAQQAIfkECQoAAAAh/wtJbWFnZU1hZ2ljaw5nYW1tYT0wLjQ1NDU0NQAsAAAAADwAPACDAAAA09PT19fX29vb39/f4ODg5+fn6Ojo7Ozs8vLy+fn5AAAAAAAAAAAAAAAAAAAABP8QyEmrvTjrzbv/YEcQYWlOxDCQZ9sVqsq655HB8WzpdHUUQMMFJ8MIjoOeBcgcxlaXo1RZKRgMweUzWSFIkdSJ9QrU5izfY3hyxWYpxFFlkOauAWSmUJzjpQV3cExlfGcTdF92gW5BewBEKih/gVWDBYUxE18BgDQICAcIGIxYe5BcA5xSihQKrgocB6Gfohakpk8skxavvRqgs5+hS5aPuQCIqxW9zBuytLLDFIxWEilQyGnLzL6/s9HB06WOFXUT3M0dwODAtWTkFohc6N0fws/ttSX0ryf34NJA8IPlCWDAD/TWrDvogRslYfpC1KNE0UOCixgzYqQysJ8FjSCwNbro6HBCAgQhU44kOfFkyk8iW7Bs+RJmxpUzCZpMCbJHzopAO3jc54piSYHpOKIjehRn04YJZQ40MVViVQBDLwztiPBq0m1br2oQW7JbU7Fao7ZK1+wpVrVp3S4t+/WcW7BF43qkW1dCXww6eSU9etdv4BNLDddLbPTr2b9KHUuG7LPu08I0GCvOujnvGrl9MUvl3Plw50B/71LGCZiy56B4X8PuSno2h4m2c+sOEwEAIfkECQoAAAAh/wtJbWFnZU1hZ2ljaw5nYW1tYT0wLjQ1NDU0NQAsAAAAADwAPACDAAAA09PT19fX29vb39/f4ODg5+fn6Ojo7Ozs8vLy9fX1+fn5AAAAAAAAAAAAAAAABP8QyEmrvTjrzbv/YGeMYWlKRVocZyuqheG6SGbAMlbMGXL8NctNlbMQBgMCz/JrXoapIuWIHCwrB4TWJ8RZCtXk7irJblkVaMwYVpIn2iZ6opYCwMf8G+5rBiV1FVRVexRyWhSBE4NIboUAcmZ0XihVeo8TkXOKAIxWMwoJCQoYfX6AlGBtGAMCAp8aorKkFltbqEQSjI5Trr6wF6Gys0xmiIGqloKtvq7AF8PRtGV+aEM5VJeVza4BArzB0cPTkEB/FcnAzNzOHsLioxKmGgT1YwTsv+Ab7/An6wK8OdvnDl68EACbPTPRT1aJfAtd9CPnAWCSQgpCUfzQ6iKmjx6/FogcSXLklZIoRV5IyXKBi5YsKcBM+XJmSZk2SdbMqXICT5Mtfvb0yZPHT5BINwAtsXQPSqY3ycQMMXVGS6g0g8I0sZVqVwBNLSyd+YGshKhidZ79qoHtU7BA366tiuFqhbc35RLNWlfvXp140eIUvFJtWrWBCc8dqjSD3MeKfS7hCzmyVMF6/b7hC9dwZ8+bCfvVPHm0YtJWT6sGXTrsYsZ/XTpl/Rn260euX8sunLQw7d5KfwN3nHu48eMtIgAAIfkECQoAAAAh/wtJbWFnZU1hZ2ljaw5nYW1tYT0wLjQ1NDU0NQAsAAAAADwAPACDAAAA19fX29vb39/f4ODg5+fn6Ojo7Ozs8vLy9fX1+fn5/Pz8AAAAAAAAAAAAAAAABP8QyEmrvTjrzbv/YHccYWlORmqcrHeoBtmySaa+8rXOGOIjNctomKMYCMgCz/LzXYijC3K6rDSdFVjMUpgiq5QrwqItSrxfsCQhzkIrXa9SLWkb3xT0nA5gXylEWxNoBHxhV0EAQyk5cVN7hgB2ijA5hDwKmQo9dmUSjkkYA6OFG5kLC5kXnZVnaFICsbGlGJqpthV+TZQ3AKAEkAAEA7ICxLS1CqiaylZ/ijiujxXEsdXHpsq3p6mHPxigFNXGxcYey8y3C2vfGXE74+XmINvazCfE8dbIIMz+6yH0kRuAyV+zgPlkEQRjsES8hXTumRg1gF+kixrSoZPIg6LHjxDyJygzyM0WwBMCAqhcybJlhZEk6x080bJmSwEUUMnUWe+kCZtAVebkqU6nvxYpg7YMCYCkUx7yos7DSDWDzhOaImlbVqIhw1Ngu5ZUVZCkWKNZWaA9KnYr235u33LNkLbpWo4cTPIk2xQmho0i//HsoHGZT69GJWzcFLiwzwsy6zZOi05xPQsGb2mIfCEd47WKbTF+6ZUuXgpeU+8djfp0MtMcS682zePuBMPdLL81NPv23tauvxIFPleC3sdfuZG2R3own9KT+YoEHHG3cet2g8/AbndbZ+0tuMf9Ljn5X+qYpVf17X09XPDuk6mPT7/+jAgAOw==";
}

//Function to create tags <link> for all used Google fonts
wideBundle.loadGoogleFonts = function(){
    const settingsKeys = ["atc_font", "font_unselected_custom_sentence", "font_selected_custom_sentence"];
    settingsKeys.forEach(function (key) {
        if (wideBundle.settings[key] != "auto") {
            AddGoogleFont(wideBundle.settings[key]);
        }
    });
};

//Function to get the Add To Cart Button
wideBundle.getAddToCartButton = function(){

    //Add to cart button selectors in the form
    var submitButtons = [
        "gp-product-button button", ".bettercart_checkout.elm_pos_0", ".bettercart_checkout", ".add-to-cart-first", ".add_to_cart", ".button--add-to-cart", ".shg-btn", "button[data-pf-type='ProductATC2']", "input[type='submit']", ".smart-wrapper .add-to-cart-btn#AddToCartDesk", ".btn--add-to-cart",
        ".product-form__item--submit .product-form__cart-submit", ".gt_product-button", ".add", "button#addToCartCopy", 'button[data-name="Product Button"]', ".paymentButtonsWrapper button[type='submit']", "button[type='submit']", ".gf_add-to-cart", "button[data-pf-type=\"ProductATC\"]", "button.add-to-cart",
        ".product-form__submit", "button.single_add_to_cart_button", '.tt-wrapper .btn-addtocart', '#AddToCart', 'button.product-submit', '.button--addToCart', '.product__buy .product__add-to-cart', "button[class*='f-buy-buttons']", ".product-buy-buttons--cta", 'button[data-replo-repeated-index][role="button"]'
    ];

    //exceptions
    var buttonsExceptions = [
      ".spr-button"
    ];

    if(wideBundle.formInfo.element){
        findButton:
        for(i=0; i<submitButtons.length; i++){
            buttonFound = wideBundle.formInfo.element.querySelector(submitButtons[i]);
            if(buttonFound){ //Button in form

                for(var x=0; x < buttonsExceptions.length; x++){ //Check exceptions
                    exceptionAll = wideBundle.formInfo.element.querySelectorAll(buttonsExceptions[x]);
                    for(var z=0; z < exceptionAll.length; z++){
                        exception = exceptionAll[z];
                        //If the button is child of an exception
                        if(exception == buttonFound || isDescendant(exception, buttonFound) || isDescendant(buttonFound, exception)){
                            console.log('button is an exception...');
                            continue findButton;
                        }
                    }
                }

                return {
                    element: buttonFound,
                    id: submitButtons[i]
                }
            }
            else if(wideBundle.formInfo.id == "page builder"){ //Button in the whole page but it's a page builder
                buttonFound = document.querySelector(submitButtons[i]);
                if(buttonFound && buttonFound.parentNode){
                    closestForm = getClosestParentForm(buttonFound);
                    if(buttonFound.hasAttribute('data-replo-repeated-index')){ //For Replo
                        return {
                            element: buttonFound,
                            id: submitButtons[i]
                        }
                    }
                    else if(closestForm && isDescendant(closestForm, document.querySelector('#new-form'))){ //Check if WB is inside this form
                        return {
                            element: buttonFound,
                            id: submitButtons[i]
                        }
                    }
                }
            }
        }
        return null;
    }
    return null;
}

//Function to get the variants selector
wideBundle.getVariantsSelector = function(specificFormToUse = ""){

    if(specificFormToUse == ""){
      var formWB = wideBundle.formInfo.element ? wideBundle.formInfo.element : wideBundle.manualWidget;
    }
    else{
      formWB = specificFormToUse;
    }

    //Selectors for <select> elements
    var selsWB = [
        ".single-option-selector", ".variant__input-product-template:not(input[type=\"radio\"])", ".single-option-selector-product-template", ".single-option-selector__radio.product-form__input", ".shg-product-variant-select",
        ".product-form__single-selector", "gp-product-variants select", ".AddToCartForm .gf_variants", ".product-form__controls-group .product-form__option select", ".option-selectors .selector-wrapper select",
        "select.pf-variant-select", ".product-form__input select.select__select", "div[data-product-options-container] .form-field-select-wrapper .form-field-select", ".variants-ui__input-select.form-field-input.form-field-select",
        ".product-options.grid .js", 'options-selection select', "variant-select select", '.zpa-single-option-selector', '.prd-block_options .prd-block_select select', '.product-page-info__variants select', 'product-variants select',
        '.dynamic-variant-input', '.product-options select', "variant-selector select", "fieldset[data-node-type='add-to-cart-option'] [data-node-type='add-to-cart-option-select']", '.js-product-option-input',
        '.product__variants select', "gp-product-variants select", "variant-selects fieldset select", '.product__option-select-wrapper select', 'select[data-replo-repeated-index][role="listbox"]', 'variant-selects select.field__input'
    ];

    //Selectors for <input> <select> <button> <span> elements
    //You need to add the parent that contains the options with inputs inside (If 3 options like "offer, size and color" then you should have a size of 3 for the parent)
    var fieldsetsWB = [
        ".single-option-radio", ".variant-input-wrap:not(.recommendation-variant-input-wrap)", ".SizeSwatchList", ".input-field.materialize-select", "fieldset.swatch.clearfix", ".swatches-wrapper .swatch", ".swatch_options .swatch",
        ".radios--root", ".Product__OffScreen .Popover__ValueList", ".Popover__ValueList", "#product-variants .swatch", ".selector-wrapper.product-form__item", ".selector-wrapper.js", ".block-swatch-list", ".swatch-container .swatch__container", ".form-options .option-values",
        ".product-block .variant-input-wrap", "variant-radios .product-form__input", ".swatch.clearfix .swatch-inner", ".variant-group .swatch--product", ".product__selectors .radio__fieldset", ".product-options .inline-field-wrapper",
        ".option-selector-fieldset .option-selector__btns", ".swatches_options .product_options", 'fieldset .option-selector__btns', '.product-form .swatch .pr_form_item', '.product-options--swatches .swatches--offer .swatches__options',
        ':not(.product-sticky-form__form) > product-variants combo-box .combo-box__option-list', 'fieldset.product-variant-picker-block', '.body .product-variant-option .swatch.clearfix', '.pf-option-swatches', ':not(.pupsdreams_popup_product-details-info) > variant-picker fieldset .variant-picker__option-values',
        '#bcpo .bcpo-buttons', '.gf_swatches .gf_swatches-selector', '.product-form-grid .option-values', 'options-selection .options-selection__option-values', '.product__swatches .swatches__holder', 'options-selection fieldset.swatch .swatch__options','variant-radios.variant-select fieldset', '.variations fieldset.product-form__input',
        '#product-swatch .swatch-elements-options', 'f-variant-picker [class*="variant-picker__option-values"]', 'x-listbox','.product-loop-variants'
    ];

    //Selectors for <a> <li> <div> elements
    var swatchsWB = [
        ".tt-options-swatch", ".swatches-select", ".pt-options-swatch", ".product-options__section", ".product-options__option", ".selectric-items .selectric-scroll", ".pg__option .pg__option__values",
        ".input-field.product-option-select", ".button-group-hero.w-commerce-commerceaddtocartoptionpillgroup", ".product__selectors .select-popout__list", 'fieldset.select__fieldset .select-popout',
        'div[data-dropdown-wrapper] .t4s-dropdown__content', '.t4s-swatch__list', '.product-details-wrapper .wetheme-dropdown__wrapper ul', '.disclosure--form', 'gp-product-variants(input)'
    ];

    var elementsToTest = [
        {array: swatchsWB, type: 'swatch'},
        {array: fieldsetsWB, type: 'fieldset'},
        {array: selsWB, type: 'select'}
    ]

    for(var x=0; x<elementsToTest.length; x++){
        elementTesting = elementsToTest[x];
        length = elementTesting.array.length;
        for(i=0; i<length; i++){
            testHasChild = elementTesting.array[i].split('(');
            hasChild = "";
            if(testHasChild.length > 1 && !elementTesting.array[i].includes(":not")){
                theElementToUse = testHasChild[0];
                hasChild = testHasChild[1].split(')')[0];
            }
            else{
                theElementToUse = elementTesting.array[i];
            }
            if(formWB){
                nodeElement = formWB.querySelectorAll(theElementToUse);
                if(nodeElement[0] != undefined){
                    if(hasChild == "" || nodeElement[0].querySelector(hasChild)){
                        return {
                            element: nodeElement,
                            id: theElementToUse,
                            type: elementTesting.type,
                            total: nodeElement.length
                        }
                    }
                }
            }
            nodeElement = document.querySelectorAll(theElementToUse);
            if(nodeElement[0] != undefined && !wideBundle.formsException.some(exception => isDescendant(exception, nodeElement[0]))){
                if(hasChild == "" || nodeElement[0].querySelector(hasChild)){
                    return {
                        element: nodeElement,
                        id: theElementToUse,
                        type: elementTesting.type,
                        total: nodeElement.length
                    }
                }
            }
        }
    }

    return null;
}

//Update the prices of the offer
wideBundle.updatePricesInOffer = function(){
    var variantIdSelected = wideBundle.getSelectedVariantId();

    //Get prices for the selected variant
    var price = document.querySelector('.wb_hidden_prices .wb_hidden_price[variant-id="' + variantIdSelected + '"]').innerHTML;
    var compareAtPrice = document.querySelector('.wb_hidden_prices .wb_hidden_compared_price[variant-id="' + variantIdSelected + '"]').innerHTML;
    if(wideBundle.getAmountFromPrice(compareAtPrice) == 0){ //Sometimes because of currency converter it's $0 so we put null immediately
      compareAtPrice = "";
    }
    wideBundle.updateSavingsText(price, compareAtPrice); //Update the saving text of the offer

    for (var y = 0; y < document.querySelectorAll('.selectedWB .price-new-form span.first-price-WB').length; y++) {
        document.querySelectorAll('.selectedWB .price-new-form span.first-price-WB')[y].innerHTML = price;
        handleTranscyPrice(price, document.querySelectorAll('.selectedWB .price-new-form span.first-price-WB')[y]);
        if (document.querySelectorAll('.selectedWB .price-new-form .second-price-WB s')[y]) {
            document.querySelectorAll('.selectedWB .price-new-form .second-price-WB s')[y].innerHTML = compareAtPrice;
        }
        else {
            document.querySelectorAll('.selectedWB .price-new-form .second-price-WB')[y].innerHTML = compareAtPrice;
        }
        handleTranscyPrice(compareAtPrice, document.querySelectorAll('.selectedWB .price-new-form .second-price-WB')[y]);
    }
    wideBundle.updateMainPrice(); //Update price below title
}

wideBundle.updateDiagonalOffer = function(){
    var diagonals = document.querySelectorAll('.diagonal-offer');
    for (let i = 0; i < diagonals.length; i++) {
        diagonals[i].style.height = 'auto';
        if (diagonals[i].scrollHeight > diagonals[i].clientHeight && wideBundle.settings.design_code !== '5') {
            diagonals[i].style.height = diagonals[i].scrollHeight + 'px'
        }
    } 
} 
//Handle Transcy Price when prices are different from an offer to another we have to update property data-tc-price
function handleTranscyPrice(price, element){
    if(element && element.hasAttribute('data-tc-price')){
        element.setAttribute('data-tc-price', price);
    }
}

//Update the prices in savings text
wideBundle.updateSavingsText = function(price, compareAtPrice){
    if(compareAtPrice != '' && wideBundle.settings.economic_display == 1){
        var priceDifference = getAmountDifference(price, compareAtPrice)
        priceDifferenceFormatted = wideBundle.updatePriceSeparator(wideBundle.removeDecimal(wideBundle.getCurrentCurrencyOnly(price).replace('{{amount}}', priceDifference.amount)));

        for(var i = 0; i < document.querySelectorAll('.selectedWB .percent-wb').length; i++){
            document.querySelectorAll('.selectedWB .percent-wb')[i].innerHTML = priceDifference.percent;
        }
        for(var i = 0; i < document.querySelectorAll('.selectedWB .span-economic-wb').length; i++){
            document.querySelectorAll('.selectedWB .span-economic-wb')[i].innerHTML = priceDifferenceFormatted;
            handleTranscyPrice(priceDifferenceFormatted, document.querySelectorAll('.selectedWB .span-economic-wb')[i]);
        }
    }
}

//Get selected variant id
wideBundle.getSelectedVariantId = function(){
    var offerSelected = wideBundle.getSelectedOffer();
    var variants = offerSelected.variants;
    var selectedOptions = wideBundle.getSelectedVariants();

    //If we don't have any options in this offer
    if(selectedOptions.option2.length == 0){
        return document.querySelector('.selectedWB').getAttribute('data-id'); //Return the attribute data-id of the selected offer
    }

    //Associate the option 3 with the option 2 in the selected options
    var combinedSelectedOptions = [];
    for(var i = 0; i < selectedOptions.option2.length; i++){
        if(selectedOptions.option3.length > 0){ //If we have option 3
            combinedSelectedOptions.push(selectedOptions.option2[i].toLowerCase().trim() + ' / ' + selectedOptions.option3[i].toLowerCase().trim());
        }
        else{
            combinedSelectedOptions.push(selectedOptions.option2[i].toLowerCase().trim());
        }
    }

    //Associate the option 3 with option 2 in all the variants of the product
    for(var i = 0; i < variants.length; i++){
        var variant = variants[i];
        var option2 = variant.option2.split(',');
        var option3 = variant.option3 != null ? variant.option3.split(',') : [];
        var combinedVariants = [];
        for(var j = 0; j < option2.length; j++){
            if(option3.length > 0){
                combinedVariants.push(option2[j].toLowerCase().trim() + ' / ' + option3[j].toLowerCase().trim());
            }
            else{
                combinedVariants.push(option2[j].toLowerCase().trim());
            }
        }
        if(arraysEqual(combinedVariants, combinedSelectedOptions)){ //If we found the variant selected
            return variant.id;
        }
    }
    return null;
}

//Get offer selected
wideBundle.getSelectedOffer = function(){
    var selectedNode = document.querySelector('#new-form .selectedWB');
    var allNodes = document.querySelectorAll('#new-form .new-form-option');
    var selectedNodeIndex = Array.from(allNodes).indexOf(selectedNode);
    return wideBundle.offers[selectedNodeIndex];
}

//Get offer selected variant
wideBundle.getSelectedVariant = function(){
    var selectedOffer = wideBundle.getSelectedOffer();
    for(var i = 0; i < selectedOffer.variants.length; i++){
        if(selectedOffer.variants[i].id == wideBundle.getSelectedVariantId()){
            return selectedOffer.variants[i];
        }
    }
}

//Get variants values selected
wideBundle.getSelectedVariants = function(){
    var option2 = [];
    var option3 = [];

    document.querySelectorAll('#new-form .selectedWB .select-option-second').forEach(function(select) {
        if(select.selectedIndex > -1){
            var selectedOption = select.options[select.selectedIndex];
            option2.push(selectedOption.value);
        }
    });

    document.querySelectorAll('#new-form .selectedWB .select-option-third').forEach(function(select) {
        if(select.selectedIndex > -1){
            var selectedOption = select.options[select.selectedIndex];
            option3.push(selectedOption.value);
        }
    });

    var options = {
        option1: wideBundle.getSelectedOffer().offer_title,
        option2: option2,
        option3: option3
    };

    return options;
}

//Change the offer selected after we clicked on an offer
wideBundle.changeSelectedOffer = function(){
    var isAlreadySelected = this.classList.contains('selectedWB');
    var dataId = this.getAttribute('data-id');

    if(!isAlreadySelected){ //If we didn't click on an already selected offer
        var selectedOffers = document.querySelectorAll('.selectedWB');
        for(var i = 0; i < selectedOffers.length; i++){ //Remove the selected class
            selectedOffers[i].classList.remove('selectedWB');
            selectedOffers[i].classList.add('selectable');
        }
        var offerToSelect = document.querySelectorAll('.new-form-option[data-id="' + dataId + '"]');
        for(var i = 0; i < offerToSelect.length; i++){ //Add the selected class
            offerToSelect[i].classList.add('selectedWB');
            offerToSelect[i].classList.remove('selectable');
        }
        wideBundle.updateQuantityInputs(1); //Reset all the quantity inputs to 1
        wideBundle.updatePricesInOffer() //Update the prices in the offer
        wideBundle.updateProductForm(); //Update the product form with new selected offer and variants
        wideBundle.updateQuantityDisabled();
        wideBundle.updateDiagonalOffer();
    }
}

//Update variant selected on WideBundle based on variant parameter in url or if an offer was preselected by default
wideBundle.updateVariantSelectedInFormWithConditions = function(){
    hasVariant = new URLSearchParams(window.location.search.toLowerCase()).get('variant');
    hasPreselectedOffer = false;
    for(var i = 0; i<wideBundle.offers.length; i++){
        if(wideBundle.offers[i].preselected == 1){
            hasPreselectedOffer = true;
            break;
        }
    }

    if(hasVariant || hasPreselectedOffer){

        if(document.readyState == "complete"){
            wideBundle.updateProductForm();
        }
        else{
            window.addEventListener('load', function() {
                wideBundle.updateProductForm();
            });
        }
    }
}

//Get the values of the options selected
wideBundle.getOfferValuesForVariant = function(variantId){
    for(var i = 0; i < wideBundle.offers.length; i++){
        var offer = wideBundle.offers[i];
        for(var j = 0; j < offer.variants.length; j++){
            var variant = offer.variants[j];
            if(variant.id == variantId){
                values = {};
                if(variant.option2){
                    values.option1 = variant.option2.split(',');
                }
                else{
                    values.option1 = [];
                }
                if(variant.option3){
                    values.option2 = variant.option3.split(',');
                }
                else{
                    values.option2 = [];
                }
                return values;
            }
        }
    }
    return null;
}

//Update the price under the product Title
wideBundle.updateMainPrice = function(){
    if(wideBundle.settings.update_price == 1){
        exceptionsPrices = [
            ".collection"
        ];

        wideBundle.priceInfo = wideBundle.getPriceNode();
        wideBundle.replaceSelectedPrice();
        var priceContent = document.querySelector('.selectedWB .price-new-form').innerHTML; //Get the price from selected offer
        var price = wideBundle.priceInfo.element;

        formPrice:
        for(var i = 0; i < wideBundle.priceInfo.element.length; i++){
            for(var j=0; j < exceptionsPrices.length; j++){ //Check if the price is not an exception
                var exceptionAll = document.querySelectorAll(exceptionsPrices[j]);
                for(var k=0; k < exceptionAll.length; k++){
                    var exception = exceptionAll[k];
                    if(typeof exception != "undefined" && isDescendant(exception, price[i])){
                        console.log('price is descendant of an exception...');
                        continue formPrice;
                    }
                }
            }
            //price[i].innerHTML = priceContent; //Replace the content of the price under the title --OLD SYSTEM

            const firstPriceElement = price[i].querySelector('.first-price-WB');
            if (firstPriceElement) {
              firstPriceElement.remove();
            }
            const secondPriceElement = price[i].querySelector('.second-price-WB');
            if (secondPriceElement) {
              secondPriceElement.remove();
            }
            for (let y = 0; y < price[i].childNodes.length; y++) {
              const child = price[i].childNodes[y];
              if (child.nodeType === Node.ELEMENT_NODE) {
                child.style.display = 'none';
              } else if (child.nodeType === Node.TEXT_NODE) {
                child.nodeValue = '';
              }
            }
            price[i].innerHTML += priceContent;
            // --NEW SYSTEM

            if(typeof price[i].querySelector('.first-price-WB') !== 'undefined'){
                price[i].querySelector('.first-price-WB').style.color = wideBundle.settings.price_color;
            }
            if(typeof price[i].querySelector('.second-price-WB') !== 'undefined'){
                price[i].querySelector('.second-price-WB').style.color = wideBundle.settings.price_compared_color;
            }
            price[i].style.fontWeight = 'bold';
            if(price.length > 2 || wideBundle.locationWebsite.indexOf(encodeURI('products/')) == -1){
                break;
            }
        }
        for(i=0; i<document.querySelectorAll('.price-wb').length; i++){
            price = document.querySelectorAll('.price-wb')[i]; //Update also our custom prices that can be placed manually
            price.innerHTML = priceContent;
            if(typeof price[i].querySelector('.first-price-WB') !== 'undefined'){
                price[i].querySelector('.first-price-WB').style.color = wideBundle.settings.price_color;
            }
            if(typeof price[i].querySelector('.second-price-WB') !== 'undefined'){
                price[i].querySelector('.second-price-WB').style.color = wideBundle.settings.price_compared_color;
            }
            price[i].style.fontWeight = 'bold';
        }
    }
}

//Get the variants from JSON in the theme
wideBundle.getVariantsFromJson = function(variantId){
    var variantsOfProducts = "";

    var allScripts = document.querySelectorAll('script, [data-product], [id*="json"], [id*="Json"], [data-variant-json]');
    outerLoop: for(var i=0; i<allScripts.length; i++){
        var script = allScripts[i];
        if(isJsonString(script.innerHTML)){ //Check if script is json and if it contains the variants
            jsonParseScript = JSON.parse(script.innerHTML);
            if(jsonParseScript != null && typeof jsonParseScript.id != "undefined" && typeof jsonParseScript.variants != "undefined"){
                if(typeof jsonParseScript.handle != "undefined" && jsonParseScript.handle != null && typeof wideBundle.currentHandle != "undefined"){
                    if(jsonParseScript.handle == wideBundle.currentHandle){
                        variantsOfProducts = jsonParseScript.variants;
                        break;
                    }
                }
                else{
                    variantsOfProducts = jsonParseScript.variants;
                    break;
                }
            }
            else if(jsonParseScript != null && typeof jsonParseScript[0] != "undefined" && typeof jsonParseScript[0]["option1"] != "undefined"){
                for(var y=0; y<jsonParseScript.length; y++){
                    if(jsonParseScript[y].id == variantId){
                        variantsOfProducts = jsonParseScript;
                        break outerLoop;
                    }
                }
            }
            else if(jsonParseScript != null && typeof jsonParseScript[variantId] != "undefined"){
                if(typeof jsonParseScript[variantId] != "string" && jsonParseScript[variantId] != "null"){ //Weird bug where this jsonParseScript exists but inside we have the word "in" for each
                    variantsOfProducts = [];
                    variantsOfProducts.push(jsonParseScript[variantId]);
                    break;
                }
            }
            else if(jsonParseScript != null && typeof jsonParseScript.product != "undefined" && jsonParseScript.product.id != "undefined" && typeof jsonParseScript.product.variants != "undefined"){
                variantsOfProducts = jsonParseScript.product.variants;
                break;
            }
        }
        else if(script.getAttribute('data-product') != null && isJsonString(script.getAttribute('data-product'))){
            jsonParseScript = JSON.parse(script.getAttribute('data-product'));
            if(jsonParseScript != null && typeof jsonParseScript.id != "undefined" && typeof jsonParseScript.variants != "undefined"){
                variantsOfProducts = jsonParseScript.variants;
                break;
            }
        }
    }

    if(variantsOfProducts == ""){
        if(typeof ProductJSON != "undefined" && ProductJSON.id && ProductJSON.variants){
            variantsOfProducts = ProductJSON.variants;
        }
    }

    return variantsOfProducts;
}

//For customer support to get infos about the page
getInfosWB = function(){
    wideBundle.hideOrShowProductForm('show');
    console.log("%cStore Link:%c " + Shopify.shop, 'font-weight: bold;', 'font-weight: normal;');
    console.log("%cStore Theme:%c " + Shopify.theme.name, 'font-weight: bold;', 'font-weight: normal;');
    console.log("%cCurrency Selected:%c " + Shopify.currency.active + " %c& rate:%c " + Shopify.currency.rate, 'font-weight: bold;', 'font-weight: normal;', 'font-weight: bold;', 'font-weight: normal;');

    if(document.querySelector('div[data-pf-type="Body"]') && document.querySelector('div[data-pf-type="Layout"]')){
        console.log('The user is using PageFly');
        if(wideBundle.formInfo.id != "page builder"){
            console.log("%cPROBLEM: The user didn't use WideBundle Module from PageFly.", "color: red;");
        }
        else{
            console.log("%cThe user is using the WideBundle Module from PageFly.", "color: green;");
        }
    }
    else if(document.querySelector('div[data-label="Row"][data-key="row"]') && document.querySelector('html.gemapp')){
        console.log('The user is using Gempages');
        if(wideBundle.formInfo.id != "page builder"){
            console.log("%cPROBLEM: The user didn't use WideBundle Module from GemPages", "color: red;");
        }
        else{
            console.log("%cThe user is using the WideBundle Module from GemPages", "color: green;");
        }
    }
    else if(wideBundle.formInfo.id == "page builder"){
        console.log('The user is using a page builder');
    }
    else{
        console.log('The user is using a normal theme');
    }
    if(!wideBundle.getVariantsSelector()){
        console.log("%cPROBLEM: The variants selector doesn't exist or WideBundle didn't find it", "color: red;");
    }
    else{
        console.log("%cThe variants selector has been found", "color: green;");
        if(typeof wideBundle.formInfo.element != "undefined" && wideBundle.formInfo.element){
            if(wideBundle.formInfo.element.querySelector('div[data-combined="true"][data-pf-type="ProductVariantSwatches"]') != null){
                console.log("%cThe user is probably using the first variants selector from PageFly that doesn't work", "color: red;");
            }
        }
    }
    if(!wideBundle.getAddToCartButton()){
        console.log("%cPROBLEM: The Add to cart button doesn't exist or WideBundle didn't find it", "color: red;");
    }
    else{
        console.log("%cThe Add to cart button has been found", "color: green;");
    }
    if(wideBundle.settings.link_choice == "form"){
        console.log("WideBundle is configured to open the side cart");
    }
    else if(wideBundle.settings.link_choice == "cart"){
        console.log("WideBundle is configured to open the cart page");
    }
    else{
        console.log("WideBundle is configured to open the checkout");
    }
}

//Run Weglot translation
wideBundle.runTranslationApps = function(){
  if (typeof Weglot !== 'undefined') {
      if (Weglot.initialize && Weglot.options.dynamics) {
          Weglot.options.dynamics.push({ value: "#new-form" }, { value: ".new-wb-form" });
      } else {
          Weglot.initialize( {
              api_key: Weglot.options.api_key,
              dynamic: "#new-form, .new-wb-form"
          });
      }
  }
}

//Create an error on the widget
wideBundle.createError = function(message, link = null){
    var elementsToRemove = document.getElementsByClassName('widebundle_error'); // Remove current errors
    for (var i = elementsToRemove.length - 1; i >= 0; i--) {
      elementsToRemove[i].parentNode.removeChild(elementsToRemove[i]);
    }
  
    for(var i = 0 ; i <wideBundle.widgetContainers.length; i++){ //Add the error in every container
      var container = wideBundle.widgetContainers[i];
      var newError = document.createElement('p');
      var svg = `<svg xmlns="http://www.w3.org/2000/svg" height="15" width="15" viewBox="0 0 1000 1000" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#cc0000">
      <metadata>IcoFont Icons</metadata>
      <title>warning-alt</title>
      <glyph glyph-name="warning-alt" unicode="&#xf025;" horiz-adv-x="1000" />
      <path d="M500 62.5c-241.5 0-437.5 196-437.5 437.5s196 437.5 437.5 437.5c241.79999999999995 0 437.5-196 437.5-437.5s-195.70000000000005-437.5-437.5-437.5z m65.5 644.9c0 36.700000000000045-27.100000000000023 65.5-65.5 65.5s-65.10000000000002-28.699999999999932-65.10000000000002-65.5v-1.6999999999999318c0-36.700000000000045 26.700000000000045-65.10000000000002 65.10000000000002-65.10000000000002 38.39999999999998 0 65.5 28.399999999999977 65.5 65.10000000000002v1.6999999999999318z m-30.100000000000023-151.29999999999995c-2.2999999999999545 20.699999999999932-16 33.69999999999993-35.39999999999998 33.69999999999993-19 0-33.10000000000002-13-35.39999999999998-33.69999999999993l-33.10000000000002-288.90000000000003c-2-22.399999999999977 10-40.099999999999994 30.69999999999999-40.099999999999994h75.50000000000006c20.699999999999932 0 33.09999999999991 17.700000000000017 30.699999999999932 40.099999999999994l-33 288.90000000000003z"/>
      </svg>`;
      if(link){
        newError.innerHTML += svg + " " + message + ` <a target='_blank' href='${link}'>Click here for the tutorial</a>`;
      }
      else{
        newError.innerHTML += svg + " " + message;
      }
      newError.className = "widebundle_error";
      container.append(newError);
      (function(newError) {
        setTimeout(function() {
            newError.classList.add('visible');
        }, 50);
      })(newError);
    }
}

wideBundle.mergeSwatch = function(radio) {
    let select = document.querySelector('.selectedWB #swatch-' + radio.dataset.variantid + '-select-' + radio.dataset.swatchid + '-' + radio.dataset.dropdownid);
    select.value = radio.value;

    let radios = document.querySelectorAll(".selectedWB .swatch-" + radio.dataset.variantid + "-radio-" + radio.dataset.dropdownid + "[value='" + radio.value + "']");
    radios.forEach(function(element) {
        if(element !== radio) {
            element.checked = true;
        }
    });

    var event = new Event('change');
    select.dispatchEvent(event);
}

wideBundle.simplifyColor = function(color) {
    return color.split('(').find(Boolean).trim().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(":", "")
        .replace("\\", "")
        .replace("/", "")
        .replace(":", "")
        .replace("*", "")
        .replace("?", "")
        .replace("\"", "")
        .replace("<", "")
        .replace(">", "")
        .replace("|", "")
        .replace(" ", "")
        .replace("-", "")
        .replace("_", "");
}

//Function to update the product form
wideBundle.updateProductForm = function(){
    const selectedVariantId = wideBundle.getSelectedVariantId();
    var variantToSelect = wideBundle.getVariantToSelectFromDb(selectedVariantId);
    wideBundle.variantsSelector = wideBundle.getVariantsSelector(); //Get the variants selector with type + ID

    for(var j=0; j<wideBundle.widgetContainers.length; j++){ //We will update the form for each container if the main or secondary widget has a form and variants selector
      var widebundleContainer = wideBundle.widgetContainers[j];
      isMainForm = widebundleContainer.id == "new-form" ? 1 : 0; //Test if it's the main widget or the secondary one

      var parentForm = getClosestParentForm(widebundleContainer); //if the container has a form as parent (it means usually they are on page builder)
      variantsSelectorToUpdate = parentForm
        ? wideBundle.getVariantsSelector(parentForm) // We get the variants selector close to the widget (whether it's the main or secondary)
        : wideBundle.variantsSelector; // Otherwise we get the variants selector on the page without worrying about the form

      if(parentForm || isMainForm){ //If we found a form as a parent (page builder) or if it's the main widget we run that system

        if(!variantsSelectorToUpdate && isMainForm){
          console.error("WideBundle didn't find the variants selector on the page");
          return;
        }
        var numberOfOptions = (variantToSelect.option3 != null) ? 3 : (variantToSelect.option2 != null) ? 2 : 1;

        for(var i = 0; i<numberOfOptions; i++){ //For each option
            var optionNumber = i+1; //Option we are currently checking (option 1, option 2 or option 3)
            var valuesToTest = [ //Values we will test to select the right variant
                variantToSelect[`option${optionNumber}`].toLowerCase(), //Value from the database
                selectedVariantId, //Variant ID
                wideBundle.getVariantToSelectFromJson(selectedVariantId)[`option${optionNumber}`]?.toLowerCase() ?? '', //Value from the JSON
                wideBundle.getVariantToSelectFromOffer().toLowerCase() //Value from the offer widget
            ];
            if(variantsSelectorToUpdate.type == "fieldset" && variantsSelectorToUpdate.element.length > 0){ //If we have a fieldset
                console.log("fieldsets");
                var element = variantsSelectorToUpdate.element[i];
                console.log(element);
                if(!element && isMainForm){
                  console.error("WideBundle tried to update the variants selector but didn't find them all (Maybe the store uses swatch colors OR use a single variants selector that contains all the variants)");
                  break;
                }
                if (element.querySelector('select')) { //If fieldsets are <select>
                    console.log("fieldsets selects");
                    wideBundle.updateSelect(element.querySelector('select'), valuesToTest);
                } else if (element.querySelector('button')) { //If fieldsets are <button>
                    console.log("fieldsets buttons");
                    wideBundle.updateButton(element, valuesToTest);
                } else if (element.querySelector('input')) { //If fieldsets are <input>
                    console.log("fieldsets inputs");
                    wideBundle.updateInput(element, valuesToTest);
                } else if (element.querySelector('span')) { //If fieldsets are <span>
                    console.log("fieldsets are spans");
                    wideBundle.updateSpan(element, valuesToTest);
                }
            }
            else if(variantsSelectorToUpdate.type == "swatch" && variantsSelectorToUpdate.element.length > 0){ //If we have a swatch
                console.log("swatchs");
                var element = variantsSelectorToUpdate.element[i];
                console.log(element);
                if(!element && isMainForm){
                  console.error("WideBundle tried to update the variants selector but didn't find them all (Maybe the store uses swatch colors OR use a single variants selector that contains all the variants)");
                  break;
                }
                const divElements = [
                    ".product-options__value", ".product-option-item", ".button-hero.w-commerce-commerceaddtocartoptionpill",
                    ".t4s-swatch__item", '.disclosure--option-link', ".option-item div"
                ];
                if (element.querySelector('a')) { //If swatchs are <a>
                    console.log("swatchs a");
                    wideBundle.updateA(element, valuesToTest);
                } else if (element.querySelector('li')) { //If swatchs are <li>
                    console.log("swatchs li");
                    wideBundle.updateLi(element, valuesToTest);
                } else if(element.querySelector('select')){ //If swatchs are <selects>
                    console.log("swatchs select");
                    wideBundle.updateSelect(element.querySelector('select'), valuesToTest);
                }
                for(var j = 0; j<divElements.length; j++){ //Testing the divs if we have to update divs
                    if(element.querySelector(divElements[j])){
                        console.log("swatchs div");
                        wideBundle.updateDiv(element, valuesToTest, divElements[j]);
                        break;
                    }
                }
            }
            else if(variantsSelectorToUpdate.type == "select" && WideBundle didn't find the variants selector on the page".element.length > 0){ //If we have a select
                console.log("selects");
                var element = variantsSelectorToUpdate.element[i];
                console.log(element);
                if(!element){
                  console.error("WideBundle tried to update the variants selector but didn't find them all (Maybe the store uses swatch colors OR use a single variants selector that contains all the variants)");
                  break;
                }
                wideBundle.updateSelect(element, valuesToTest);
            }

            wideBundle.variantsSelector = wideBundle.getVariantsSelector(); //For form that regenerates the variants selector
            variantsSelectorToUpdate = parentForm
            ? wideBundle.getVariantsSelector(parentForm) 
            : wideBundle.variantsSelector;
            
        }

        wideBundle.fireAllChangeEvent();
      }
    }
}

//Function to get the variant we need to select in the product form based on selected offer in WideBundle
wideBundle.getVariantToSelectFromDb = function(variantId){
    var offerSelected = wideBundle.getSelectedOffer();
    for(var i = 0; i<offerSelected.variants.length; i++){
        var variant = offerSelected.variants[i];
        if(variant.id == variantId){
            return variant;
        }
    }
}

//Function to get variant option values from JSON
wideBundle.getVariantToSelectFromJson = function(variantId) { // IMPORTANT: Can also get from the select name id
    const variantsOfProducts = wideBundle.getVariantsFromJson(variantId);
    if (variantsOfProducts == "") {
      return {option1: null, option2: null, option3: null};
    }
    for (const variant of variantsOfProducts) {
        if (variant.id == variantId) {
            if (typeof variant.option1 != "undefined") {
                return {option1: variant.option1, option2: variant.option2, option3: variant.option3};
            } else if (typeof variant.public_title != "undefined") {
                const values = variant.public_title.split("/");
                const options = {option1: values[0].trim(), option2: null, option3: null};
                if (values.length > 1) {
                    options.option2 = values[1].trim();
                }
                if (values.length > 2) {
                    options.option3 = values[2].trim();
                }
                return options;
            }
        }
    }
    return {option1: null, option2: null, option3: null};
}

//Function to get offer name from the offer widget - We only get offer name for the moment but we might need to
wideBundle.getVariantToSelectFromOffer = function() {
    offerName = document.querySelector('#new-form .selectedWB .title-variant').innerText;
    if(!offerName){
      return null;
    }

    return offerName.toLowerCase();
}

//Function to update a <select> value
wideBundle.updateSelect = function(element, valuesToTest) {
    if(typeof element == "undefined"){ return; };

    const options = element.options;
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < options.length; i++) {
            if (options[i].value.toLowerCase() == valueToTest || options[i].innerText.toLowerCase() == valueToTest) {
                options[i].selected = true;
                fireChangeEvent(element);

                //For Replo Page Builder
                if(element.hasAttribute('data-replo-repeated-index')){
                    if ('createEvent' in document) {
                        var evt = document.createEvent('HTMLEvents');
                        evt.initEvent('change', true, true);
                        element.dispatchEvent(evt);
                    } else {
                        element.fireEvent('onchange');
                    }
                }

                return;
            }
        }
    }
}

//Function to click on <button> to select variants
wideBundle.updateButton = function(element, valuesToTest) {
    var buttons = element.querySelectorAll('.Popover__Value'); //Get buttons to click on
    if(buttons.length == 0){
        buttons = element.querySelectorAll('.combo-box__option-item');
    }
    if(buttons.length == 0){
        buttons = element.querySelectorAll('.popover-listbox__option');
    }

    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < buttons.length; i++) {
            if (buttons[i].innerHTML.toLowerCase() == valueToTest || buttons[i].value.toLowerCase() == valueToTest) {
                buttons[i].disabled = false; //Enable buttons for some themes with troubles
                buttons[i].click();
                buttons[i].click(); // Double click for some themes with troubles
                return;
            }
        }
    }
}

//Function to change selected <input>
wideBundle.updateInput = function(element, valuesToTest) {
    console.log("updating the inputs");
    inputs = element.querySelectorAll('input');
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].value.toLowerCase() == valueToTest ||
                (inputs[i].hasAttribute('data-value') && inputs[i].getAttribute('data-value').toLowerCase() == encodeURI(valueToTest))) {
                    inputs[i].disabled = false; //Enable inputs for some themes with troubles
                    inputs[i].click();
                    inputs[i].click(); // Double click for some themes with troubles
                    if(wideBundle.variantsSelector.id == ".product-options--swatches .swatches--offer .swatches__options"){
                        fireChangeEvent(inputs[i]);
                    }
                    return;
            }
        }
    }
}

//Function to change selected <span>
wideBundle.updateSpan = function(element, valuesToTest) {
    console.log("updating the spans");
    spans = element.querySelectorAll('span');
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < spans.length; i++) {
            if (spans[i].hasAttribute("data-value") && spans[i].getAttribute("data-value").toLowerCase() == valueToTest) {
                spans[i].click();
                spans[i].click(); // Double click for some themes with troubles
                return;
            }
            else if(spans[i].hasAttribute("data-swatch-option") && spans[i].getAttribute("data-swatch-option").toLowerCase() == valueToTest
                    && !spans[i].classList.contains('swatch--active')){
              spans[i].click();
              return;
            }
        }
    }
}

//Function to change selected <a>
wideBundle.updateA = function(element, valuesToTest) {
    console.log("updating the a");
    as = element.querySelectorAll('a');
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < as.length; i++) {
            if ((as[i].hasAttribute("data-value") && as[i].getAttribute("data-value").toLowerCase() == valueToTest) ||
                as[i].innerText.toLowerCase() == valueToTest) {
                if(wideBundle.variantsSelector.id != ".product__selectors .select-popout__list" &&
                    wideBundle.variantsSelector.id != "fieldset.select__fieldset .select-popout"){
                        as[i].href = 'javascript:void(0);';
                }
                as[i].click();
                as[i].click(); // Double click for some themes with troubles
                return;
            }
        }
    }
}

//Function to change selected <li>
wideBundle.updateLi = function(element, valuesToTest) {
    console.log("updating the li");
    lis = element.querySelectorAll('li');
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < lis.length; i++) {
            if ((lis[i].hasAttribute("data-escape") && lis[i].getAttribute("data-escape").toLowerCase() == valueToTest) ||
                lis[i].innerText.toLowerCase() == valueToTest ||
                (lis[i].hasAttribute("value") && lis[i].getAttribute("value").toLowerCase() == valueToTest) ||
                (lis[i].hasAttribute("data-value") && lis[i].getAttribute("data-value").toLowerCase() == valueToTest)) {
                    lis[i].click();
                    lis[i].click(); // Double click for some themes with troubles
                    triggerMouseEvent(lis[i], "mousedown");
                    return;
            }
        }
    }
}

//Function change selected <div>
wideBundle.updateDiv = function(element, valuesToTest, divElement) {
    console.log("updating the div");
    divs = element.querySelectorAll(divElement);
    for (const valueToTest of valuesToTest) {
        for (let i = 0; i < divs.length; i++) {
            if (divs[i].innerHTML.toLowerCase().trim() == valueToTest.replace(/&/g, "&amp;").trim()) {
                divs[i].click();
                divs[i].click(); // Double click for some themes with troubles
                dispatchClick(divs[i]);
                return;
            }
            else if (divs[i].innerText.toLowerCase().trim() == valueToTest.replace(/&/g, "&amp;").trim()) {
                divs[i].click();
                divs[i].click(); // Double click for some themes with troubles
                dispatchClick(divs[i]);
                return;
            }
        }
    }
}

//Send change event to trigger functions on the theme
wideBundle.fireAllChangeEvent = function(){

    //Elements to trigger change event with vanilla JS
    var elementsToTrigger = ["variant-selects", 'div[data-pf-type="ProductVariantSwatches"]'];

    //Elements to trigger all children with vanilla JS
    var elementsToTriggerAll = ["variant-select", "variant-picker", "product-variants", "variant-selector"];

    //Elements to trigger all in bubble with vanilla JS
    var elementsToTriggerAllBubble = [".product-block-list__item.product-block-list__item--info .product-form__single-selector:checked", ".shopify-product-form .product-options .product-option-list",
    ".product__variants--select .styled-select select.option-selector",".single-option-selector"];

    //Elements to trigger change event with jQuery
    var elementsToTriggerJquery = ["#SingleOptionSelector-0", ".option-selectors .selector-wrapper select"];

    //Elements to trigger with timeout
    var elementsToTriggerTimeout = ["main#mainWrap #productHead #prodForm .form-select-wrapper .single-option-selector",
    "#ProductSection-product-template #add-to-cart-form #product-variants select"]

    //Trigger Vanilla JS
    for (const elementToTrigger of elementsToTrigger) {
        var element = document.querySelector(elementToTrigger);
        if(element){
            if('createEvent' in document){
                var evt = document.createEvent('HTMLEvents');
                evt.initEvent('change', false, true);
                element.dispatchEvent(evt);
            }
            else{
                element.fireEvent('onchange');
            }
        }
    }

    //Trigger Vanilla JS for all children
    for (const elementToTriggerAll of elementsToTriggerAll) {
        var element = document.querySelectorAll(elementToTriggerAll);
        for(var i = 0; i<element.length; i++){
            if('createEvent' in document){
                var evt = document.createEvent('HTMLEvents');
                evt.initEvent('change', false, true);
                element[i].dispatchEvent(evt);
            }
            else{
                element[i].fireEvent('onchange');
            }
        }
    }

    //Trigger Vanilla JS for all children with bubble true
    for (const elementToTriggerAllBubble of elementsToTriggerAllBubble) {
        var element = document.querySelectorAll(elementToTriggerAllBubble);
        for(var i = 0; i<element.length; i++){
            if('createEvent' in document){
                var evt = document.createEvent('HTMLEvents');
                evt.initEvent('change', true, true);
                element[i].dispatchEvent(evt);
            }
            else{
                element[i].fireEvent('onchange');
            }
        }
    }
    

    //Trigger Jquery
    if(typeof $ != "undefined"){
        for (const elementToTriggerJquery of elementsToTriggerJquery) {
            if(document.querySelector(elementToTriggerJquery)){
                $(elementToTriggerJquery).trigger("change");
            }
        }
    }

    //Triger timeout
    for (const elementToTriggerTimeout of elementsToTriggerTimeout) {
        var element = document.querySelector(elementToTriggerTimeout);
        if(element){
            if('createEvent' in document){
                var evt = document.createEvent('HTMLEvents');
                evt.initEvent('change', false, true);
                element.dispatchEvent(evt);
            }
            else{
                element.fireEvent('onchange');
            }
        }
    }

    //Manage Afterpay
    if(typeof wideBundle.variantsSelector.id != "undefined" &&
        wideBundle.variantsSelector.id == ".selector-wrapper.product-form__item" &&
        typeof Afterpay != "undefined"){
            setTimeout(function() {
                if(document.querySelector('.selector-wrapper.product-form__item') != null)
                eventFire(document.querySelector('.selector-wrapper.product-form__item'), "change");
            }, 300);
      }

    //Manage EcomSolid changing variants
    productJsonNode = document.querySelector('.ProductJson');
    if(productJsonNode){
        isGemPages = wideBundle.formInfo.element.closest('[class^=\'gt_section-\'][data-name], [class^=\'gf_section-\'][data-name], [class^=\'gt_widget-\'][data-name], [class^=\'gt_element-\'][data-name]');
        if(isGemPages){
            productJson = JSON.parse(productJsonNode.innerHTML);
            variantJson = productJson.variants;
            idSelected = wideBundle.getSelectedVariantId();
            for(var i = 0; i < variantJson.length; i++){
                if(variantJson[i].id == idSelected){
                    variantObject = variantJson[i];
                    console.log(variantObject);
                    break;
                }
            }
            window.SOLID.store.dispatch("variant" + productJson.id, variantObject);
        }
    }
};

//Update the price decimal separator
wideBundle.updatePriceSeparator = function(price){
    return price.replace('.', wideBundle.settings.price_separator);
}

//Remove the decimal if it's enabled and if there is no decimal
wideBundle.removeDecimal = function(price){
    if(wideBundle.settings.no_decimal == 1){
        if(price != ''){
            price = price.replace(",", ".");
            var regp = /(\.0?)0(?![1-9])/;
            price = price.replace(regp, '');
            price = wideBundle.updatePriceSeparator(price);
            return price;
        }
        else{
            return price;
        }
    }
    else{
        return price;
    }
}

//Create the price format with currency and price
wideBundle.formatPrice = function(price){
    if(price){
        return wideBundle.settings.currency.replace('{{amount}}', price).trim();
    }
    else{
        return "";
    }
}

//The user can update the price with Shopify Market so we first check if we can get prices from the theme
wideBundle.getPricesFromJson = function(variantId){

    var variantsOfProducts = wideBundle.getVariantsFromJson(variantId);

    if(variantsOfProducts != ""){
        for(var i=0; i<variantsOfProducts.length; i++){
            var variant = variantsOfProducts[i];
            if(variant.id == variantId){
                if(typeof variant.price_raw != "undefined"){
                    prices = [];
                    prices['price'] = wideBundle.formatPriceFromJson(variant.price_raw);
                    if(variant.sale_raw != false){
                        prices['compare_at_price'] = wideBundle.formatPriceFromJson(variant.sale_raw);
                    }
                    else{
                        prices['compare_at_price'] = "";
                    }
                    return prices;
                }
                else if(typeof variant.price != "undefined"){
                    prices = [];
                    if(containsOnlyNumbers(variant.price)){
                        prices['price'] = wideBundle.formatPriceFromJson(variant.price);
                        prices['compare_at_price'] = (variant.compare_at_price || variant.compareAtPrice) ? wideBundle.formatPriceFromJson(variant.compare_at_price || variant.compareAtPrice) : "";
                    }
                    else{
                      prices['price'] = wideBundle.getAmountFromPrice(variant.price).replace(",", "."); //Get only the amount from a price and replace decimal separator
                      prices['price'] = parseFloat(prices['price']).toFixed(2); //Transform the text into a number and fixed it to float 2
                      prices['price'] = wideBundle.replaceCurrencyForMarket(wideBundle.formatPrice(prices['price'])); //Format the number as a price and replace currency for Shopify Market

                      prices['compare_at_price'] = (variant.compare_at_price || variant.compareAtPrice) ? variant.compare_at_price || variant.compareAtPrice : "";
                      if(prices['compare_at_price']){
                        prices['compare_at_price'] = wideBundle.getAmountFromPrice(prices['compare_at_price']).replace(",", "."); //Get only the amount from a price and replace decimal separator
                        prices['compare_at_price'] = parseFloat(prices['compare_at_price']).toFixed(2); //Transform the text into a number and fixed it to float 2
                        prices['compare_at_price'] = wideBundle.replaceCurrencyForMarket(wideBundle.formatPrice(prices['compare_at_price'])); //Format the number as a price and replace currency for Shopify Market
                      }
                    }

                    return prices;
                }
            }
        }
        return null;
      }
      else{
        return null;
      }
}

//If we find prices in JSON we have to format them but they are like this: 2600 instead of 26.00
wideBundle.formatPriceFromJson = function(price){
    var priceFormat = parseFloat(price) / 100;
    priceFormat = priceFormat.toFixed(2);
    priceFormat = wideBundle.formatPrice(priceFormat);
    priceFormat = wideBundle.replaceCurrencyForMarket(priceFormat); //Replace the currency if another one is selected than default
    return priceFormat;
}

wideBundle.formatPriceForUnit = function(price){
  var priceFormat = parseFloat(price);
  priceFormat = priceFormat.toFixed(2);
  priceFormat = wideBundle.formatPrice(priceFormat);
  priceFormat = wideBundle.replaceCurrencyForMarket(priceFormat); //Replace the currency if another one is selected than default
  return priceFormat;
}

// Function to extract the price number in whatever string provided, can handle dots, commas and both
function extractPrice(inputString) {
  const priceRegex = /(?:\$\s?)?([\d,.]+)/;
  const matches = inputString.match(priceRegex);

  if (matches && matches.length > 1) {
    return priceWithCommas = matches[1];
  }
  return null;
}

// Function to detect if there is whitespaces between to substrings in a giving string
function spaceSubstrings(inputString, substring1, substring2) {
  const index1 = inputString.indexOf(substring1);
  const index2 = inputString.indexOf(substring2);

  if (index1 !== -1 && index2 !== -1) {
    const startIndex = Math.min(index1, index2);
    const endIndex = Math.max(index1, index2);

    const spaceBetween = inputString.substring(startIndex + substring1.length, endIndex);
    return /\s/.test(spaceBetween);
  }

  return false;
}

//Function to check and remove duplicated substrings in a string
function removeDuplicate(originalString, substrings) {
  const escapedSubstrings = substrings.map(substring => substring.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));

  const regexString = escapedSubstrings.map(substring => `(${substring})`).join('|');
  const regex = new RegExp(regexString, 'g');

  const uniqueSubstrings = [];
  const result = originalString.replace(regex, (match, ...groups) => {
    const substring = groups.find(group => group !== undefined);
    if (!uniqueSubstrings.includes(substring)) {
      uniqueSubstrings.push(substring);
      return substring;
    }
    return '';
  });

  return result;
}

// Function to remove all texts from a string and keep only the provided substrings
function keepSubstrings(price, ...substrings) {
  priceNew = removeDuplicate(price, substrings); 
  const escapedCurrencySymbols = substrings.map(symbol => symbol.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const regex = new RegExp([...substrings, ...escapedCurrencySymbols].join('|'), 'g');
  const matchedSubstrings = priceNew.match(regex) || [];
  const filteredResult = matchedSubstrings.filter(str => str !== '');

  for(var i=0; i<(filteredResult.length)-1; i++){
    if(spaceSubstrings(priceNew, filteredResult[i], filteredResult[i+1])){
      filteredResult[i] = filteredResult[i] + ' ';
    }
  }

  return filteredResult.join('');
}

// Function to check if a string has a currency code and return it
function extractCurrencyCode(inputString) {
  const currencyCodeRegex = /[A-Z]{3}/;
  const matches = inputString.match(currencyCodeRegex);
  return matches ? matches[0] : null;
}

//If the user uses Market and another currency is selected we have to replace the symbol
wideBundle.replaceCurrencyForMarket = function(price){

    //Exit if the currency is the same as the default
    if(typeof Shopify.currency != "undefined" && Shopify.currency.active == wideBundle.settings.currency_code){
        return price;
    }
    symbols = ["MXN $", "US$", "$", "", "", "kr", "Kr", "CHF", 'USD', 'PLN', 'z'];
    

    symbols.every(symbol => {
        if(price.includes(symbol)){
          rawPrice = extractPrice(price);
          
          if(wideBundle.settings.currency_format === 'symbol'){
            price = keepSubstrings(price, rawPrice, symbol)
            price = price.replace(symbol, wideBundle.currencySymbols[Shopify.currency.active])
          }
          else if(wideBundle.settings.currency_format === 'both'){
            currencyCode = extractCurrencyCode(price);
            if(currencyCode == null){
              price = keepSubstrings(price, rawPrice, symbol)
              price = price.replace(symbol, wideBundle.currencySymbols[Shopify.currency.active]) + ' ' + Shopify.currency.active;
            }
            else{
              price = keepSubstrings(price, rawPrice, symbol, currencyCode)
              price = price.replace(symbol, wideBundle.currencySymbols[Shopify.currency.active]);
              price = price.replace(currencyCode, Shopify.currency.active);
            }
          }
          else {
            price = keepSubstrings(price, rawPrice, symbol)
            price = price.replace(symbol, wideBundle.currencyCodes[Shopify.currency.active])
          }

          return false;
        }
        return true;
    });

    return price;
}

//Replace hidden prices with prices from Ajax if we couldn't get them from the theme JSON
wideBundle.addPricesFromAjax = function(){
    if(typeof Shopify != "undefined" && typeof Shopify.currency != "undefined"){
        //Check if we can't get prices from json
        if(!wideBundle.getPricesFromJson(document.querySelector('.wb_hidden_prices .wb_hidden_price').getAttribute('variant-id'))){
          console.log('doing ajax');
          const url = `${window.Shopify.routes.root}products/${wideBundle.currentHandle}.js`;
          fetch(url)
          .then(response => response.json())
          .then(product => {
            console.log(product.variants);
            console.log("PriceJson Script not available");
            product.variants.forEach(variant => { //Format prices we received
              priceStructured = wideBundle.formatPriceFromJson(variant.price);
              priceStructured = wideBundle.updatePriceSeparator(priceStructured.toString());
              if(variant.compare_at_price){
                compareAtPriceStructured = wideBundle.formatPriceFromJson(variant.compare_at_price)
                compareAtPriceStructured = wideBundle.updatePriceSeparator(compareAtPriceStructured.toString());
                compareAtPriceStructured = parseFloat(wideBundle.getAmountFromPrice(priceStructured)) >= parseFloat(wideBundle.getAmountFromPrice(compareAtPriceStructured)) ? "" : compareAtPriceStructured
              }
              else{
                compareAtPriceStructured = "";
              }
              //Replace the prices in hidden prices and after creating the widget we will use them
              document.querySelector('.wb_hidden_prices .wb_hidden_price[variant-id="'+variant.id+'"]').innerHTML = wideBundle.removeDecimal(priceStructured);
              document.querySelector('.wb_hidden_prices .wb_hidden_compared_price[variant-id="'+variant.id+'"]').innerHTML = wideBundle.removeDecimal(compareAtPriceStructured);
            });
            wideBundle.updatePriceOnAllOffers(); //Update the offers with the new prices
          })
          .catch(error => console.error(error));
        }
      }
}

//Remove currency from a price
wideBundle.getAmountFromPrice = function(price) {

  // Count occurrences of dots and commas surrounded by two numbers
  /*var dotsCount = (price.match(/\d\.\d/g) || []).length;
  var commasCount = (price.match(/\d,\d/g) || []).length;

  if (dotsCount > 2 || commasCount > 2 || (dotsCount === 1 && commasCount === 1)) {
      // Remove the first occurrence of dot or comma surrounded by numbers
      price = price.replace(/(\d)([.,])(\d)/, '$1$3');
  }*/

  var regp = /[^0-9.,]*(\d+(?:[.,]\d+)?)(?:[^0-9.,]|$)/;
  match = price.match(regp);
  if (match) {
      return match[1];
  } else {
      return price;
  }
}


//Get only the current currency format
wideBundle.getCurrentCurrencyOnly = function(price){
    if(price != "" && price != null){
        return price.replace(/\d+.\d+/g,'{{amount}}').replace(/\d+/g,'{{amount}}');
    }
}

//Get the difference between two prices
function getAmountDifference(price, compareAtPrice){
    numberForPrice = parseFloat(wideBundle.getAmountFromPrice(price).replace(',', '.')); //Get the amount only for the price
    numberForCompareAtPrice = parseFloat(wideBundle.getAmountFromPrice(compareAtPrice).replace(',', '.')); //compare at price
    var amountDifference = numberForCompareAtPrice - numberForPrice;

    percentDifference = 100 * parseFloat(amountDifference) / numberForCompareAtPrice;
    percentDifference = Math.round(percentDifference);

    amountDifference = amountDifference.toFixed(2); //We round the price so we can have "34.00" or "34.99"

    return {
        "amount": amountDifference,
        "percent": percentDifference
    };
}

//Send observer to change the main price
function observePriceChanges(target) {
  const config = {
    childList: true,
    subtree: true,
    characterData: true,
  };

  const callback = function (mutationsList, observer) {
    if (!window.pricesWB) return;
    for (let mutation of mutationsList) {
      for (let selector of pricesWB) {
        let targetMatch = false;
        let addedMatch = false;
        let removedMatch = false;

        if (mutation.target.matches !== undefined && mutation.target.matches(selector)) {
          targetMatch = true;
        }

        Array.from(mutation.addedNodes).forEach(node => {
          if (node.matches !== undefined && node.matches(selector)) {
            addedMatch = true;
          }
        });

        Array.from(mutation.removedNodes).forEach(node => {
          if (node.matches !== undefined && node.matches(selector)) {
            removedMatch = true;
          }
        });

        if (mutation.target.nodeType != 3 && mutation.target.nodeType != 8) {
          if (mutation.target.querySelector('.first-price-WB') || mutation.target.querySelector('.second-price-WB')) continue;
        }

        if (targetMatch || addedMatch || removedMatch) {
          if (formWB.style.height == '0px' || formWB.style.display === 'none' || wideBundle.manualWidget) {
            wideBundle.updateMainPrice();
          }
        }
      }
    }
  };

  const observer = new MutationObserver(callback);
  observer.observe(target, config);
}
observePriceChanges(document);

wideBundle.updatePriceOnAllOffers = function(){
  offers = document.querySelectorAll('.new-form-option');
  offers.forEach(offer => {
    if(offer.classList.contains('selectedWB')){
      offerID = wideBundle.getSelectedVariantId();
    }
    else{
      offerID = offer.getAttribute('data-id');
    }

    price = offer.querySelector('.first-price-WB');
    compareAtPrice = offer.querySelector('.second-price-WB');
    if(price){
      price.innerHTML = document.querySelector(`.wb_hidden_prices .wb_hidden_price[variant-id="${offerID}"]`).innerHTML;
      handleTranscyPrice(document.querySelector(`.wb_hidden_prices .wb_hidden_price[variant-id="${offerID}"]`).innerHTML, price);
    }
    if(compareAtPrice){
      compareAtPrice.innerHTML = document.querySelector(`.wb_hidden_prices .wb_hidden_compared_price[variant-id="${offerID}"]`).innerHTML;
      handleTranscyPrice(document.querySelector(`.wb_hidden_prices .wb_hidden_compared_price[variant-id="${offerID}"]`).innerHTML, compareAtPrice);
    }

    const priceParent = price.parentNode;
    if(priceParent.classList.contains("hidden-unit")){
      const variantUnitPrice = parseFloat(wideBundle.getAmountFromPrice(price.innerHTML).replace(',', '.')) * priceParent.getAttribute('data_offer_cr');
      priceParent.parentNode.querySelector('.wb_unit_price').innerHTML = (wideBundle.removeDecimal(wideBundle.updatePriceSeparator(wideBundle.formatPriceForUnit(variantUnitPrice))));
    }

    //For "you save" text
    if(compareAtPrice.innerHTML != '' && wideBundle.settings.economic_display == 1){

      percent = offer.querySelector('.percent-wb');
      priceEconomic = offer.querySelector('.span-economic-wb');

      var priceDifference = getAmountDifference(price.innerHTML, compareAtPrice.innerHTML)
      priceDifferenceFormatted = wideBundle.updatePriceSeparator(wideBundle.removeDecimal(wideBundle.getCurrentCurrencyOnly(price.innerHTML).replace('{{amount}}', priceDifference.amount)));

      if(percent){
        percent.innerHTML = priceDifference.percent;
      }
      if(priceEconomic){
        priceEconomic.innerHTML = priceDifferenceFormatted;
      }
    }
    else{
      var savingsText = offer.querySelector('.economic-wb');
      if(savingsText){ //Hide the savings text if we have it
        savingsText.style.display = "none";
      }
    }

  });

  wideBundle.updateMainPrice();
}

//Add the main style of the widget
wideBundle.addMainStyle = function (attribute = '') {
    var mainStyle = `
        #checkout-xx-aa {
            color: white;
            font-size: 1px;
            margin-top: 0px;
            margin-bottom: 0px;
            display: none;
        }
        #new-form *, #new-form::before, #new-form::after {
           box-sizing: border-box;
        }
        #new-form, .new-wb-form {
            max-width: 700px;
            margin: auto;
            position: relative;
        }
        .product--no-media product-form.product-form{
            display: block !important;
        }
        #new-form .jumpstart-selector .arrow{
            display: none !important;
        }
        #new-form .jumpstart-selector select{
            -webkit-appearance: auto;
            appearance: auto;
        }
        .product-detail .product-form.theme-init .option-selectors{
            display: none !important;
        }
        .p-title-WB {
            overflow: hidden;
            position: relative;
	          display: flex;
            text-align: ${wideBundle.settings.preview_heading_position};
            justify-content: center;
        }
        .p-title-WB__content {
            position: relative;
            color: ${wideBundle.settings.preview_heading_color};
            font-size: ${wideBundle.settings.preview_heading_font_size};
            ${wideBundle.settings.preview_heading_font_style == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.preview_heading_font_style == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.preview_heading_font_style == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.preview_heading_font_style == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};

            ${wideBundle.settings.preview_heading_position == 'left' ? 'margin: 0 auto 0 0;' : ''};
            ${wideBundle.settings.preview_heading_position == 'center' ? 'margin: 0 auto;' : ''};
            ${wideBundle.settings.preview_heading_position == 'right' ? 'margin: 0 0 0 auto;' : ''};

            ${wideBundle.settings.preview_heading_position == 'left' && wideBundle.settings.heading_line_display == 1 ? 'padding: 0px 8px 0px 0px;max-width: 90%;' : ''};
            ${wideBundle.settings.preview_heading_position == 'center' && wideBundle.settings.heading_line_display == 1 ? 'padding: 0px 8px 0px 8px;max-width: 90%;' : ''};
            ${wideBundle.settings.preview_heading_position == 'right' && wideBundle.settings.heading_line_display == 1 ? 'padding: 0px 0px 0px 8px;max-width: 90%;' : ''};
        }

        .p-title-WB::before {
          display: ${wideBundle.settings.heading_line_display == 1 && (wideBundle.settings.preview_heading_position == 'center' || wideBundle.settings.preview_heading_position == 'right') ? 'block' : 'none'};
          content: '';
          flex-grow: 1;
          //top: calc(50% - ${wideBundle.settings.heading_line_size} / 2);
          height: ${wideBundle.settings.heading_line_size};
          background-color: ${wideBundle.settings.heading_line_color};
          margin: auto;
        }

        .p-title-WB::after {
          display: ${wideBundle.settings.heading_line_display == 1 && (wideBundle.settings.preview_heading_position == 'left' || wideBundle.settings.preview_heading_position == 'center') ? 'block' : 'none'};
          content: '';
          flex-grow: 1;
          //top: calc(50% - ${wideBundle.settings.heading_line_size} / 2);
          height: ${wideBundle.settings.heading_line_size};
          background-color: ${wideBundle.settings.heading_line_color};
          margin: auto;
        }

        .new-form-option{
            display:flex;
            align-items:center;
            padding: 10px 10px 10px 0px;
            cursor:pointer;
            border-radius:5px;
            margin-bottom:15px;
            border:2px solid #c6c6c6;
            transition: background-color: 0.1s ease, border 0.1 ease;
        }

        .new-form-option .value-left{
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .diagonal-offer{
            --d: 10px;
            position: relative;
            --message: 'special offer';
            ${wideBundle.settings.display_quantity == 1 && wideBundle.settings.design_code !== '1' && wideBundle.settings.design_code !== '5' ? 'padding-right: 40px !important;' : ''};
        }

        .diagonal-offer::before {
            content: var(--message);
            position: absolute;
            font-family: sans-serif;
            font-size: var(--f);
            top: 0;
            right: 0;
            transform: translate(29.29%, -100%) rotate(45deg);
            text-align: center;
            border: 1px solid transparent;
            border-bottom: 0;
            transform-origin: bottom left;
            padding: 5px 35px calc(var(--d) + 5px);
            background: linear-gradient(rgba(0, 0, 0, 0.5) 0 0) bottom/100% var(--d)
                        no-repeat var(--c);
            background-clip: padding-box;
            clip-path: polygon(0 0,100% 0,100% 100%,calc(100% - var(--d)) calc(100% - var(--d)),var(--d) calc(100% - var(--d)),0 100%);
            -webkit-mask: linear-gradient(135deg,transparent calc(50% - var(--d) * 0.707),#fff 0) bottom left,
                        linear-gradient(-135deg, transparent calc(50% - var(--d) * 0.707), #fff 0)bottom right;
            -webkit-mask-size: 300vmax 300vmax;
            -webkit-mask-composite: destination-in, xor;
            mask-composite: intersect;
            max-width: 195px;
            font-size: .9em;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            z-index: 2;
        }

        .corner-offer{
            --f: 14px;
            --r: 20px;
            position: absolute;
            top: -17px;
            padding: .1em .5em;
            background: #FA6900;
            border-bottom: var(--f) solid #0005;
            border-left: var(--r) solid #0000;
            clip-path: polygon(0 0,100% 0,100% calc(100% - var(--f)),calc(100% - var(--f)) 100%,
              calc(100% - var(--f)) calc(100% - var(--f)),0 calc(100% - var(--f)),
              var(--r) calc(50% - var(--f)/2));
            right: calc(-1*var(--f));
            height: 45px;
            display: flex;
            align-items: center;
            z-index: 1;
        }

        .corner-offer-container{
            position: relative;
            padding: 20px 10px 20px 0px !important;
            margin-top: 20px;
        }
        
        .selectable .corner-offer {
            background: ${wideBundle.settings.unselected_message_background_transparency !== '00' ? wideBundle.settings.unselected_message_background_color : wideBundle.settings.border_color};
            color: ${wideBundle.settings.color_best_banner};
            font-family: ${wideBundle.settings.font_unselected_custom_sentence != 'auto' ? wideBundle.settings.font_unselected_custom_sentence + ',' : ''} Arial, sans-serif;
            ${wideBundle.settings.style_blinking == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }

        .selectable.diagonal-offer{
            --c: ${wideBundle.settings.unselected_message_background_transparency !== '00' ? wideBundle.settings.unselected_message_background_color : wideBundle.settings.border_color};
            color: ${wideBundle.settings.color_best_banner};
        }

        .selectable.diagonal-offer::before{
            font-family: ${wideBundle.settings.font_unselected_custom_sentence != 'auto' ? wideBundle.settings.font_unselected_custom_sentence + ',' : ''} Arial, sans-serif;
            ${wideBundle.settings.style_blinking == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        
        .selectedWB .corner-offer {
            background: ${wideBundle.settings.message_background_transparency !== '00' ? wideBundle.settings.message_background_color : wideBundle.settings.border_color};
            color: ${wideBundle.settings.best_selected_color_banner};

            font-family: ${wideBundle.settings.font_selected_custom_sentence != 'auto' ? wideBundle.settings.font_selected_custom_sentence + ',' : ''} Arial, sans-serif;
            ${wideBundle.settings.style_blinking_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }

        .selectedWB.diagonal-offer{
            --c: ${wideBundle.settings.message_background_transparency !== '00' ? wideBundle.settings.message_background_color : wideBundle.settings.border_color};
            color: ${wideBundle.settings.best_selected_color_banner};
        }

        .selectedWB.diagonal-offer::before{
            font-family: ${wideBundle.settings.font_selected_custom_sentence != 'auto' ? wideBundle.settings.font_selected_custom_sentence + ',' : ''} Arial, sans-serif;
            ${wideBundle.settings.style_blinking_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }

        .checkedWB{
            display: block;
            width: 17px;
            height: 17px;
            border: 3px solid #f4f4f4;
            background-color: #f4f4f4;
            border-radius: 50%;
            margin-left: 10px;
            margin-right: 10px;
        }

        .thumbnailWB{
            width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "40px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "60px" : "80px")};
            border: 1px solid ${wideBundle.settings.unselected_thumbnail_color};
            border-radius: 5px;
            margin-right: 10px;
        }

        .selectedWB .thumbnailWB{
            width: ${wideBundle.settings.thumbnail_size == "s" ? "40px" : (wideBundle.settings.thumbnail_size == "m" ? "60px" : "80px")};
            border: 1px solid ${wideBundle.settings.thumbnail_color};
        }

        .value-left{
            min-width: 40px;
        }
        .offer-image{
            min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "88px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "108px" : "128px")};
        }

        .selectedWB .offer-image{
            min-width: ${wideBundle.settings.thumbnail_size == "s" ? "88px" : (wideBundle.settings.thumbnail_size == "m" ? "108px" : "128px")};
        }

        .value-right{
            text-align: left;
        }
        .title-variant{
            font-size: 1.2em;
            text-transform: none;
            text-align: left;
            margin: 0;
            color: ${wideBundle.settings.offer_color};
        }
        .best-title-new{
            font-size: 0.9em;
            line-height: 1;
            color: ${wideBundle.settings.color_best};
            transition: opacity 0.5s ease;
            font-weight: bold;
        }
        .price-new-form{
            text-align: left;
            width: auto;
            margin: 0px;
            margin-bottom: 0px;
        }

        .hidden-unit{
            display: none !important;
        }

        .first-unit-WB {
            margin-right: 5px;
            text-align: left;
            width: auto;
            margin: 0px;
            margin-bottom: 0px;
        }

        .selectedWB .first-unit-WB {
            font-size: ${wideBundle.settings.selected_price_fontsize};
            color: ${wideBundle.settings.price_selected_color} !important;
            ${wideBundle.settings.style_price_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        
        }
        .selectable .first-unit-WB {
            font-size: ${wideBundle.settings.unselected_price_fontsize};
            color: ${wideBundle.settings.price_color} !important;
            ${wideBundle.settings.style_price == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_price == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        
        }

        .wb_unit_text{
            font-size: 0.85em;
        }

        .selectedWB .first-price-WB {
            font-size: ${wideBundle.settings.selected_price_fontsize};
        }
        .selectedWB .second-price-WB {
            font-size: ${wideBundle.settings.selected_compare_price_fontsize};
        }
        .selectable .first-price-WB {
            font-size: ${wideBundle.settings.unselected_price_fontsize};
        }
        .selectable .second-price-WB {
            font-size: ${wideBundle.settings.unselected_compare_price_fontsize};
        }
        span.money.first-price-WB, .first-price-WB{
            color: ${wideBundle.settings.price_color} !important;
            margin-right: 5px;
        }
        span.money.second-price-WB, .second-price-WB{
            color: ${wideBundle.settings.price_compared_color} !important;
            text-decoration: line-through !important;
        }
        .crossed-price-WB{
            color: inherit;
            text-decoration: line-through !important;
        }
        .doubly.second-price-WB, .money.second-price-WB{
            color: ${wideBundle.settings.price_compared_color};
            text-decoration: line-through !important;
        }
        .spinWB{
            display: flex;
            width: 80px;
            margin-top: 20px;
            display: none;
            margin-bottom: 20px;
            flex: 0 0 80px;
            margin-left: auto;
        }
        .quantity-wb-less{
            border-radius: 4px 0px 0px 4px;
            background-color: ${wideBundle.settings.bg_button_quantity};
            color: ${wideBundle.settings.color_button_quantity};
            border: 1px solid #dadada;
            display: inline-block;
            width: 33%;
            padding-top:0px;
            padding-bottom:0px;
            text-align: center;
            cursor: pointer;
            vertical-align: 1.5px;
        }
        .quantity-wb-more{
            border-radius:0px 4px 4px 0px;
            background-color: ${wideBundle.settings.bg_button_quantity};
            color: ${wideBundle.settings.color_button_quantity};
            border: 1px solid #dadada;
            display: inline-block;
            width: 33%;
            padding-top:0px;
            padding-bottom:0px;
            text-align: center;
            cursor: pointer;
            vertical-align: 1.5px;
        }
        #new-form .quantity-wb-input, .new-wb-form .quantity-wb-input{
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: ${wideBundle.settings.bg_input_quantity};
            color: ${wideBundle.settings.color_input_quantity};
            appearance: none;
            width: 34%;
            text-align: center;
            font-weight: bold;
            border: 1px solid #dadada;
            border-left: 0;
            border-right: 0;
            padding-left:0px;
            padding-right:0px;
            padding-top: 0px;
            padding-bottom: 0px;
            align-self: stretch;
            box-sizing: border-box;
        }
        .div-select2:first-of-type{
            margin-top: 10px;
        }
        #new-form .select-option-third, .new-wb-form .select-option-third{
            margin:0;
            line-height:23px;
            position:static;
            opacity:1;
            display:block;
            background-position: right 10px center !important;
            border-radius:3px;
            border: 1px solid ${wideBundle.settings.border_color};
            font-size:16px;
            float:left;
            min-width:100px;
            max-width:auto;
            width:auto;
            min-height:25px;
            height:25px;
            padding:0;
            padding-left:3px;
            padding-right:25px;
            margin-left:5px;
            color:black;
        }
        #new-form .select-option-second, .new-wb-form .select-option-second{
            line-height:23px;
            position:static;
            opacity:1;
            display:block;
            background-position: right 10px center !important;
            border-radius:3px;
            border: 1px solid ${wideBundle.settings.border_color};
            font-size:16px;
            float:left;
            min-width:100px;
            max-width:auto;
            width:auto;
            min-height:25px;
            height:25px;
            padding:0;
            padding-left:3px;
            padding-right:25px;
            margin:0;
            color:black;
        }
        #new-form .wb-swatch-container .select-option-third, .new-wb-form .wb-swatch-container .select-option-third{
            margin-left: 0px;
        }
        #new-form .pretty-select, .new-wb-form .pretty-select{
            padding: 0px 0px 0px 0px;
        }
        #new-form .disclosure .disclosure__toggle svg, .pretty-select svg, .new-wb-form .disclosure .disclosure__togle svg{
            display: none;
        }
        .title-option-wb{
            color: ${wideBundle.settings.option_color};
            font-size:0.8em;
            margin:0;
            margin-top:3px;
            margin-right:5px;
            margin-bottom:10px;
            float:left;
        }
        .clear{
            margin:0;
            clear:both;
            margin-top: 0px !important;
            margin-bottom: 0px !important;
        }
        .economic-wb{
            margin-top: 0px;
            margin-bottom: 0px;
            font-size: 0.9em;
            color: ${wideBundle.settings.economic_color};
        }
        #new-form-atc, .new-form-atc{
            width: 100%;
            cursor: pointer;
            background-color: ${wideBundle.settings.atc_background};
            color: ${wideBundle.settings.atc_color};
            border-radius: ${wideBundle.settings.atc_radius};
            text-align: center;
            font-size: ${wideBundle.settings.atc_font_size};
            margin-top: 10px;
            margin-bottom: 15px;
            ${wideBundle.settings.atc_size == 'small' ? 'padding: 10px 0 10px 0;' : ''}
            ${wideBundle.settings.atc_size == 'medium' ? 'padding: 20px 0 20px 0;' : ''}
            ${wideBundle.settings.atc_size == 'large' ? 'padding: 30px 0 30px 0;' : ''}
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            ${wideBundle.settings.atc_font != 'auto' ? 'font-family: ' + wideBundle.settings.atc_font : ''}
        }
        #new-form-atc:hover, .new-form-atc:hover{
            background-color: ${wideBundle.settings.hover_color};
        }
        .before-code-wb{
            margin-top: 10px;
        }
        #new-form .selectable, .new-wb-form .selectable{
            background-color: ${wideBundle.settings.unselected_background_color + wideBundle.settings.unselected_background_transparency};
            border: ${wideBundle.settings.unselected_border_size} solid ${wideBundle.settings.unselected_border_color};
            font-weight: normal;
        }
        .selectable .title-variant{
            color: ${wideBundle.settings.offer_color};
        }
        .selectable span.money.first-price-WB, .selectable .first-price-WB{
            color: ${wideBundle.settings.price_color} !important;
        }
        .selectable span.money.second-price-WB, .selectable .second-price-WB{
            color: ${wideBundle.settings.price_compared_color} !important
        }
        .selectable economic-wb{
            color: ${wideBundle.settings.economic_color};
        }
        .selectable .best-title{
            color: ${wideBundle.settings.color_best};
            border: ${wideBundle.settings.unselected_message_border_size} solid ${wideBundle.settings.unselected_message_border_color};
            border-radius: ${wideBundle.settings.unselected_message_border_radius};
            background-color: ${wideBundle.settings.unselected_message_background_color + wideBundle.settings.unselected_message_background_transparency};
            ${wideBundle.settings.unselected_message_background_transparency !== '00' || wideBundle.settings.unselected_message_border_size !== '0px' ? 'margin: 3px 0px; padding: 3px 5px;' : ''};
            display: inline-block;
            width: 100%;
            ${wideBundle.settings.unselected_message_background_transparency !== '00' || wideBundle.settings.unselected_message_border_size !== '0px' ? 'width: auto;' : ''};

            font-family: ${wideBundle.settings.font_unselected_custom_sentence != 'auto' ? wideBundle.settings.font_unselected_custom_sentence + ',' : ''} Arial, sans-serif;
        }
        .selectable .checkedWB{
            background-color: #f4f4f4;
        }
        .selectable .div-select2{
            display: none;
            visibility: hidden;
        }
        .selectable .spinWB{
            display: none;
        }
        .selectable .money{
            font-weight: normal !important;
        }
        #new-form .selectedWB, .new-wb-form .selectedWB{
            background-color: ${wideBundle.settings.background_color};
            border: ${wideBundle.settings.border_size} solid ${wideBundle.settings.border_color};
            font-weight: bold;
        }
        .selectedWB .title-variant{
            color: ${wideBundle.settings.offer_selected_color};
            ${wideBundle.settings.style_title_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_title_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_title_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_title_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB span.money.first-price-WB, .selectedWB .first-price-WB{
            color: ${wideBundle.settings.price_selected_color} !important;
            ${wideBundle.settings.style_price_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB span.money.second-price-WB, .selectedWB .second-price-WB{
            color: ${wideBundle.settings.price_compared_selected_color} !important;
            ${wideBundle.settings.style_compared_price_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_compared_price_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_compared_price_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_compared_price_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB .economic-wb{
            color: ${wideBundle.settings.economic_selected_color};
            ${wideBundle.settings.style_economic_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB .best-title{
            color: ${wideBundle.settings.best_selected_color};
            border: ${wideBundle.settings.message_border_size} solid ${wideBundle.settings.message_border_color};
            border-radius: ${wideBundle.settings.message_border_radius};
            background-color: ${wideBundle.settings.message_background_color + wideBundle.settings.message_background_transparency};
            ${wideBundle.settings.message_background_transparency !== '00' || wideBundle.settings.message_border_size !== '0px' ? 'margin: 3px 0px; padding: 3px 5px;' : ''};
            display: inline-block;
            width: 100%;
            ${wideBundle.settings.unselected_message_background_transparency !== '00' || wideBundle.settings.unselected_message_border_size !== '0px' ? 'width: auto;' : ''};
            font-family: ${wideBundle.settings.font_selected_custom_sentence != 'auto' ? wideBundle.settings.font_selected_custom_sentence + ',' : ''} Arial, sans-serif;
        }
        
        .selectedWB .checkedWB{
            background-color: ${wideBundle.settings.border_color};
        }
        .selectedWB .best-title-new{
            ${wideBundle.settings.style_blinking_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB .span-economic-wb{
            ${wideBundle.settings.style_economic_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB .div-select2{
            ${wideBundle.settings.style_variants_selected == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_variants_selected == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_variants_selected == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_variants_selected == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable .best-title-new{
            ${wideBundle.settings.style_blinking == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_blinking == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_blinking == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable .span-economic-wb{
            ${wideBundle.settings.style_economic == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_economic == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable .div-select2{
            ${wideBundle.settings.style_variants == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_variants == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_variants == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_variants == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable .title-variant{
            color: ${wideBundle.settings.offer_color};
            ${wideBundle.settings.style_title == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_title == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_title == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_title == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable span.money.first-price-WB, .selectable .first-price-WB{
            ${wideBundle.settings.style_price == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_price == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_price == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable span.money.second-price-WB, .selectable .second-price-WB{
            ${wideBundle.settings.style_compared_price == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_compared_price == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_compared_price == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_compared_price == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectable .economic-wb{
            ${wideBundle.settings.style_economic == 'none' ? 'font-style: normal !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic == 'bold' ? 'font-style: normal !important;font-weight: bold !important;' : ''};
            ${wideBundle.settings.style_economic == 'italic' ? 'font-style: italic !important;font-weight: normal !important;' : ''};
            ${wideBundle.settings.style_economic == 'bold-italic' ? 'font-style: italic !important;font-weight: bold !important;' : ''};
        }
        .selectedWB .spinWB{
            display: flex;
        }

        .selectedWB .spinWB span{
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .selectedWB select.select-bundle.select-class-second {
            color: ${wideBundle.settings.option_select_color} !important;
            ${wideBundle.settings.option_select_default_settings == 1 ? '' : 'background: ' + wideBundle.settings.option_select_background + '!important'};
        }

        .hide-bloc-wb{
            display: none !important;
        }
        #new-form .loading-wb, .new-wb-form .loading-wb{
            width: 20px;
            height: 20px;
        }
        #cont-trustbadge-wb, .cont-trustbadge-wb{
            text-align: center;
            width: 80%;
            margin: auto;
        }
        #cont-trustbadge-wb img, .cont-trustbadge-wb img{
            width: 100%;
        }
        #after-code-wb{
            margin-top: 10px;
        }
        #new-form p:empty, .new-wb-form p:empty{
            display: block;
        }
        .d-flex.form-wb-selected{
            display: none !important;
        }
        .new-form-atc--out-of-stock,
        .new-form-atc--out-of-stock[style] {
            animation: none !important;
            -webkit-animation: none !important;
            opacity: 0.5 !important;
        }
        .new-form-atc--out-of-stock svg,
        .new-form-atc--out-of-stock[style] svg {
            display: none!important;
        }

        #new-form .widebundle_error, .new-wb-form .widebundle_error{
            color: #cc0000;
            text-align: center;
            background-color: #ffecec;
            padding: 10px;
            border: 1px solid #cc0000;
            border-radius: 5px;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            font-size: 14px !important;
            font-family: Helvetica !important;
            width: 100%;
        }
        #new-form .widebundle_error.visible, .new-wb-form .widebundle_error.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #new-form .widebundle_error a, .new-wb-form .widebundle_error a{
            color: #cc0000 !important;
            text-decoration: underline !important;
        }
        .widebundle_error svg{
            vertical-align: -10%;
            display: inline-block
        }
        
        .wb-color-swatch-box {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            // margin: 0 20px 10px 0;
        }
        
        .wb-color-swatch > input {
            visibility: hidden;
            position: absolute !important;
        }
        
        .wb-color-swatch > input + .wb-color-swatch-radio {
            cursor:pointer;
            border: 1px solid #ffffff;
            outline: 2px solid #c1c1c1;   
        }
        
        .wb-color-swatch > input:checked + .wb-color-swatch-radio {
            border: 1px solid #ffffff;
            outline: 2px solid ${wideBundle.settings.border_color};           
        }
        
        .wb-color-swatch-radio {
            display: flex !important;
            position: relative;
            width: 22px;
            height: 22px;
            margin: 2px;
            background: #ffffff;
            border: 1px solid #ffffff;
            outline: 1px solid #c1c1c1;
            border-radius: 100%;
            background-size: 100% 100%;
            background-position: center;
            box-sizing: border-box;
        }
        
        .wb-color-swatch-radio:after {
            content: "";
            position: absolute;
            left: -3px;
            top: -3px;
            width: 26px;
            height: 26px;
            background: #e0e0e0;
            border-radius: 100%;
            box-sizing: border-box;
            z-index: -1;
        }
        
        .wb-swatch-container .title-option-wb {
            width: 100%;
            margin: 0;
        }
        
        .wb-swatch-container {
            display: flex;
            flex-wrap: wrap;
            gap:6px 15px;
            margin-bottom: 10px;
        }
        
        .swatch-3-select,
        .swatch-2-select {
            display: none !important;
        }
    `;

    addStyleToPage(mainStyle, attribute);
}

//Add the style based on structure used
wideBundle.addStructureStyle = function (attribute = '') {

    if(document.querySelector('.block-settings') !== null){
        var structure = wideBundle.settings.design_code; //Layout chosen
    }
    else{
        var structure = wideBundle.settings.plan == "monthly" && wideBundle.settings.design_code > 3 ? 0 : wideBundle.settings.design_code; //Layout chosen
    }

    if (structure == 0) { //For basic and default design
        if (wideBundle.settings.display_quantity == 1) { //Add style for quantity button if enabled
            var style = `
                .value-left .offer-image{
                    min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "90px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "110px" : "130px")} !important;;
                }
                .selectedWB .offer-image{
                    min-width: ${wideBundle.settings.thumbnail_size == "s" ? "90px" : (wideBundle.settings.thumbnail_size == "m" ? "110px" : "130px")} !important;;
                }
                .selectedWB{
                    position: relative;
                    padding-bottom: 10px;
                }
                .spinWB{
                    position: static;
                    height: 30px;
                    right: 5px;
                    bottom: 5px;
                    margin: 0px;
                    margin-left: auto;
                }
                .quantity-wb-input{
                    height: 30px;
                }
                .selectable{
                    padding-bottom: 10px;
                }
                @media screen and (max-width: 400px){
                    .selectedWB{
                        position: relative;
                        padding-bottom: 40px;
                    }
                    .spinWB{
                        position: absolute;
                        height: 25px;
                        right: 5px;
                        bottom: 5px;
                        margin: 0px;
                    }
                    .quantity-wb-input{
                        height: 25px;
                    }
                }
            `;
            addStyleToPage(style, attribute);
        }
    }
    else if (structure == 1) { //For vertical layout
        var style = `
            .title-variant{
                font-size: 1em;
                text-align: center;
                margin-top: 10px;
            }
            .new-form-option .first-unit-WB{
                margin-left: auto;
                margin-bottom: 0px;
                padding-left: 10px;
                text-align: center;
                display: flex;
                flex-direction: column;
            }
            .price-new-form, .first-unit-WB{
                //font-size: ${wideBundle.settings.price_size};
                text-align: center;
            }
            .best-title{
                width: 100%;
                text-align: center;
                display: block;
                margin-top: 10px;
            }
            .economic-wb{
                font-size: 0.8em;
                text-align: center;
            }
            .p-title-WB{
                width: 100%;
                flex-basis: 100%;
            }
            #new-form, .new-wb-form{
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            .new-form-option{
                display: block;
                padding: 10px 10px 10px 10px;
                margin: 7px;
                flex: 1;
            }
            .value-right{
                max-width: 100%;
            }
            .value-left{
                display: block;
            }
            .value-left img{
                margin: 0;
            }
            .checkedWB{
                margin: auto;
                margin-top: 5px;
                margin-bottom: 10px;
            }
            #new-form .select-class-second, .new-wb-form .select-class-second{
                margin: 2px 0px 0px 0px;
            }
            .selectedWB .div-select2{
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 5px;
                justify-content: center;
            }
            .selectedWB .div-select2 p{
                margin-top: 7px;
                margin-bottom: 3px;
            }
            .selectable{
                border: ${wideBundle.settings.unselected_border_size} solid ${wideBundle.settings.unselected_border_color};
            }
            .new-form-option .value-left{
                flex-direction: column;
            }
            
            .wb-swatch-container .title-option-wb {
                text-align: center;
            }
            
            .wb-swatch-container .wb-color-swatch-box {
                margin-right: 0;
                justify-content: center;
            }
        `;
        if (wideBundle.settings.display_quantity == 1) {
            style += `
                .selectedWB{
                    position: relative;
                    padding-bottom: 5px;
                }
                .selectedWB .spinWB{
                    position: static;
                    height: 30px;
                    right: 5px;
                    bottom: 5px;
                    margin: auto;
                    margin-top: 10px;
                }
                .selectedWB .quantity-wb-input{
                    height: 30px;
                    line-height: 30px;
                }
                .selectable{
                    padding-bottom: 5px;
                }
            `;
        }
        addStyleToPage(style, attribute);
    }
    else if (structure == 2) { //For minimalist layout
        var style = `
            .thumbnailWB{
                width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "30px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "40px" : "50px")} !important;
            }

            .selectedWB .thumbnailWB{
                width: ${wideBundle.settings.thumbnail_size == "s" ? "30px" : (wideBundle.settings.thumbnail_size == "m" ? "40px" : "50px")} !important;
            }

            .offer-image{
                min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "78px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "88px" : "98px")} !important;
            }

            .selectedWB .offer-image{
                min-width: ${wideBundle.settings.thumbnail_size == "s" ? "78px" : (wideBundle.settings.thumbnail_size == "m" ? "88px" : "98px")} !important;
            }

            .new-form-option{
                position: relative;
                padding: 5px 10px 5px 0px;
            }
            .title-variant{
                font-size: 1em;
            }
            .new-form-option .price-new-form, .new-form-option .first-unit-WB{
                margin-left: auto;
                margin-bottom: 0px;
                padding-left: 10px;
                text-align: right;
            }

            .new-form-option .first-unit-WB{
                text-align: center;
                display: flex;
                flex-direction: column;
            }
            .economic-wb{
                margin-top: 0px;
                margin-bottom: 0px;
            }
            span.money.first-price-WB, .first-price-WB{
                margin-right: 0px;
                white-space: nowrap;
                overflow: hidden;
            }
            span.money.second-price-WB, .second-price-WB{
                margin-left: 5px;
                white-space: nowrap;
                overflow:hidden;
            }
            .div-select2{
                margin-top: 5px;
            }
            .checkedWB{
                width: 12px;
                height: 12px;
                border: 2px solid rgb(244, 244, 244);
            }
            .title-option-wb{
                margin-bottom: 0px;
            }

            .diagonal-offer{
                padding-right: 40px !important;
            }

            @media screen and (max-width: 600px){
                .title-option-wb{
                    width: 100%;
                    margin-bottom: 0px;
                }

                .thumbnailWB{
                    width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "30px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "40px" : "40px")} !important;
                }

                .selectedWB .thumbnailWB{
                    width: ${wideBundle.settings.thumbnail_size == "s" ? "30px" : (wideBundle.settings.thumbnail_size == "m" ? "40px" : "40px")} !important;
                }

                .offer-image{
                    min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "78px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "88px" : "88px")} !important;
                }

                .selectedWB .offer-image{
                    min-width: ${wideBundle.settings.thumbnail_size == "s" ? "78px" : (wideBundle.settings.thumbnail_size == "m" ? "88px" : "88px")} !important;
                }
            }

            @media screen and (max-width: 400px){
                #new-form .select-option-third, .new-wb-form .select-option-third{
                    margin-top: 2px;
                    margin-left: 0px;
                }
                #new-form .select-option-second, .new-wb-form .select-option-second{
                    float: none;
                }
            }
        `;
        if (wideBundle.settings.display_quantity == 1) {
            style += `
                .spinWB{
                  margin-top: 5px;
                  margin-bottom: 5px;
                  margin-left: 10px;
                }
                .selectedWB{
                  position: relative;
                  padding-bottom: 5px;
                }
                .selectedWB .spinWB{
                  position: static;
                  height: 30px;
                  right: 5px;
                  bottom: 5px;
                  margin: 0px;
                  margin-left: 5px;
                }
                .selectedWB .quantity-wb-input{
                  height: 30px;
                }
                .selectable{
                  padding-bottom: 5px;
                }
                @media screen and (max-width: 400px){
                    .selectedWB{
                        position: relative;
                        padding-bottom: 40px;
                    }
                    .selectedWB .spinWB{
                        position: absolute;
                        height: 25px;
                        right: 5px;
                        bottom: 5px;
                    }
                    .selectedWB .quantity-wb-input{
                        height: 25px;
                    }
                }
            `;
        }
        //We hve to move the price and quantity to the right of the offer for that layout
        var elemsUnit = document.querySelectorAll('.new-form-option .first-unit-WB');
        for (var i = 0; i < elemsUnit.length; i++) {
            offerNode = elemsUnit[i].parentNode.parentNode;
            offerNode.appendChild(elemsUnit[i]);
        }

        var elems = document.querySelectorAll('.new-form-option .price-new-form');
        for (var i = 0; i < elems.length; i++) {
            offerNode = elems[i].parentNode.parentNode;
            offerNode.appendChild(elems[i]);
            if (wideBundle.settings.display_quantity == 1) {
                quantityElem = document.querySelectorAll('.spinWB')[i];
                offerNode.appendChild(quantityElem);
            }
        }
        addStyleToPage(style, attribute);
    }
    else if (structure == 3) { //For royal layout
        var style = `
            .new-form-option .price-new-form, .new-form-option .first-unit-WB{
                margin-left: auto;
                margin-bottom: 0px;
                padding-left: 10px;
                text-align: right;
            }

            .new-form-option .first-unit-WB{
                text-align: center;
                display: flex;
                flex-direction: column;
            }

            span.money.first-price-WB, .first-price-WB{
                margin-right: 0px;
                white-space: nowrap;
                overflow: hidden;
            }
            span.money.second-price-WB, .second-price-WB{
                margin-left: 5px;
                white-space: nowrap;
                overflow: hidden;
            }
            .new-form-option{
                position: relative;
                padding: 5px 10px 5px 0px;
            }
            .with-message .div-select2{
                margin-top: 10px;
            }
            .with-message .title-variant{
                margin-bottom: -5px;
            }
            .economic-wb{
                margin-top: 0px;
                margin-bottom: 0px;
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: ${wideBundle.settings.border_color};
                padding: 3px 40px 3px 40px;
                border-radius: 5px;
                white-space: nowrap;
                overflow: hidden;
            }
            .with-economic-text{
                padding-bottom: 20px;
                margin-bottom: 18px;
            }
            .value-right.with-message{
                padding-bottom: 20px;
            }

            .diagonal-offer{
                padding-right: 40px !important;
            }

            @media screen and (max-width: 600px){
                .title-option-wb{
                    margin-bottom: 0px;
                }
                .has-double-select .title-option-wb{
                    width: 100%;
                }
                .offer-image img{
                    width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "30px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "40px" : "60px")};
                }
                .selectedWB .offer-image img{
                    width: ${wideBundle.settings.thumbnail_size == "s" ? "30px" : (wideBundle.settings.thumbnail_size == "m" ? "40px" : "60px")};
                }
                .offer-image{
                    min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "80px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "90px" : "110px")};
                }
                .selectedWB .offer-image{
                    min-width: ${wideBundle.settings.thumbnail_size == "s" ? "80px" : (wideBundle.settings.thumbnail_size == "m" ? "90px" : "110px")};
                }
                .title-variant{
                    font-size: 1em;
                }
            }

            @media screen and (max-width: 400px){
                #new-form .select-option-third, .new-wb-form .select-option-third{
                    margin-top: 2px;
                    margin-left: 0px;
                }
                #new-form .select-option-second, .new-wb-form .select-option-second{
                    float: none;
                }
            }
        `;
        if (wideBundle.settings.display_quantity == 1) {
            style += `
                .spinWB{
                    margin-top: 5px;
                    margin-bottom: 5px;
                    margin-left: 10px;
                }
                .selectedWB{
                    position: relative;
                    padding-bottom: 5px;
                }
                .selectedWB.with-economic-text{
                  padding-bottom: 20px;
                }
                .selectedWB .spinWB{
                    position: static;
                    height: 30px;
                    right: 5px;
                    bottom: 5px;
                    margin: 0px;
                    margin-left: 5px;
                }
                .selectedWB .quantity-wb-input{
                    height: 30px;
                }
                .selectable{
                    padding-bottom: 5px;
                }
                .selectable.with-economic-text{
                    padding-bottom: 20px;
                }
                @media screen and (max-width: 400px){
                    .selectedWB{
                        position: relative;
                        padding-bottom: 40px;
                    }
                    .selectedWB.with-economic-text{
                      padding-bottom: 40px;
                    }
                    .selectedWB .spinWB{
                        position: absolute;
                        height: 25px;
                        right: 5px;
                        bottom: 20px;
                    }
                    .selectedWB .quantity-wb-input{
                        height: 25px;
                    }
                }
            `;
        }
        //We have to move the price and quantity to the right of the offer for that layout
        var elemsUnit = document.querySelectorAll('.new-form-option .first-unit-WB');
        for (var i = 0; i < elemsUnit.length; i++) {
            offerNode = elemsUnit[i].parentNode.parentNode;
            offerNode.appendChild(elemsUnit[i]);
        }

        var elems = document.querySelectorAll('.new-form-option .price-new-form');
        for (var i = 0; i < elems.length; i++) {
            offerNode = elems[i].parentNode.parentNode;
            offerNode.appendChild(elems[i]);
            if (wideBundle.settings.display_quantity == 1) {
                quantityElem = document.querySelectorAll('.spinWB')[i];
                offerNode.appendChild(quantityElem);
            }
        }
        //We have to move the economic price
        var elems = document.querySelectorAll('.new-form-option .economic-wb');
        for (var i = 0; i < elems.length; i++) {
            elems[i].closest('.new-form-option').appendChild(elems[i]);
        }
        addStyleToPage(style, attribute);
    }

    else if (structure == 4) { //For elegant layout
        var style = `
            .new-form-option .price-new-form, .new-form-option .first-unit-WB{
                margin-left: auto;
                margin-bottom: 0px;
                padding-left: 20px;
                text-align: right;
                display: flex;
                flex-direction: column;
            }
            .new-form-option .first-unit-WB{
                text-align: center;
                display: flex;
                flex-direction: column;
            }
            span.money.first-price-WB, .first-price-WB{
                margin-right: 0px;
                white-space: nowrap;
                overflow: hidden;
            }
            span.money.second-price-WB, .second-price-WB{
                margin-left: 5px;
                white-space: nowrap;
                overflow: hidden;
            }
            .new-form-option{
                position: relative;
                padding: 10px 10px 10px 0px;
                margin-bottom: 0px;
                border-radius: 0px;
                border-top: 0px !important;
                border-color: ${wideBundle.settings.border_color} !important;
            }
            .with-message .div-select2{
                margin-top: 10px;
            }
            .with-message .title-variant{
                margin-bottom: -5px;
            }
            .checkedWB {
                box-shadow: 0 0 0 2px ${wideBundle.settings.border_color};
                border: 2px solid #f4f4f4;
                border-radius: 5px;
                width: 15px;
                height: 15px;
            }
            .economic-wb{
                position: absolute;
                bottom: 0;
                right: 0;
                border-top-left-radius: 5px;
                background-color: ${wideBundle.settings.border_color};
                padding: 3px 40px 3px 40px;
                white-space: nowrap;
                overflow: hidden;
            }
            .selectable .economic-wb {
                padding: ${parseInt(wideBundle.settings.unselected_border_size) + 3}px 8px 3px ${parseInt(wideBundle.settings.unselected_border_size) + 8}px;
            }
            .selectedWB .economic-wb {
                padding: ${parseInt(wideBundle.settings.border_size) + 3}px 8px 3px ${parseInt(wideBundle.settings.border_size) + 8}px;
            }
            .selectable.with-economic-text{
                padding-bottom: ${(parseInt(wideBundle.settings.unselected_border_size) / 2) + 30}px !important;
            }
            .selectedWB.with-economic-text{
                padding-bottom: ${(parseInt(wideBundle.settings.border_size) / 2) + 30}px !important;
            }
            .p-title-WB{
                background-color: ${wideBundle.settings.border_color};
                margin: 0px;
                padding: 8px 0px;
                overflow: unset;
                border-radius: 5px 5px 0px 0px;
            }

            .p-title-WB__content {
                ${wideBundle.settings.preview_heading_position == 'left' ? 'margin: 0 auto 0 10px;' : ''};
                ${wideBundle.settings.preview_heading_position == 'center' ? 'margin: 0 auto;' : ''};
                ${wideBundle.settings.preview_heading_position == 'right' ? 'margin: 0 10px 0 auto;' : ''};
             }
            .p-title-WB__arrow{
                z-index: 1;
            }
            .p-title-WB__arrow::before{
                content: '';
                position: absolute;
                top: 100%;
                left: calc(50% - 10px);
                background-color: ${wideBundle.settings.border_color};
                width: 20px;
                height: 10px;
                clip-path: polygon(0 0, 100% 0, 50% 100%);
            }
            .corner-offer-container{
                margin-top: 0px;
            }
            .diagonal-offer{
                padding-right: 40px !important;
            }
            #new-form-atc, .new-form-atc{
                border-radius: 5px;
            }
            .settings-preview-main-wrapper{
                margin-top: 15px !important;
            }
            .best-title{
                display: inline-block;
            }

            @media screen and (max-width: 600px){
                .title-option-wb{
                    margin-bottom: 0px;
                }
                .has-double-select .title-option-wb{
                    width: 100%;
                }
                .offer-image img{
                    width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "30px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "40px" : "60px")};
                }
                .selectedWB .offer-image img{
                    width: ${wideBundle.settings.thumbnail_size == "s" ? "30px" : (wideBundle.settings.thumbnail_size == "m" ? "40px" : "60px")};
                }
                .offer-image{
                    min-width: ${wideBundle.settings.unselected_thumbnail_size == "s" ? "80px" : (wideBundle.settings.unselected_thumbnail_size == "m" ? "90px" : "110px")};
                }
                .selectedWB .offer-image{
                    min-width: ${wideBundle.settings.thumbnail_size == "s" ? "80px" : (wideBundle.settings.thumbnail_size == "m" ? "90px" : "110px")};
                }
                .title-variant{
                    font-size: 1em;
                }
            }

            @media screen and (max-width: 400px){
                .select-option-third{
                    margin-top: 2px;
                    margin-left: 0px;
                }
                .select-option-second{
                    float: none;
                }
            }
        `;
        if (wideBundle.settings.display_quantity == 1) {
            style += `
                .spinWB{
                    margin-top: 5px;
                    margin-bottom: 5px;
                    margin-left: 10px;
                }
                .selectedWB{
                    position: relative;
                    padding-bottom: 5px;
                }
                .selectedWB.with-economic-text{
                  padding-bottom: 20px;
                }
                .selectedWB .spinWB{
                    position: static;
                    height: 30px;
                    right: 5px;
                    bottom: 5px;
                    margin: 0px;
                    margin-left: 5px;
                }
                .selectedWB .quantity-wb-input{
                    height: 30px;
                }
                .selectable{
                    padding-bottom: 10px;
                }
                .selectable.with-economic-text{
                    padding-bottom: 20px;
                }
                @media screen and (max-width: 400px){
                    .selectedWB{
                        position: relative;
                        padding-bottom: 40px;
                    }
                    .selectedWB.with-economic-text{
                      padding-bottom: 40px;
                    }
                    .selectedWB .spinWB{
                        position: absolute;
                        height: 25px;
                        right: 5px;
                        bottom: 40px;
                    }
                    .selectedWB .quantity-wb-input{
                        height: 25px;
                    }
                }
            `;
        }
        //We have to move the price and quantity to the right of the offer for that layout
        var elemsUnit = document.querySelectorAll('.new-form-option .first-unit-WB');
        for (var i = 0; i < elemsUnit.length; i++) {
            offerNode = elemsUnit[i].parentNode.parentNode;
            offerNode.appendChild(elemsUnit[i]);
        }

        //We have to move the price and quantity to the right of the offer for that layout
        var elems = document.querySelectorAll('.new-form-option .price-new-form');
        for (var i = 0; i < elems.length; i++) {
            offerNode = elems[i].parentNode.parentNode;
            offerNode.appendChild(elems[i]);
            if (wideBundle.settings.display_quantity == 1) {
                quantityElem = document.querySelectorAll('.spinWB')[i];
                offerNode.appendChild(quantityElem);
            }
        }

        //We have to add round corners to last offer for elegant design
        var elems = document.querySelectorAll('#new-form, .new-wb-form ');
        for (var i = 0; i < elems.length; i++) {
            formOffers = elems[i].querySelectorAll(".new-form-option");
            lastOffer = formOffers[formOffers.length - 1]
            lastOffer.style.borderRadius = '0px 0px 5px 5px';
        }

        //We have to move the economic price
        var elems = document.querySelectorAll('.new-form-option .economic-wb');
        for (var i = 0; i < elems.length; i++) {
            elems[i].closest('.new-form-option').appendChild(elems[i]);
        }
        addStyleToPage(style, attribute);
    }

    else if (structure == 5) { //For solid layout
        var style = `
            .title-variant{
                margin-top: 10px;
                font-size: 1em;
            }
            .best-title{
                width: auto;
                display: block;
                margin-top: 10px;
            }
            .economic-wb{
                margin: 0px auto;
                position: absolute;
                background-color: white;
                padding: 4px 8px;
                overflow: hidden;
                //max-width: 80%;
                rotate: -3deg;
                left: 50%;
                transform: translateX(-50%);
                white-space: nowrap;
            }
            .selectable .economic-wb{
                bottom: ${-10 - parseInt(wideBundle.settings.unselected_border_size)}px;
                border: 3px solid ${wideBundle.settings.background_color};
            }
            .selectedWB .economic-wb{
                bottom: -18px;
                border: 3px solid ${wideBundle.settings.background_color};

            }
            .with-economic-text{
                position: relative;
                padding-bottom: 20px;
                margin-bottom: 18px;
            }
            .p-title-WB{
                width: 100%;
                flex-basis: 100%;
            }
            .selectable.corner-offer-container{
                padding-top: 10px !important;
            }
            .selectedWB.corner-offer-container{
                padding-top: 0px !important;
            }
            #new-form, .new-wb-form{
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            .new-form-option{
                display: block;
                padding: 0px;
                margin: 7px 1px;
                flex: 1;
                border-radius: 0px;
                padding-bottom: 30px;
            }
            .value-right{
                max-width: 100%;
                display: flex;
                flex-direction: column;
            }
            .value-right > *{
                margin-right: 10px !important;
                margin-left: 10px !important;
            }
            .value-right .price-new-form, .value-right .first-unit-WB{
                margin: 0px !important;
                padding-left: 8px;
                padding-bottom: 5px;
            }
            .value-left{
                display: block;
            }
            .value-left img{
                margin: 5px 0px;
            }
            .selectedWB .price-new-form, .selectedWB .first-unit-WB{
                margin: 0px 0px 10px 0px !important;
                top: 10px;
                position: relative;
                border-bottom: 1px solid white;
            }
            .selectedWB .value-left{
                top: 10px;
                position: relative;
            }
            .selectable .price-new-form, .selectable .first-unit-WB{
                border-bottom: 1px solid ${wideBundle.settings.unselected_border_color};
            }
            .checkedWB{
                display: none;
            }
            #new-form .select-class-second, .new-wb-form .select-class-second{
                margin: 2px 0px 0px 0px;
            }
            .selectedWB .div-select2{
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 5px;
                justify-content: center;
            }
            .selectedWB .div-select2 p{
                margin-top: 7px;
                margin-bottom: 3px;
            }
            .selectable{
                border: ${wideBundle.settings.unselected_border_size} solid ${wideBundle.settings.unselected_border_color};
                margin-top: 20px;
            }
            .selectedWB{
                border: 0px !important;
                border-bottom: 8px solid ${wideBundle.settings.border_color} !important;
            }
            .new-form-option .value-left{
                flex-direction: column;
            }
        `;
        if (wideBundle.settings.display_quantity == 1) {
            style += `
                .selectedWB{
                    position: relative;
                }
                .selectedWB .spinWB{
                    position: static;
                    height: 30px;
                    right: 5px;
                    bottom: 5px;
                    margin: auto;
                    margin-top: 10px;
                }
                .selectedWB .quantity-wb-input{
                    height: 30px;
                    line-height: 30px;
                }
            `;
        }

         //We have to move the price under thumbnail
         var elems = document.querySelectorAll('.new-form-option .price-new-form');
         for (var i = 0; i < elems.length; i++) {
             elems[i].parentNode.insertBefore(elems[i], elems[i].parentNode.firstChild);
         }

         //We have to move the unit price under thumbnail
         var elems = document.querySelectorAll('.new-form-option .first-unit-WB');
         for (var i = 0; i < elems.length; i++) {
             elems[i].parentNode.insertBefore(elems[i], elems[i].parentNode.firstChild);
         }
         
        //We have to move the economic price
        var elems = document.querySelectorAll('.new-form-option .economic-wb');
        for (var i = 0; i < elems.length; i++) {
            elems[i].closest('.new-form-option').appendChild(elems[i]);
        }
        addStyleToPage(style, attribute);

        //We have to add a padding at end of offer depends on economic text height
        /*var elems = document.querySelectorAll('.new-form-option .economic-wb');
        for (var i = 0; i < elems.length; i++) {
            if(elems[i].clientHeight !== 0){
                elems[i].parentNode.setAttribute('style', "padding-bottom:" + elems[i].clientHeight + "px !important");
            }
            if(elems[i].clientWidth !== 0){
                elems[i].setAttribute('style', "margin-left: -" + elems[i].offsetWidth /2 + "px !important");
                elems[i].style.left =  "50%";
            }

        }*/
    }
}

//Declare some variables needed
wideBundle.declareVariables = function(){
    wideBundle.locationWebsite = encodeURI(decodeURI(window.location.href));
    wideBundle.settings.currency = wideBundle.settings.currency.replace(/<\/?span.*?>/gm, '');
    wideBundle.widgetContainers = [];
    wideBundle.currencyCodes = {
        USD: 'US$',
        EUR: '',
        GBP: '',
        AUD: 'AU$',
        NZD: 'NZ$',
        CAD: 'CA$',
        JPY: '',
        DKK: 'DKK',
        NOK: 'NOK',
        SEK: 'SEK',
        BAM: 'KM',
        BGN: '.',
        CHF: 'CHF',
        DKK: 'kr.',
        ILS: '',
        ISK: 'ISK',
        LBP: '.',
        LRD: 'LRD $',
        PLN: 'z',
        RON: 'Lei',
        TRY: '',
        MXN: '$',
        HKD: '$',
        KRW: '',
        MYR: 'RM',
        SGD: '$',
        TWD: '$',
        TND: '.',
        EGP: '.',
        DZD: '',
        MAD: 'dh',
        BRL: 'R$',
        CLP: 'CLP',
        INR: '',
        UAE: '.',
        AED: '.',
        ARS: 'ARS',
        PEN: 'S/',
        SAR: 'SAR',
        CNY: '',
        RUB: '',
        ZAR: 'R',
        IDR: 'Rp',
        PHP: '',
        THB: '',
        VND: '',
        KES: 'KSh',
        PKR: 'Rs',
        EGP: 'EGP',
        IQD: 'IQD',
        KWD: 'KWD',
        OMR: 'OMR',
        QAR: 'QAR',
        JOD: 'JOD',
        LYD: 'LYD',
        SYP: 'SYP',
        BHD: 'BHD',
        JMD: 'JMD',
        BDT: 'BDT',
        NPR: 'NPR',
        LKR: 'LKR',
        KHR: 'KHR',
        MMK: 'MMK',
        LAK: 'LAK',
        VEF: 'VEF',
        COP: 'COP',
        UYU: 'UYU',
        PYG: 'PYG',
        BOB: 'BOB',
        TZS: 'TZS',
        GTQ: 'GTQ',
        NGN: 'NGN',
        MUR: 'MUR',
        MGA: 'MGA',
        XOF: 'XOF',
        RWF: 'RWF',
        HUF: 'HUF',
        UGX: 'UGX',
        TND: 'TND',
        SDG: 'SDG',
        SLL: 'SLL',
        SCR: 'SCR'
    };

    wideBundle.currencySymbols = {
        USD: '$',
        EUR: '',
        GBP: '',
        AUD: '$',
        NZD: '$',
        CAD: '$',
        JPY: '',
        DKK: 'kr.',
        NOK: 'kr.',
        SEK: 'kr.',
        BAM: 'KM',
        BGN: '.',
        CHF: '',
        ILS: '',
        ISK: 'kr',
        LBP: '.',
        LRD: '$',
        PLN: 'z',
        RON: 'lei',
        TRY: '',
        MXN: '$',
        HKD: '$',
        KRW: '',
        MYR: 'RM',
        SGD: '$',
        TWD: '$',
        TND: '.',
        EGP: '',
        DZD: '.',
        MAD: '..',
        BRL: '$',
        CLP: '$',
        INR: '',
        UAE: '.',
        AED: '.',
        ARS: '$',
        PEN: 'S/.',
        SAR: '.',
        CNY: '',
        RUB: '',
        ZAR: 'R',
        IDR: 'Rp',
        PHP: '',
        THB: '',
        VND: '',
        KES: 'KSh',
        PKR: '',
        IQD: '.',
        KWD: '.',
        OMR: '..',
        QAR: '.',
        JOD: '.',
        LYD: '.',
        SYP: '.',
        BHD: '.',
        JMD: '$',
        BDT: '',
        NPR: '',
        LKR: '',
        KHR: '',
        MMK: 'K',
        LAK: '',
        VEF: 'Bs',
        COP: '$',
        UYU: '$',
        PYG: '',
        BOB: 'Bs',
        TZS: 'TSh',
        GTQ: 'Q',
        NGN: '',
        MUR: '',
        MGA: 'Ar',
        XOF: 'CFA',
        RWF: 'RF',
        HUF: 'Ft',
        UGX: 'USh',
        SDG: '',
        SLL: 'Le',
        SCR: ''
      };

}

//Function to detect and get the product form node in the page
wideBundle.getFormNode = function(){

    //Don't select the form if the element is the same as one element below
    formsSameElementException = [
        '.checkout-x-buy-now-btn', '.price-descriptors .shopify-product-form'
    ];

    //Unwanted forms as child/parent/form
    wideBundle.formsException = [
        ".sticky-cart-form", "#form-sticky", ".container-sticky_addtocart", ".sticky-barre-content", "#shopify-section-header",
        ".product-recommendations-placeholder", ".sticky-atc-title", ".search-form", ".sticky-dropdownvar", "header.site-header", "#popUps .cart_upsell_popup",
        "#popUps .cart_downsell_popup", '.product-upsell-holder', '#product-form-installment', '.sticky_addcart', '.product-upsell__holder', '#ShippingModal',
        ".collection .card-wrapper .card__content", '#featured-product-scroll .product--variant', 'product-sticky-form', '#rio-upsell', '.t4s-product-tabs-wrapper',
        'div[data-extraclass="sticky-atc"]', '#shopify-section-pr_description', '.cu-upsell', '#CartDrawer', 'cart-drawer.cart-drawer','#product-form-main-sticky-atc',
        'gp-sticky','.pupsdreams_popup_sticky-product-details-container','.product-item--has-quick-add','.related_products'
    ];

    //Elements we want to hide
    hidingElements = [
        ".shg-product-selector-wrapper", ".tt-swatches-container", ".tt-option-block", ".dbtfy-color_swatches", ".pt-swatches-container",
        ".product-form__item--submit", ".pg__option--single", ".gt_product-swatches.gt_flex.gt_variant_product", ".button_add_to_cart.gt_product-addtocart",
        ".gt_flex.gt_variant_product"
    ];

    //Forms we want to check
    forms = [
        ".w-commerce-commerceaddtocartform.default-state-2", ".product-form", ".productForm", 'product-form form[data-type="add-to-cart-form"]', ".product-form__buy-buttons .shopify-product-form", ".shopify-product-form", "#addToCartFormId1",
        ".t4s-product__info-wrapper form.t4s-form__product", "#AddToCartForm--product-template", ".product-form-product-template", ".product-form.hidedropdown", ".addToCartForm", ".product-single__meta .product-single__meta-info .product-single__form", ".ProductForm",
        ".product-single__form", ".prod_form", "#addToCartForm-product-template-optimised", ".shg-product-atc-btn-wrapper", 'form[data-type="add-to-cart-form"].form', "form[action=\'/cart/add\']",
        "#addToCartForm", ".form-vertical", "#prodForm", "form[data-product-form]", "#add-to-cart-form", "form[action$='/cart/add']", ".product-single__form:nth-child(2)"
    ];

    allForms = 0

    forms.forEach(form => {
        allForms +=  document.querySelectorAll(form).length;
    })

    //To detect and get the product form node in the page
    form:
    for(var i=0; i < forms.length; i++){
        formLength = document.querySelectorAll(forms[i]).length;
        console.log("form length: " + formLength + " for: " + forms[i]);
        //For all the forms found in the page
        formNumber:
        for(j=0; j<formLength; j++){
            form = document.querySelectorAll(forms[i])[j];
            formID = forms[i];
            //If the form is found and is not .product-form (because we can't use it)
            if(typeof form !== 'undefined' && form != null && formID != ".product-form") {
                console.log('form found:');
                console.log(form);
                //For all the exceptions classes
                for(var x=0; x < wideBundle.formsException.length; x++){
                    exceptionAll = document.querySelectorAll(wideBundle.formsException[x]);
                    for(var z=0; z < exceptionAll.length; z++){
                        exception = exceptionAll[z];
                        //If the form is an exception then check next form found in the page
                        if(exception == form || isDescendant(exception, form) || isDescendant(form, exception)){
                            console.log('form is an exception...');
                            continue formNumber;
                        }
                    }
                }
                //For all exceptions that are the same element
                for(var x=0; x < formsSameElementException.length; x++){
                    exceptionAll = document.querySelectorAll(formsSameElementException[x]);
                    for(var z=0; z < exceptionAll.length; z++){
                        exception = exceptionAll[z];
                        //If the form is an exception then check next form found in the page
                        if(exception != undefined && exception == form){
                            console.log('form is an exception...');
                            continue formNumber;
                        }
                    }
                }
                //Check forms we don't wants (those with only hidden elements)
                childElementsWB = form.querySelectorAll('*');
                good = 0;
                for(var x=0; x<childElementsWB.length; x++){
                    if(typeof childElementsWB[x] == "object" && typeof childElementsWB[x].type != "undefined" && childElementsWB[x].type != "hidden"){
                        good = 1;
                    }
                }
                if(good == 0 && (allForms >= 2 || childElementsWB.length == 0 || form.tagName == "BUTTON") ){
                    console.log('form is another exception');
                    continue formNumber;
                }
                //If form exists and has passed the exceptions then we can choose it to display the Widget
                if(form !== 'undefined' && form != null){
                    console.log("chosen form:" + formID);
                    return {
                        element: form,
                        id: formID
                    }
                }
            }
        }
    };
    console.log('form not found');
    return {
        element: null,
        id: null
    };
}

//Function to detect and get the price node below the title in the page
wideBundle.getPriceNode = function(){
    updatePrice = wideBundle.settings.update_price;
    //Don't do anything if the user doesn't want to update price design
    if(updatePrice == 0){
        var priceID = 'not checked';
        var http = new XMLHttpRequest();
        var url = wideBundle.domain+'AJAX/GetPrice.php';
        var params = 'price='+priceID+'&shop='+wideBundle.shop;
        http.open('POST', url, true);
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.send(params);
        return {
            element: [],
            id: null
        };
    }

    //Selectors for price nodes
    pricesWB = [
        ".product-item-caption-price", ".ProductMeta__PriceList", "#price_ppr", ".product-single__prices", ".product-featured__price-text", ".product__price",
        ".gf_product-prices", "#productPrice-product-template", ".productTemplatePrice", ".product-price", "div[data-product-type=price]", ".modal_price",
        ".featured-product-section .product-single .box .product-wrapper .product-details .product-single__meta .price-wrapper", ":not(.wb_hidden_prices_element) .price", ".product-meta h1",
        ".price-wrapper", ".product-single__meta .product-single__meta-list", ".product-single__price", ".tt-price", ".gt_flex.price_product", ".pt-price", ".gt-product-price", 'span[data-zp-product-discount-price]',
        '.t4s-product-price', '.z-main-product__price', '.product-single__price--on-sale'
    ];
    //We don't want the price to be updated in these selectors
    pricesExceptionWB = [
        ".upsells .upsell-info", "#new-form", ".new-wb-form", "#mini-cart", '[id^="cross-sell-"]', "#CollectionSection", "#CartDrawer-CartItems",
        ".section--products-recommendations", '.featured-collections'
    ];
    //Specific blocs to get prices
    blocsToGetPricesWB = [
        ".featured_product_se"
    ];

    //Get the price node from selectors list
    priceWB:
    for(var i=0; i < pricesWB.length; i++){
        //Find the price node in specific blocs
        for(var x=0; x <blocsToGetPricesWB.length; x++){
            var blocToGetPrice = document.querySelector(blocsToGetPricesWB[x]);
            if(blocToGetPrice){
                price = blocToGetPrice.querySelectorAll(pricesWB[i]);
                if(price.length){
                    return {
                        element: blocToGetPrice.querySelectorAll(pricesWB[i]),
                        id: pricesWB[i]
                    }
                }
            }
        }
        var price = Array.from(document.querySelectorAll(pricesWB[i]));
        console.log("price length: " + price.length + " for: " + pricesWB[i]);
        if(price.length){
            for(var y=0; y<pricesExceptionWB.length; y++){
                allExcepClassPrices = document.querySelectorAll(`${pricesExceptionWB[y]}`)
                for(var z=0; z<allExcepClassPrices.length; z++){
                    price = price.filter(element => !isDescendant(allExcepClassPrices[z], element));
                }
            }
            if(!price.length){
              continue priceWB;
            }
            console.log("price " + pricesWB[i] + " found:");
            console.log(price);
            return {
                element: price,
                id: pricesWB[i]
            }
        }
    }
    console.log("No price found");
    return {
        element: [],
        id: null
    };
}

//Function to hide prices that are duplicated or unwanted when we update the price design under the title
wideBundle.hideUnwantedPrices = function(){

    var productSinglePriceWrapper = document.querySelector('.product-single__price--wrapper');
    if (productSinglePriceWrapper) {
        productSinglePriceWrapper.style.display = 'none';
    }

    var productPrice = document.getElementById('ProductPrice');
    var comparePrice = document.getElementById('ComparePrice');
    var priceNode = document.querySelector('.price');
    if (productPrice && comparePrice && !priceNode) {
        //wideBundle.priceInfo.element[0].style.display = "none";
        var salePrice = document.querySelector('.sale_price');
        var price = document.querySelector('.price');
        if (price && price.innerHTML.trim() == '' && salePrice) {
            productPrice.style.display = 'none';
            comparePrice.style.display = 'none';
            comparePrice.style.fontSize = '0px';
            productPrice.style.Size = '0px';
            salePrice.style.display = 'none';
        }
    }

    if(wideBundle.priceInfo.element.length > 0){
      if(wideBundle.priceInfo.id == ".product-single__price--on-sale"){
        let compareAtPriceToHide = document.querySelector('.product-single__price--compare-at');
        if(compareAtPriceToHide){
          compareAtPriceToHide.style.display = "none";
        }
      }
    }

    var productPriceCompare = document.querySelectorAll('.product__price--compare');
    for (var i = 0; i < productPriceCompare.length; i++) {
        productPriceCompare[i].style.display = 'none';
    }

    if(wideBundle.priceInfo.id == ".gt-product-price"){
        var gtProductComparePrice = document.querySelectorAll(".gt-product-compare-price");
        if (gtProductComparePrice[0]) {
            gtProductComparePrice[0].style.display = "none";
        }
    }

    var productAction = document.querySelector('.product-action');
    if (productAction) {
        productAction.style.display = 'none';
    }

    var compareAtPrice = document.querySelector('div[data-product-type="compare_at_price"][data-pf-type="ProductPrice"]');
    if (compareAtPrice) {
        compareAtPrice.style.display = "none";
    }

    if(wideBundle.priceInfo.id == ".product-single__price"){
        priceContainer = wideBundle.priceInfo.element[0].closest('.price-container');
        if(priceContainer){
            comparePrice = priceContainer.querySelector('#ComparePrice.product-single__price--compare-at');
            if(comparePrice !== null && comparePrice != wideBundle.priceInfo.element[0]){
                comparePrice.style.display = "none";
            }
        }
    }
}

//For some exceptions we replace the price detected by WideBundle
wideBundle.replaceSelectedPrice = function(){
    if(wideBundle.priceInfo.element[0]){
        comparePrice = document.querySelector('#ComparePrice-product-template');
        if(comparePrice){
            priceSinglePrice = document.querySelector('.product-single__price product-single__price-product-template');
            if(priceSinglePrice){
                wideBundle.priceInfo = {
                    element: document.querySelectorAll('.product-single__price'),
                    id: '.product-single__price'
                };
            }
        }

        if(wideBundle.priceInfo.element[0].offsetParent === null && wideBundle.priceInfo.id == ".product__price"){
            productPriceCompare = document.querySelector('.product__price--compare');
            if(productPriceCompare && productPriceCompare.offsetParent === null){
                productPriceSale = document.querySelector('.product__price.on-sale');
                if(productPriceSale){
                    wideBundle.priceInfo = {
                        element: document.querySelectorAll('.product__price.on-sale'),
                        id: '.product__price on-sale'
                    };
                }
            }
        }

        if(wideBundle.priceInfo.id == ".product__price"){
            productPriceSalePrice = document.querySelector('.product__price.sale-price');
            if(wideBundle.priceInfo.element[0].classList.contains("product__price--compare") && productPriceSale){
                wideBundle.priceInfo = {
                    element: document.querySelectorAll('.product__price.sale-price'),
                    id: '.product__price sale-price'
                };
            }
        }

        if(wideBundle.priceInfo.id == ".product-single__price"){
            productSinglePrice = document.querySelector('.product-single__price.product-single__price--compare');
            if(productSinglePrice && wideBundle.priceInfo.element[0].classList.contains('product__price--compare') == false){
                productSingleMeta = document.querySelector('.product-single__meta-list');
                if(productSingleMeta){
                    wideBundle.priceInfo.element[0].style.fontSize = '1.2em';
                    wideBundle.priceInfo = {
                        element: document.querySelectorAll('.product-single__meta-list'),
                        id: '.product-single__meta-list'
                    };
                }
            }
        }
    }
}

//Replace the price id value in the Database
wideBundle.replacePriceIdInDB = function(){
    if(wideBundle.settings.price_id != wideBundle.priceInfo.id){
        var http = new XMLHttpRequest();
        var url = wideBundle.domain+'AJAX/GetPrice.php';
        var params = 'price='+wideBundle.priceInfo.id+'&shop='+wideBundle.shop;
        http.open('POST', url, true);
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.send(params);
        wideBundle.settings.price_id = wideBundle.priceInfo.id;
    }
}

//Replace the form id value in the Database
wideBundle.replaceFormIdInDB = function(){
    if(wideBundle.settings.form_id != wideBundle.formInfo.id){
        var http = new XMLHttpRequest();
        var url = wideBundle.domain+'AJAX/GetForm.php';
        var params = 'form='+wideBundle.formInfo.id+'&shop='+wideBundle.shop;
        http.open('POST', url, true);
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.send(params);
        wideBundle.settings.form_id = wideBundle.formInfo.id;
    }
}

//Find WideBundle widget added manually (usually for page builders)
wideBundle.getManualWidget = function(){
    var formWidebundle = document.querySelector("#new-form");
    if(formWidebundle){
        wideBundle.formInfo.id = 'page builder';
        console.log("we found form for page builder");
        //Hide variants from Gempages
        if(formWidebundle.closest(".AddToCartForm")){
            gfVariantsWrapper = formWidebundle.closest(".AddToCartForm").querySelector('gf_variants-wrapper');
            if(gfVariantsWrapper){
                gfVariantsWrapper.style.display = "none";
            }
        }
        return formWidebundle;
    }
    else{
        return null;
    }
}

//Get the secondary widgets that were placed manually using .new-wb-form
wideBundle.getSecondaryWidgets = function(){
    var multipleFormsWB = document.querySelectorAll('.new-wb-form');
    if(multipleFormsWB.length){
      console.log("using form class");
      return multipleFormsWB;
    }
    else{
      return null;
    }
}

//For some exceptions we replace the form detected by WideBundle
wideBundle.replaceSelectedForm = function(){
    var formWB = wideBundle.formInfo;
    if(formWB.id == "form[action='/cart/add']"){
        if(formWB.element.querySelector('h2[itemprop="name"]') != null &&
        formWB.element.querySelector('.product__price-container') != null){
            if(formWB.element.querySelector('.product-details .add-to-cart-btn') != null){
                wideBundle.formInfo.element = formWB.element.querySelector('.product-details');
            }
        }
    }
}

//Hide elements we don't want from the product form found by WideBundle
wideBundle.hideElementsOutsideProductForm = function(){

    if(wideBundle.manualWidget){
        getProductSwatches = document.querySelector('.gt_product-swatches.gt_flex.gt_variant_product');
        if(getProductSwatches){
            getProductSwatches.style.display = 'none';
            getProductSwatches.classList.add('hide-unwanted-widebundle');
            buttonGtProduct = document.querySelector('.button_add_to_cart.gt_product-addtocart');
            if(buttonGtProduct){
                buttonGtProduct.style.display = 'none';
                buttonGtProduct.classList.add('hide-unwanted-widebundle');
            }
            gtFlexVariant = document.querySelector('.gt_flex.gt_variant_product');
            if(gtFlexVariant){
                gtFlexVariant.style.display = 'none';
                gtFlexVariant.classList.add('hide-unwanted-widebundle');
            }
        }
        gtProductContent = document.querySelector('.gt_product-content button[data-name="Product Button"]');
        if(gtProductContent){
            gtProductContent.style.display = "none";
            gtProductContent.classList.add('hide-unwanted-widebundle');
            style = '.gt_product-content button[data-name="Product Button"]{display:none !important;}';
            addStyleToPage(style);
        }
    }

    const firstArrayOfSelectors = [
        'div[data-pf-type="ProductVariant"]',
        'div[data-pf-type="ProductVariantSwatches"]',
        'div[data-label="(P) Quantity"]',
        'button.gt_button--product',
        '.gt_product-variant.gt_product-swatches',
        'div[data-pf-type="ProductQuantity"]',
        '.qty_near_atc_wrapper',
        'button[data-pf-type="ProductATC"]',
        'button[data-pf-type="ProductATC2"]',
        'div[data-label="(P) Variants"]',
        'div[data-label="(P) Cart Button"]',
        'div[data-label="(P) Swatches"]',
        "gp-product-button button",
        'gp-product-quantity',
        "gp-product-variants"
    ];
    const hideElementWithSelectorFromFirstArray = function(array) {
        array.forEach(el => {
            if(wideBundle.manualWidget){
                if(document.querySelector(el) != null){
                    forms = document.querySelectorAll('form');
                    for(i = 0; i < forms.length; i++){
                        if(isDescendant(forms[i], wideBundle.manualWidget)){
                            variants = forms[i].querySelector(el);
                            if(variants != null){
                                variants.style.display = "none";
                                variants.classList.add('hide-unwanted-widebundle');
                            }
                        }
                        if(wideBundle.secondaryWidgets){
                          for(var y = 0; y<wideBundle.secondaryWidgets.length; y++){
                            if(isDescendant(forms[i], wideBundle.secondaryWidgets[y])){
                                variants = forms[i].querySelector(el);
                                if(variants != null){
                                    variants.style.display = "none";
                                    variants.classList.add('hide-unwanted-widebundle');
                                }
                            }
                          }
                        }
                    }
                }
            }
        })
    };
    hideElementWithSelectorFromFirstArray(firstArrayOfSelectors);

    const arrayForHideElementWithParentNodeOneLevel = [
        'div[data-pf-type="ProductVariantSwatches"]',
        'button[data-pf-type="ProductATC"]',
        'div[data-label="(P) Variants"]',
        'div[data-label="(P) Cart Button"]',
        'div[data-label="(P) Swatches"]'
    ];
    const hideElementWithParentNodeOneLevel= function (array) {
        array.forEach(el => {
            if(wideBundle.manualWidget){
                if(document.querySelector(el) != null){
                    if(document.querySelector(el).parentNode != null){
                        if(isDescendant(document.querySelector(el).parentNode, wideBundle.manualWidget)){
                            document.querySelector(el).style.display = "none";
                            document.querySelector(el).classList.add('hide-unwanted-widebundle');
                        }
                        if(wideBundle.secondaryWidgets){
                          for(var y = 0; y<wideBundle.secondaryWidgets.length; y++){
                            if(isDescendant(document.querySelector(el).parentNode, wideBundle.secondaryWidgets[y])){
                                document.querySelector(el).style.display = "none";
                                document.querySelector(el).classList.add('hide-unwanted-widebundle');
                            }
                          }
                        }
                    }
                }
            }
        })
    };
    hideElementWithParentNodeOneLevel(arrayForHideElementWithParentNodeOneLevel);

    const arrayForHideElementWithParentNodeTwoLevel = [
        '.zpa-add-to-cart-btn',
        '.zpa-selector-wrapper',
    ];
    const hideElementWithParentNodeTwoLevel= function (array) {
        array.forEach(el => {
            if(wideBundle.manualWidget){
                if(document.querySelector(el) != null){
                    if(document.querySelector(el).parentNode != null){
                        if(isDescendant(document.querySelector(el).parentNode.parentNode, wideBundle.manualWidget)){
                            document.querySelector(el).style.display = "none";
                            document.querySelector(el).classList.add('hide-unwanted-widebundle');
                        }
                    }
                }
            }
        })
    };
    hideElementWithParentNodeTwoLevel(arrayForHideElementWithParentNodeTwoLevel);

    const thirdArrayOfSelectors = [
        '.gt_product-swatches',
        '.gt_product-variant',
        '.gt_product-quantity',
        '.gt_product-addtocart',
        '.gt_button-atc'
    ];
    const hideElementWithSelectorFromThirdArray = function (array) {
        array.forEach(el => {
            if(wideBundle.manualWidget){
                if(document.querySelector(el) != null){
                    document.querySelector(el).style.display = "none";
                    document.querySelector(el).classList.add('hide-unwanted-widebundle');
                }
            }
        })
    };
    hideElementWithSelectorFromThirdArray(thirdArrayOfSelectors);

    const fourthArrayOfSelectors = [
        '.dbtfy-color_swatches',
        '.product-layout-grid__detail .product-detail__options',
        '.product__info-wrapper variant-radios',
        'div[data-variant-picker]',
        '.product-detail__form__options.product-detail__gap-lg.product-detail__form__options--underlined',
        '.product-block-container .product-block.product-block-variant-picker:not(.pb-card-shadow)',
        '.product-block-container .product-block.product-block-quantity-selector:not(.pb-card-shadow)',
        '.product-form__quantity',
        '.product-block-item.atc-wrapper',
        '.product__quantity',
        '.product-form product-variants',
        '.tt-swatches-container',
        '.product__quantity',
        '.product-info__quantity-selector',
        'variant-picker',
        'product-page product-variants',
        '.product__variants-wrapper.product__block',
        '.product__controls-group-quantity.product__block',
        '.product-options--root',
        'variant-radios',
        '.quantity_selector',
        '.productView-subtotal',
        '.productView-options',
        'f-variant-picker',
        '[data-product-variants]',
        '.product__controls-group-quanity',
        '.yv-product-quantity'
    ];
    const hideElementWithSelectorFromFourthArray = function (array) {
        array.forEach(el => {
            if(document.querySelector(el) != null){
                document.querySelector(el).style.display = "none";
                document.querySelector(el).classList.add('hide-unwanted-widebundle');
            }
        })
    };
    hideElementWithSelectorFromFourthArray(fourthArrayOfSelectors);

    const fifthArrayOfSelectors = [
        '.product-block .variant-wrapper',
        '.product__info-container variant-radios',
        '.pt-swatches-container.pt-swatches-container-js',
        '.product__info-container variant-selects',
        '.product__info-wrapper variant-selects',
        '.product-page-section variant-selects',
        '.pg__option--single',
        '.product-option-selector'
    ];
    const hideElementWithSelectorFromFifthArray = function (array) {
        array.forEach(el => {
            if(document.querySelector(el) != null){
                for(var i = 0; i<document.querySelectorAll(el).length; i++){
                    document.querySelectorAll(el)[i].style.display = "none";
                    document.querySelectorAll(el)[i].classList.add('hide-unwanted-widebundle');
                }
            }
        })
    }
    hideElementWithSelectorFromFifthArray(fifthArrayOfSelectors);

    const sixthArrayOfSelectors = [
        'fieldset.product-form__input'
    ];
    const hideElementWithSelectorFromSixthArray = function (array) {
        array.forEach(el => {
            if(document.querySelector(el) != null){
                if(!isDescendant(wideBundle.formInfo.element, document.querySelector(el))){
                    document.querySelector(el).style.display = "none";
                    document.querySelector(el).classList.add('hide-unwanted-widebundle');
                }
            }
        })
    }
    hideElementWithSelectorFromSixthArray(sixthArrayOfSelectors);

    const seventhArrayOfSelectors = [
        'button[data-replo-repeated-index][role="button"]',
        'select[data-replo-repeated-index][role="listbox"]'
    ];
    const hideElementWithSelectorFromSeventhArray = function (array) {
        array.forEach(el => {
            elements = document.querySelectorAll(el);
            if(document.querySelector(el) != null){
                if(wideBundle.manualWidget){
                    for(var y = 0 ; y < elements.length; y++){
                        elements[y].style.display = "none";
                        elements[y].classList.add('hide-unwanted-widebundle');
                    }
                }
            }
        })
    }
    hideElementWithSelectorFromSeventhArray(seventhArrayOfSelectors);

    if(wideBundle.manualWidget){
        if(document.querySelector('div[data-pf-type="ProductQuantity"]') != null){
            layouts = document.querySelectorAll('div[data-pf-type="Layout"]');
            for(i=0; i<layouts.length; i++){
                if(isDescendant(layouts[i], wideBundle.manualWidget)){
                    variants = layouts[i].querySelector('div[data-pf-type="ProductQuantity"]');
                    if(variants != null){
                        variants.style.display = "none";
                        variants.classList.add('hide-unwanted-widebundle');
                        break;
                    }
                }
            }
        }
    }
      if(document.querySelector('.product-form__buy-buttons product-payment-container .product-form__add-button') != null){
        document.querySelector('.product-form__buy-buttons product-payment-container').style.visibility = "hidden";
        document.querySelector('.product-form__buy-buttons product-payment-container').style.display = "block";
        document.querySelector('.product-form__buy-buttons product-payment-container').classList.add('hide-unwanted-widebundle');
        addStyleToPage('.product-form__buy-buttons product-payment-container{display: block !important;}');
      }
      if(document.querySelector('.product-single__meta .variant-wrapper--button') != null){
        document.querySelector('.product-single__meta .variant-wrapper--button').style.visibility = "hidden";
        document.querySelector('.product-single__meta .variant-wrapper--button').style.height = "0px";
        document.querySelector('.product-single__meta .variant-wrapper--button').style.width = "0px";
        document.querySelector('.product-single__meta .variant-wrapper--button').classList.add('hide-unwanted-widebundle');
      }

      if(formID == 'form[data-type="add-to-cart-form"].form'){
        style = ".product-form__input{display:none;}"
        addStyleToPage(style);
      }
      var styles = '#product-sticky__btn-sticky-wrapper, .product-sticky__btn-button-container { display: none !important; }';
      addStyleToPage(styles);
}

//Show hidden elements by WideBundle that were inside the form (put out elements)
wideBundle.showElementsFromProductForm = function(){
    addToCartButton = wideBundle.getAddToCartButton();
    variantsSelector = wideBundle.getVariantsSelector();

    //Element's selectors we want to show outside the product form
    var elementsToShow = [
        '.main-product__block-title', '.main-product__block-price', '.main-product__block-custom_liquid', '.main-product__block-collapsible_tab', '.main-product__block-description',
        '.prod_secure_img', '.editor_line_wrap_s_content_below_atc', '.editor_line_wrap_content_below_atc', '#pretty-product-pages', ".product-description-header",
        ".product-page--pricing", ".product-description-wrapper", "#w3-product-accessories", '.product-single__description_page', '.product-block-item .timer_wrapper',
        '.faq-container', '.webyzeProductColorsLabel', '.webyzeProductColors', '#ZlistWishlist', '.product-block-item .under_cta_atc', '.product-meta__description', '.product-meta__text',
        '.shopify-block.shopify-app-block', '.product-single__description', '.collapsibles-wrapper', '.Footer__PaymentListt', '.additional-checkout-text', '#cubynDeliveryBadge', '.product-meta__title',
        'a[href="#looxReviews"]', '.ProductMeta(.ProductMeta__Title)', '.product-block-item(.tabsWrapper)', '.product-block-item(.product-single__desc)', '.size_guide__link_above',
        '.product-block-item(.product-single__title)', '.product-block-item(.product-single__stars)', '.product-block-item(.price-container)', '.slick-testi-product(.testi-review)',
        '.product-information-social-proof','.product-information-text','.product-information-title','.product-information-price',

        '.icon-benefits(.cv-icon-benefit)', 'product__title', 'product__price--holder', 'product__description', '.product__title', '.product__price--holder', '.product__description', 'h2.product-price',
        '.product-description', '.product-tabs', '.product-block-item .product-single__stars', '.product-block-item .product-single__desc',
        'lh-content-title', 'lh-review', 'lh-price-block', 'lh-product-introduce', '.product__title--ppTitle', '.loox-rating', '.product__price--ppPrice', '.product__urgency',
        '.product__countdown--holder', '.short-info', '.ProductMeta__Rating', '.colors-list-wrap .colors-list', '.storeFeatures', '.nm-easyorder-custom-button', '.review-widget', '.htusb-placeholder-countdown', '#alireview-review-widget-badge',
        'product-single__description', '.ProductMeta .ProductMeta__Title', '.ProductMeta .ProductMeta__PriceList', '.ProductMeta .ProductMeta__UnitPriceMeasurement', '.ProductMeta .ProductMeta__TaxNotice', '.ProductMeta__Description',
        '.ProductMeta_Description', 'product-single__description_page', '.product-meta__label-list',".product-details-product-title", ".widereview-rate","#ProductPrice",'.description','.restock-alerts-branding-text','.restock-alerts-notify-button',

        '.icon-benefits(.cv-icon-benefit)', '.product-short-description', '.product-price-container', '.alr-display-review-badge', '.product_title', '.sale-point', '.visitor-counter-content-box-carecartbysalespop-2020',
        '.Footer__PaymentList', '.Product__Tabs(.Collapsible__Content)', '.product-block-item(.fa-box-check)', '.product-block-item(h3)', '.product-page-info__title', '.product-page-info__price', '.product-page-info__reviews','.best-fit-size-chart',
        '#ImageUploaderContainer', '#paypal-button-container', '.price_container .modal_price', "#product-price", '.html-cart(.fa)',
        '.main-product__block.main-product__block-text', '.main-product__block.main-product__block-custom_text', '.main-product__block.main-product__block-shipping', '.main-product__block.main-product__block-short_description',
        'h1#product-title', '.bundle-aggregated_reviews', '#product-description', '.Vtl-SizeChartButtonWrapper', '.vtl-pl-main-widget','.product-block-accordion',
        '.product-price','.title.text-start','.product-tax','.payment-list','#product-delivery-info','.product-block-trust-badges','.jdgm-widget', 'div[class^="countdown_timer_wrapper_"]', '#delivery_timer_wrapper1'
    ];

      var parentsToExcept = ['.cross-sell-block', '.accordion-item'];

    //Show elements if we found add to cart of variants selector
    if(variantsSelector || addToCartButton){
        //Get position of at least one of the elements
        if(variantsSelector?.element[0]?.getBoundingClientRect()?.top > 0){
            elementPosition = variantsSelector.element[0].getBoundingClientRect().top;
        }
        else if(addToCartButton?.element?.getBoundingClientRect()?.top > 0){
            elementPosition = addToCartButton.element.getBoundingClientRect().top;
        }
        //If the elements are visible and we have a position
        if(typeof elementPosition != "undefined" && elementPosition != ""){
            elementsAboveVariants = [];
            elementsBelowVariants = [];

            for(var y=0; y<elementsToShow.length; y++){
                //Check if the element needs to have a specific child to be shown. Specific children are inside parenthesis -> .elem(.child)
                testHasChild = elementsToShow[y].split('(');
                hasChild = "";
                if(testHasChild.length > 1 && !elementsToShow[y].includes(":not")){
                    theElementToShow = testHasChild[0];
                    hasChild = testHasChild[1].split(')')[0];
                }
                else{
                    theElementToShow = elementsToShow[y];
                }
                //Search for the hidden element
                var newNodeToShow = wideBundle.formInfo.element.querySelectorAll(theElementToShow);
                newNodeToShowLength = newNodeToShow.length;
                if(newNodeToShowLength){
                    checkAllElementsFound:
                    for(i=0; i<newNodeToShowLength; i++){
                        console.log(newNodeToShow[i].getBoundingClientRect().top);
                        if(hasChild == "" || (newNodeToShow[i].querySelector(hasChild) != null && !newNodeToShow[i].querySelector(theElementToShow))){
                            //Check if the element is not a child of an exception
                            for(var j=0; j<parentsToExcept.length; j++){
                                var allParentsFound = document.querySelectorAll(parentsToExcept[j]);
                                for(var k=0; k<allParentsFound.length; k++){
                                  var parentToCheck = allParentsFound[k];
                                  if(isDescendant(parentToCheck, newNodeToShow[i])){
                                      continue checkAllElementsFound;
                                  }
                                }
                            }

                            //If hidden element is above the variants selector, add it to the array of elements above variants
                            if(newNodeToShow[i].getBoundingClientRect().top < elementPosition){
                                elementsAboveVariants.push(newNodeToShow[i]);
                            }
                            //If hidden element is below the variants selector, add it to the array of elements below variants
                            else{
                                elementsBelowVariants.push(newNodeToShow[i]);
                            }
                        }
                    }
                }
            }

            //Show hidden elements above or below the product form
            if(elementsAboveVariants.length || elementsBelowVariants.length ){
                elementsAboveVariants.sort(function(a, b) {
                    return a.getBoundingClientRect().top - b.getBoundingClientRect().top;
                });
                elementsBelowVariants.sort(function(a, b) {
                    return b.getBoundingClientRect().top - a.getBoundingClientRect().top;
                });

                var parentDiv = wideBundle.formInfo.element.parentNode;
                for(i=0; i<elementsAboveVariants.length; i++){
                    parentDiv.insertBefore(elementsAboveVariants[i], wideBundle.formInfo.element);
                }
                for(i=0; i<elementsBelowVariants.length; i++){
                    parentDiv.insertBefore(elementsBelowVariants[i], wideBundle.formInfo.element.nextSibling);
                }
            }
        }
    }
}

//Some elements need to be shown and hide using a different method
wideBundle.showAndHideElementsWithInterval = function(){

    if(!wideBundle.formInfo.element){
        return;
    }
    formWide = wideBundle.formInfo.element;

    var newNode1 = formWide.querySelector('.fastlane-faq-a2');
    if(newNode1 != null){
        newNode1 = formWide.querySelector('.fastlane-faq-a2').parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;
        if(newNode1 != null && newNode1.classList.contains('editor_line_wrap_content_below_atc')){
            var parentDiv = formWide.parentNode;
            parentDiv.insertBefore(newNode1, formWide.nextSibling);
        }
    }

    if(wideBundle.formInfo.id == ".ProductForm"){
        var titleNode = formWide.querySelector('.ProductMeta .ProductMeta__Title');
        var priceNode = formWide.querySelector('.ProductMeta .ProductMeta__PriceList');
        var priceUniteNode = formWide.querySelector('.ProductMeta .ProductMeta__UnitPriceMeasurement');
        var taxNode = formWide.querySelector('.ProductMeta .ProductMeta__TaxNotice');
        var availableNode = formWide.querySelector('.ProductForm--Available');
        var descNode = formWide.querySelector('.ProductMeta__Description');

        if(titleNode != null && priceNode != null && priceUniteNode != null){
          var parentDiv = formWide.parentNode;
          priceNode.style.display = "block";
          parentDiv.insertBefore(titleNode, formWide);
          parentDiv.insertBefore(priceNode, formWide);
          parentDiv.insertBefore(priceUniteNode, formWide);
        }

        if(taxNode != null){
            var parentDiv = formWide.parentNode;
            parentDiv.insertBefore(taxNode, formWide);
        }
        if(availableNode != null){
            var parentDiv = formWide.parentNode;
            parentDiv.insertBefore(availableNode, formWide);
        }

        if(descNode != null){
          var parentDiv = formWide.parentNode;
          parentDiv.insertBefore(descNode, formWide.nextSibling);
        }
    }

    //Elements to show that load after WideBundle (addEventListener)
    var SHOW_BEFORE_WB = [
        ".sc-link", ".webyzeProductColors", ".jdgm-preview-badge", '.z-main-product__wrap-title', '.z-main-product__wrap-price-qty-reviews', '.z-main-product__description',
        ".ProductForm--Available2",".product-information-bullet-points"
    ];
    var SHOW_AFTER_WB = [
        ".best-fit-size-chart", "#easysell", "#es-popup-button", "afterpay-placement", ".htusb-ui-prod-boost-trust-wrapper", ".htusb-ui-prod-boost-generic-under-form",
        "._rsi-buy-now-button._rsi-buy-now-button-product", ".pbp-points", ".QuickPurchaseTop", "#ultimateTrustBadgeswidgetDiv",'.sealsubs-target-element:not(.no_move_wb)',
        ".visitor-counter-content-box-carecartbysalespop-2020", '.tempofrete', ".fretefundo", "#sizefox",'.payment-providers', '.cbb-frequently-bought-container'
    ];
    var SHOW_BEFORE_WB_ATC = [
        ".delivery-time", '.product-information-shipping-information',
    ];
    var SHOW_BEFORE_WB_ATC_NOT_FORM = [
        '.axe-checkbox'
    ];
    var SHOW_AFTER_WB_STYLE = [
        "#cpb-button"
    ];

    var DISPLAY_FLEX = [
        ".fretefundo"
    ];
    //Show element if it exists with setInterval iteration to catch it the moment it appears
    loopCount = 0;
    intervalFunction = setInterval(function() {
        if(wideBundle.formInfo.id != "page builder"){
          for(var i=0; i<SHOW_BEFORE_WB.length; i++){
              elementNode = formWide.querySelector(SHOW_BEFORE_WB[i]);
              if(elementNode){
                  var parentDiv = formWide.parentNode;
                  parentDiv.insertBefore(elementNode, formWide);
              }
          }
        }
        for(var i=0; i<SHOW_BEFORE_WB_ATC.length; i++){
            elementNode = formWide.querySelector(SHOW_BEFORE_WB_ATC[i]);
            if(elementNode){
                buttonWB = document.querySelector('.new-form-atc');
                if(buttonWB){
                    buttonWB.parentNode.insertBefore(elementNode, buttonWB);
                    elementNode.style.display = "block";
                }
            }
        }
        for(var i=0; i<SHOW_BEFORE_WB_ATC_NOT_FORM.length; i++){
            elementNode = document.querySelector(SHOW_BEFORE_WB_ATC_NOT_FORM[i]);
            if(elementNode){
                buttonWB = document.querySelector('.new-form-atc');
                if(buttonWB){
                    buttonWB.parentNode.insertBefore(elementNode, buttonWB);
                    elementNode.style.display = "block";
                }
            }
        }
        if(wideBundle.formInfo.id != "page builder"){
            for(var i=0; i<SHOW_AFTER_WB.length; i++){
                elementNode = formWide.querySelector(SHOW_AFTER_WB[i]);
                alreadyDoneElement = document.querySelector(SHOW_AFTER_WB[i]+".moved_wb_element"); //Check if the same element hasn't already been moved
                if(elementNode && !alreadyDoneElement){
                    buttonWB = document.querySelector('.new-form-atc');
                    if(buttonWB.nextSibling){
                        buttonWB.parentNode.insertBefore(elementNode, buttonWB.nextSibling);
                        elementNode.style.display = "block";
                        elementNode.classList.add('moved_wb_element');
                    }
                    else{
                        buttonWB.parentNode.appendChild(elementNode);
                        elementNode.classList.add('moved_wb_element');
                    }
                }
            }
        }
        for(var i=0; i<SHOW_AFTER_WB_STYLE.length; i++){
            elementNode = formWide.querySelector(SHOW_AFTER_WB_STYLE[i]);
            if(elementNode){
                const styles = window.getComputedStyle(elementNode);
                let cssText = styles.cssText;
                if (!cssText) {
                    cssText = Array.from(styles).reduce((str, property) => {
                        return `${str}${property}:${styles.getPropertyValue(property)};`;
                    }, '');
                }
                elementNode.style.cssText = cssText;
                buttonWB = document.querySelector('.new-form-atc');
                if(buttonWB.nextSibling){
                    buttonWB.parentNode.insertBefore(elementNode, buttonWB.nextSibling);
                    elementNode.style.display = "block";
                }
                else{
                    buttonWB.parentNode.appendChild(elementNode);
                }
            }
        }

        for(var i=0; i<DISPLAY_FLEX.length; i++){
            elementNode = document.querySelector(DISPLAY_FLEX[i]);
            if(elementNode){
                elementNode.style.display = "flex";
            }
        }

        //For Dynamic buttons
        if(wideBundle.formInfo.id != "page builder"){
            elementNode = formWide.querySelector('div.shopify-payment-button[data-shopify="payment-button"] div');
            if(elementNode){
                elementNodeParent = formWide.querySelector('div.shopify-payment-button[data-shopify="payment-button"]');
                buttonWB = document.querySelector('.new-form-atc');
                if(buttonWB.nextSibling){
                    buttonWB.parentNode.insertBefore(elementNodeParent, buttonWB.nextSibling);
                    elementNodeParent.style.display = "block";
                }
                else{
                    buttonWB.parentNode.appendChild(elementNodeParent);
                }
            }
        }

        loopCount++;
        if(loopCount >= 50){
            clearInterval(intervalFunction);
        }
    }, 300);



    //Elements to hide that load after WideBundle (addEventListener)
    var elementsToHideWithEventListener = [
        ".product-detail .product-form.theme-init .option-selectors"
    ];
    //Hide element if it exists with setInterval iteration to catch it the moment it appears
    loopCountHide = 0;
    intervalFunctionHide = setInterval(function() {
        elementsToHideWithEventListenerLength = elementsToHideWithEventListener.length;
        for(var y=0; y<elementsToHideWithEventListenerLength; y++){
            elementNodeHide = document.querySelector(elementsToHideWithEventListener[y]);
            if(elementNodeHide){
                elementNodeHide.style.display = "none";
                elementNodeHide.classList.add("hide-unwanted-widebundle");
            }
        }
        loopCountHide++;
        if(loopCountHide >= 50){
            clearInterval(intervalFunctionHide);
        }
    }, 300);
}

//Preselect one offer so one is selected by default
wideBundle.preselectOffer = function(){
    var preselectedOffer = 0; //Check if the user preselected an offer
    for(var i = 0; i<wideBundle.offers.length; i++){
        if(wideBundle.offers[i].preselected == 1){
            preselectedOffer = i;
            break;
        }
    }

    //Check if a variant is in the URL so we use it
    hasVariant = new URLSearchParams(window.location.search.toLowerCase()).get('variant');
    if(hasVariant){
        for(var i = 0; i<wideBundle.offers.length; i++){
            offer = wideBundle.offers[i];
            for(var j = 0; j<offer.variants.length; j++){
                variant = offer.variants[j];
                if(variant.id == hasVariant){
                    preselectedOffer = i;
                    break;
                }
            }
        }
        var offerValues = wideBundle.getOfferValuesForVariant(hasVariant);
    }

    //Add the class to show the offer is selected
    document.querySelectorAll('#new-form .new-form-option')[preselectedOffer].classList.add("selectedWB");
    document.querySelectorAll('#new-form .new-form-option')[preselectedOffer].classList.remove("selectable");
    for(var i=0; i<document.querySelectorAll('.new-wb-form').length; i++){
        var secondaryWidget = document.querySelectorAll('.new-wb-form')[i];
        secondaryWidget.querySelectorAll('.new-form-option')[preselectedOffer].classList.add('selectedWB');
        secondaryWidget.querySelectorAll('.new-form-option')[preselectedOffer].classList.remove('selectable');
    }

    wideBundle.updateMainPrice(); //Update price under the title

    if(hasVariant && offerValues){ //Select the right values on WideBundle based on the variant in the URL
        for(var i = 0; i<offerValues.option1.length; i++){
            // document.querySelectorAll('.selectedWB .select-option-second')[i].value = offerValues.option1[i];
            let j = i + 1;
            let selects = document.querySelectorAll('.selectedWB .select-option-second-' + j);
            selects.forEach(function (element) {
               element.value = offerValues.option1[i];
            });

            // Preselect swatches if any
            let radios = document.querySelectorAll(".selectedWB .swatch-2-radio-" + j + "[value='" + offerValues.option1[i] + "']");
            radios.forEach(function(element) {
                element.checked = true;
            });
        }
        for(var i = 0; i<offerValues.option2.length; i++){
            // document.querySelectorAll('.selectedWB .select-option-third')[i].value = offerValues.option2[i];
            let j = i + 1;
            let selects = document.querySelectorAll('.selectedWB .select-option-third-' + j);
            selects.forEach(function (element) {
                element.value = offerValues.option2[i]
            });

            // Preselect swatches if any
            let radios = document.querySelectorAll(".selectedWB .swatch-3-radio-" + j + "[value='" + offerValues.option2[i] + "']");
            radios.forEach(function(element) {
                element.checked = true;
            });
        }
    }
}

//Create the blinking effect for the custom sentences
wideBundle.addBlinkingEffect = function(){
    if(document.querySelector('.best-title-blink')){
        setInterval(function(){
            for(var wb=0; wb<document.querySelectorAll('.best-title-blink').length; wb++){
                var blinker = document.querySelectorAll('.best-title-blink')[wb];
                if(blinker.style.opacity == 0){
                    blinker.style.opacity = 1;
                }else{
                    blinker.style.opacity = 0;
                }
            }
        }, 800);
    }
}

//Take out apps and complex elements from the form to show them on WideBundle directly such as apps for custom products or subscription or dynamic buttons
wideBundle.takeAppsOut = function(){

  //Function to clone and add inputs in hidden form
  function cloneAndHidePropertiesElements(element) {
    var elementsToDuplicate = document.querySelectorAll(`${element} [name^="properties"]`);
    elementsToDuplicate.forEach((elementToDuplicate) => {
      var newNode = elementToDuplicate.cloneNode();
      newNode.style.display = "none";
      newNode.classList.add('wb-duplicated');
      form.appendChild(newNode);
    });
  }
  //Remove all duplicated elements
  function removeDuplicatedElementsFromForm() {
    const duplicatedElementsInForm = form.querySelectorAll('.wb-duplicated');
    duplicatedElementsInForm.forEach((duplicatedElementInForm) => duplicatedElementInForm.remove());
  }

  if(!wideBundle.manualWidget){
    //For Some Apps
    var elementsToDuplicate = [".uploadkit-injected", ".upload-container", ".gpo-container", ".upload-container", "#textfieldapp"];
    let counterDuplicationWB = 0;
    let functionToUpdateInputs = {};
    var functionToCheckHiddenComplexElement = setInterval(() => {
      if (typeof form !== 'undefined' && form !== null) {
        var widebundle = document.querySelector('#new-form-atc');

        for(var i=0; i<elementsToDuplicate.length; i++){ //For each app to take out
          var elementClass = elementsToDuplicate[i];
          var elementToDuplicate = form.querySelector(elementClass);
          if (widebundle !== null && elementToDuplicate !== null) {
            var extraParent = widebundle.parentNode;
            extraParent.insertBefore(elementToDuplicate, widebundle);
            elementToDuplicate.style.display = "block";
            (function(i){
              functionToUpdateInputs[elementClass] = setInterval(() => { //Duplicate elements we want to put them in the product form
                elementClass = elementsToDuplicate[i];
                removeDuplicatedElementsFromForm();
                cloneAndHidePropertiesElements(elementClass);
              }, 200);
            })(i);
          }
        }

      }
      counterDuplicationWB++;
      if (counterDuplicationWB >= 50) {
        clearInterval(functionToCheckHiddenComplexElement);
      }
    }, 300);

  }

}

//Show an error if the user is using a page builder but not using manual widget placement
wideBundle.handleErrorsPageBuilders = function(){
    //For GemPages
    if(!wideBundle.manualWidget &&
        ((document.querySelector(".gf_row") && document.querySelector('body.gempage') && document.querySelector("div[data-label='Product']")) ||
        (document.querySelector('div[label="Block"]') && document.querySelector('gp-product')))
    ){
        wideBundle.createError("You have to use WideBundle's module from GemPages.", "https://help.widebundle.com/en/article/how-to-use-widebundle-with-gempages-qywl1/#2-3-add-the-widebundle-module")
    }

    //For PageFly
    if(!wideBundle.manualWidget && document.querySelector("div[data-pf-type='Body']") && document.querySelector('[data-pf-type="ProductBox"]') && isDescendant(document.querySelector('[data-pf-type="ProductBox"]'), document.querySelector('#new-form'))){
        wideBundle.createError("You have to use WideBundle's module from PageFly.", "https://help.widebundle.com/en/article/how-to-use-widebundle-with-pagefly-suqsj9/#2-add-the-widebundle-module")
    }
}

//Create a main widget if we only have secondary widgets
wideBundle.transformMainElement = function(){
    // Check if there's no element with the ID 'new-form'
    if (!document.getElementById('new-form')) {
        // Get the first '<widebundle-module>' element
        let widget = document.querySelector('widebundle-module');
        if (widget) {
            // Set the ID to 'new-form'
            widget.id = 'new-form';
        }
    }

    // Add .new-wb-form class to all <widebundle-module> elements except the one with #new-form
    let widgets = document.querySelectorAll('widebundle-module:not(#new-form)');
    widgets.forEach(widget => {
        widget.classList.add('new-wb-form');
    });
}

//Get Variants of the product from Shopify
wideBundle.getVariantsOnShopify = function(){

    //We can then check if ideBundle?.variantsOnShopify exists
    var variantsFromJson = wideBundle.getVariantsFromJson(wideBundle.getSelectedVariantId());
    if(variantsFromJson){
        wideBundle.variantsOnShopify = variantsFromJson;
    }
    else{
        var urlProductAPI = `${window.Shopify.routes.root}products/${wideBundle.currentHandle}.js`;
          fetch(urlProductAPI)
          .then(response => response.json())
          .then(product => {
            wideBundle.variantsOnShopify = product.variants;
          })
          .catch(error => console.error(error));
    }
}
//Create the widget container
wideBundle.createWidgetContainer = function(){
    var container = document.createElement('div');
    container.id = 'new-form';
    var formWB = wideBundle.formInfo.element;
    formWB.parentNode.insertBefore(container, formWB.nextSibling); //We place the container after product form found
    wideBundle.hideOrShowProductForm("hide"); //We hide the product form so it's not duplicated with WideBundle

    setInterval(() => { //We hide the product form with delay for some themes
        if (wideBundle.formVisible === 0) {
            wideBundle.hideOrShowProductForm("hide");
        }
    }, 1000);

    return container; //We return the container we created
}

//Create the offers variable to get the information we have to display
wideBundle.getOffersData = function(data){
    wideBundle.offers = [];
    //Create the offers data
    for(var i = 0; i<data.length; i++){
        variant = data[i];
        var alreadyExists = wideBundle.offers.some(item => item.offer_title === variant.variant_option1);
        if(!alreadyExists){
            let option2Values = [...new Set(data
                .filter(item => item.variant_option1 === variant.variant_option1)
                .map(item => item.variant_option2 === ("" || null) ? [] : item.variant_option2.split(',').map(s => s.trim()))
                .flat()
            )];

            let option3Values = [...new Set(data
                .filter(item => item.variant_option1 === variant.variant_option1)
                .map(item => item.variant_option3 === ("" || null) ? [] : item.variant_option3.split(',').map(s => s.trim()))
                .flat()
            )];

            newOffer = {
                offer_title: variant.variant_option1,
                variants: [],
                message: variant.blinking_text,
                message_effect: variant.blinking_effect,
                message_position: variant.blinking_position,
                unit: variant.unit,
                unit_price: variant.unit_price,
                unit_text: variant.unit_text,
                product_id: variant.product_id,
                options_number: variant.variant_option3 ? 3 : variant.variant_option2 ? 2 : 1,
                offer_position: variant.position_offer,
                enabled: variant.enabled,
                image: variant.image,
                preselected: variant.selected_offer,
                heading: variant.title_option1,
                options_labels: variant.title_option2,
                option1_title: variant.variant_option1_title,
                option2_title: variant.variant_option2_title,
                option3_title: variant.variant_option3_title,
                option2_is_color: variant.variant_option2_is_color,
                option3_is_color: variant.variant_option3_is_color,
                price_in_offer: variant.variant_price,
                dropdowns_amount: variant.variant_option2 ? variant.variant_option2.split(",").length : 0,

                option2_values: [...new Set(data
                    .filter(item => item.variant_option1 === variant.variant_option1)
                    .map(item => item.variant_option2 === ("" || null) ? [] : item.variant_option2.split(',').map(s => s.trim()))
                    .flat()
                )],
                option3_values: [...new Set(data
                    .filter(item => item.variant_option1 === variant.variant_option1)
                    .map(item => item.variant_option3 === ("" || null) ? [] : item.variant_option3.split(',').map(s => s.trim()))
                    .flat()
                )],
                options_color_values: variant.options_color_values ? variant.options_color_values : []

            }
            wideBundle.offers.push(newOffer);
        }
        for (let y = 0; y < wideBundle.offers.length; y++) { //Add the variants of the offers
            if (wideBundle.offers[y].offer_title === variant.variant_option1) {
                var variantId = variant.variant_id;
                var pricesFound = wideBundle.getPricesFromJson(variantId);
                newVariant = {
                    id: variantId,
                    price: pricesFound ? pricesFound.price : wideBundle.formatPrice(variant.variant_price),
                    compare_at_price: pricesFound ? pricesFound.compare_at_price : wideBundle.formatPrice(variant.variant_compared),
                    option1: variant.variant_option1,
                    option2: variant.variant_option2,
                    option3: variant.variant_option3,
                    conversion_rate: variant.variant_price/wideBundle.getAmountFromPrice(pricesFound ? pricesFound.price : wideBundle.formatPrice(variant.variant_price)),
                };
                wideBundle.offers[y].variants.push(newVariant);
            }
        }
        wideBundle.heading = wideBundle.offers[0].heading; //We'll need the heading in global scope
    }
}

//Hide the product form or show it (action = "hide" or action = "show")
wideBundle.hideOrShowProductForm = function(action = "hide"){
    var cssProperties = {
        "width": action === "hide" ? "1px" : "auto",
        "height": action === "hide" ? "0px" : "auto",
        "overflow": action === "hide" ? "hidden" : "visible",
        "margin": action === "hide" ? "0px" : "auto",
        "marginTop": action === "hide" ? "0px" : "auto",
        "marginBottom": action === "hide" ? "0px" : "auto",
        "paddingTop": action === "hide" ? "0px" : "auto",
        "paddingBottom": action === "hide" ? "0px" : "auto"
      };
      //"display": action === "show" ? "block" : "none"

    var formWB = wideBundle.formInfo.element;
    for (var property in cssProperties) {
        formWB.style[property] = cssProperties[property];
    }

    wideBundle.formVisible = action === "show" ? 1 : 0;
    var displayValue = action === "show" ? "block" : "none";
    document.querySelectorAll('.hide-unwanted-widebundle').forEach(element => element.style.display = displayValue);
}
showFormWB = function(){
    wideBundle.hideOrShowProductForm("show");
}

//Create the content inside the widget container
wideBundle.createWidgetContent = function(widgetContainer){
    wideBundle.createHeading(widgetContainer); //Create the heading above the widget
    for(var i = 0; i<wideBundle.offers.length; i++){ //Create each offer in the widget
        var offer = wideBundle.offers[i];
        offerContainer = wideBundle.createOfferContainer(widgetContainer, offer); //Create the container
        offerContentLeft = wideBundle.createOfferContentLeft(offerContainer, offer); //Create the content left
        offerContentRight = wideBundle.createOfferContentRight(offerContainer, offer); //Create the content right
        widgetContainer.appendChild(offerContainer);
    }
    wideBundle.addCodeBeforeOrAfterButton(widgetContainer, "before"); //Add html code before the button if the user added some
    wideBundle.createAddToCartButton(widgetContainer); //Create the add to cart button
    wideBundle.createTrustBadges(widgetContainer); //Create the add to cart button
    wideBundle.addCodeBeforeOrAfterButton(widgetContainer, "after"); //Add html code after the button if the user added some
    document.body.click();
}

//Add Trust badges image if the user added one
wideBundle.createTrustBadges = function(widgetContainer){
    if(wideBundle.settings.trustbadge != '' && wideBundle.settings.trustbadge != null){ //If they added an image url in the settings to show it below widebundle
        trustBadgeContainer = document.createElement('div');
        if(widgetContainer.hasAttribute('id')) {
            trustBadgeContainer.id = 'cont-trustbadge-wb';
        }
        trustBadgeContainer.classList.add('cont-trustbadge-wb');
        trustBadgeImg = document.createElement('img');
        trustBadgeImg.setAttribute('src', wideBundle.settings.trustbadge);
        trustBadgeContainer.appendChild(trustBadgeImg);
        widgetContainer.appendChild(trustBadgeContainer);
    }
}

//Create the add to cart button for WideBundle
wideBundle.createAddToCartButton = function(widgetContainer){
    var buttonAtc = document.createElement('div'); //Create the element
    buttonAtc.innerHTML = AddSVG()+wideBundle.settings.atc_text;
    buttonAtc.setAttribute('data-add-to-cart', '');
    if(widgetContainer.hasAttribute('id')){ //Add an id if we're on the main widget
        buttonAtc.id = "new-form-atc";
    }
    buttonAtc.classList.add('new-form-atc', 'addCart');

    buttonAtc.addEventListener("click", wideBundle.addToCart); //Add the event listener to add the offer to the cart

    widgetContainer.appendChild(buttonAtc); //Add the button to the container

    wideBundle.copyAddToCartDesign(buttonAtc); //If the user enabled the feature to automatically copy the design of the add-to-cart button of the theme

    if(wideBundle.settings.atc_animation == 'shaking'){ //If they added the settings to make the add to cart button shake
        var headWB = document.getElementsByTagName('head')[0],
        styleWB = document.createElement('style'),
        animName = 'shakeWB',
        rulesWB = document.createTextNode('@-webkit-keyframes ' + animName + '{ 0% { transform:translate(0,0);-webkit-transform:translate(0,0) } 2% { transform:translate(5px,0) scale(1.05);-webkit-transform:translate(5px,0) scale(1.05)} 4% { transform:translate(0,0) scale(1.1);-webkit-transform:translate(0,0) scale(1.1) } 6% { transform:translate(5px,0) scale(1.05);-webkit-transform:translate(5px,0) scale(1.05) } 8% { transform:translate(0,0) scale(1);-webkit-transform:translate(0,0)  scale(1)} 10% { transform:translate(5px,0);-webkit-transform:translate(5px,0) } 12% { transform:translate(0,0);-webkit-transform:translate(0,0) } 100% { transform:translate(0,0);-webkit-transform:translate(0,0) } } #new-form-atc{ -webkit-animation: '+animName+' 4s ease infinite; }');
        styleWB.type = 'text/css';
        if(styleWB.styleSheet)
            styleWB.styleSheet.cssText = rulesWB.nodeValue;
        else styleWB.appendChild(rulesWB);
        headWB.appendChild(styleWB);
        window.addEventListener('load', animateButton, false);
        function animateButton(){
          if(document.querySelector('#new-form-atc') != null){
            document.querySelector('#new-form-atc').style.webkitAnimationName = animName;
          }
          for(var i=0; i<document.querySelectorAll('.new-form-atc').length; i++){
            document.querySelectorAll('.new-form-atc')[i].style.webkitAnimationName = animName;
          }
        }
      }
}

wideBundle.copyAddToCartDesign = function(buttonAtc){
    let addToCartButtonOfTheme = wideBundle.getAddToCartButton();
    if(addToCartButtonOfTheme){
        //copyStyle(addToCartButtonOfTheme.element, buttonAtc);
    }
}

//Add HTML code before the Add to Cart button
wideBundle.addCodeBeforeOrAfterButton = function(widgetContainer, position = "before"){
    position == "before" ? content = wideBundle.settings.before_code : content = wideBundle.settings.after_code;

    if(content != ''){ //Add html code before or after button if the user added some
        CodeContainer = document.createElement('div');
        CodeContainer.innerHTML = content;
        CodeContainer.classList.add(`${position}-code-wb`);
        widgetContainer.appendChild(CodeContainer);
    }
}

//Add Hidden Prices so we can use them for conversion currency apps
wideBundle.addHiddenPrices = function(){
    var divHiddenPrices = document.createElement("div");
    divHiddenPrices.classList.add("wb_hidden_prices");
    divHiddenPrices.innerHTML = "";
    divHiddenPrices.style.display = "none";
    for (var i = 0; i < wideBundle.offers.length; i++) {
        var variants = wideBundle.offers[i].variants;
        for (var j = 0; j < variants.length; j++) {
            variant = variants[j];
            variant.compare_at_price = parseFloat(wideBundle.getAmountFromPrice(variant.price)) >= parseFloat(wideBundle.getAmountFromPrice(variant.compare_at_price)) ? "" : variant.compare_at_price
            divHiddenPrices.innerHTML += `
                <p class="wb_hidden_prices_element">
                    <span class="wb_hidden_price notranslate money conversion-bear-money  transcy-money" variant-id="${variant.id}">${wideBundle.removeDecimal(wideBundle.updatePriceSeparator(variant.price))}</span>
                    <span class="wb_hidden_compared_price notranslate money conversion-bear-money transcy-money" variant-id="${variant.id}">${wideBundle.removeDecimal(wideBundle.updatePriceSeparator(variant.compare_at_price))}</span>
                </p>
            `;
        }
    }

    wideBundle.widgetContainers[0].appendChild(divHiddenPrices); //Add hidden prices to first container
}

//Create the heading above the widget
wideBundle.createHeading = function(widgetContainer){
    var heading = document.createElement('p');
    heading.classList.add('p-title-WB');
    if(widgetContainer.hasAttribute('id')) {
        heading.innerHTML = "<span id='title-offer-WB' class='p-title-WB__content'>"+wideBundle.heading+"</span>";
    } else {
        heading.innerHTML = "<span class='p-title-WB__content'>"+wideBundle.heading+"</span>";
    }

    if(wideBundle.settings.design_code == 4){
        heading.innerHTML += "<span class='p-title-WB__arrow'></span>";
    }
    
    widgetContainer.appendChild(heading);
}

//Create the offer container
wideBundle.createOfferContainer = function(widgetContainer, offer){
    var offerContainer = document.createElement('div');
    if(widgetContainer.hasAttribute('id')){
        offerContainer.id = "id" + offer.variants[0].id
    }
    offerContainer.classList.add('selectable'); //Add the class for unselected offers
    offerContainer.classList.add('new-form-option');
    offerContainer.setAttribute('data-id', offer.variants[0].id);
    offerContainer.addEventListener("click", wideBundle.changeSelectedOffer); //Add the click event to detect when we select the offer

    return offerContainer;
}

//Create the content on the left of the offer
wideBundle.createOfferContentLeft = function(offerContainer, offer){
    var contentLeft = document.createElement('div');
    contentLeft.classList.add('value-left');

    var roundCheckbox = document.createElement('span'); //Create the circle checkbox
    roundCheckbox.classList.add('checkedWB');
    contentLeft.append(roundCheckbox);

    if(offer.image != '' && offer.image != null){ //Add thumbnail if it exists
        var thumbnail = document.createElement('img');
        thumbnail.classList.add('thumbnailWB');
        contentLeft.classList.add('offer-image');
        thumbnail.setAttribute('src', offer.image);
        thumbnail.setAttribute('alt', "");
        contentLeft.append(thumbnail);
    }

    offerContainer.appendChild(contentLeft);
}

//Create the contnet on the right of the offer
wideBundle.createOfferContentRight = function(offerContainer, offer){
    var contentRight = document.createElement('div');
    contentRight.classList.add('value-right');
    offerContainer.appendChild(contentRight);

    titleOffer = document.createElement('p'); //Create the title of the offer
    titleOffer.classList.add('title-variant');
    titleOffer.innerHTML = offer.offer_title;

    var priceElement = document.createElement('p'); //Create the price of the offer;
    priceElement.classList.add('price-new-form');

    variantId = offer.variants[0].id; //We create the prices of the offer
    var price = document.querySelector(`.wb_hidden_prices .wb_hidden_price[variant-id="${variantId}"]`).innerHTML;
    var compareAtPrice = document.querySelector(`.wb_hidden_prices .wb_hidden_compared_price[variant-id="${variantId}"]`).innerHTML;
    var priceHtml = `
        <span class='first-price-WB notranslate money conversion-bear-money transcy-money'>${price}</span>
        <span class='second-price-WB notranslate ${compareAtPrice != "" ? "money transcy-money" : ""} conversion-bear-money'><s class="crossed-price-WB">${compareAtPrice}</s></span>
    `;
    priceElement.innerHTML = priceHtml;


    

    if(offer.unit == 1 && wideBundle.settings.plan !== "monthly") {
        var crMarkets = offer.variants[0].conversion_rate
        var crOffer = offer.unit_price / offer.price_in_offer ;
        var unit_price_markets = offer.unit_price / crMarkets;
        
        var unitElement = document.createElement('p'); //Create the price of the offer;
        unitElement.classList.add('first-unit-WB');

        var unitHtml = `
        <span class='wb_unit_price'>${ wideBundle.removeDecimal(wideBundle.updatePriceSeparator(wideBundle.formatPriceForUnit(unit_price_markets)))}</span>
        <span class='wb_unit_text'>${offer.unit_text}</span>
        `;

        priceElement.setAttribute("data_offer_cr", crOffer);

        unitElement.innerHTML = unitHtml;
        priceElement.classList.add('hidden-unit');
    }

    wideBundle.createQuantityWidget(offerContainer); //We create the quantity widget if they enabled it in the settings

    if(isJsonString(offer.message) && offer.message !== null){
        messageText = JSON.parse(offer.message);
    }
    else{
        messageText = offer.message ? [offer.message] : [""];
    }

    messageEffect = offer.message_effect ? offer.message_effect.split(",") : [""]; //Get message effect
    messagePosition = offer.message_position ? offer.message_position.split(",") : [""]; //Get message position
    
    messagesToDisplay = wideBundle.settings.plan == 'monthly' ? 1 : messageText.length;

    for(var i = 0; i<messagesToDisplay; i++){//For each custom message
        if((messagePosition[i] == 0 && messageEffect[i] < 2) || (messagePosition[i] > 1 && wideBundle.settings.plan == 'monthly')){ //Add the message before title if it exists
            wideBundle.createCustomSentence(messageText[i], messageEffect[i], contentRight, offerContainer);
        }
    }

    contentRight.appendChild(titleOffer); //Add the title of the offer
    contentRight.appendChild(priceElement); //Add the price of the offer
    if(offer.unit == 1 && wideBundle.settings.plan !== "monthly") {
        contentRight.appendChild(unitElement); //Add the price of the offer
    }

    for(var i = 0; i<messagesToDisplay; i++){//For each custom message
        if(messagePosition[i] == 1){ //Add the message after title if it exists
            wideBundle.createCustomSentence(messageText[i], messageEffect[i], contentRight, offerContainer);
        }
        
        if(wideBundle.settings.plan !== 'monthly'){
            if(messagePosition[i] == 2){ 
                var ribbon = document.createElement('div');
                ribbon.classList.add('corner-offer');
                ribbon.innerHTML = messageText[i];

                offerContainer.appendChild(ribbon);
                offerContainer.classList.add('corner-offer-container')
            }
            else if(messagePosition[i] == 3){ 
                offerContainer.classList.add('diagonal-offer');
                offerContainer.style.setProperty('--message', `'${messageText[i]}'`);
            }
        }
    }

    wideBundle.createSavingText(offer, contentRight, offerContainer); //Display the saving text if it's enabled
    wideBundle.createOptionSelectors(offer, contentRight); //Create the option selectors if they have some
}
function formatQuotes(text) {
    return text.split('"').join('&quot;').split("'").join('&#39;');
}

//Create options selectors if the product has 1 or 2 options (color and size for example)
wideBundle.createOptionSelectors = function(offer, contentRight){
    optionsLabels = offer.options_labels ? offer.options_labels.split(",") : [""]; //Get option labels
    swatchId = Math.floor(Math.random()*898)+101;
    for(var i = 0; i<offer.dropdowns_amount; i++){ //For each selector row
        j = i+1;
        var selectContainer = document.createElement('div');
        selectContainer.id = `div-second-select-${offer.variants[0].id}-${i}`;
        selectContainer.classList.add(`div-second-select-${offer.variants[0].id}-${i}`, `div-select2`);
        if(wideBundle.settings.plan !== "monthly" && (offer.option3_is_color === "1" || offer.option2_is_color === "1")) {
            selectContainer.classList.add('wb-swatch-container');
        }
        selectContainer.setAttribute('data-id', offer.variants[0].id);

        if(offer.options_number == 3){ //If we have a 3rd option we add the <select> for this option with the options values
            selectContainer.classList.add('has-double-select');

            var selectForThirdOptionHtml = `<select
                class='${offer.option3_values.length <= 1 ? "hide-bloc-wb" : ""} select-bundle select-class-second select-option-third select-option-third-${j} add-option3-${offer.variants[0].id}-${j} ${offer.option3_is_color === "1" && wideBundle.settings.plan !== "monthly" ? 'swatch-3-select' : ''}'
                ${offer.option3_is_color === "1" && wideBundle.settings.plan !== "monthly" ? `id="swatch-3-select-` + swatchId + `-` + j + `"` : ''}
                onchange='wideBundle.updatePricesInOffer();wideBundle.updateSelectsInOffers(this);wideBundle.updateProductForm();wideBundle.updateQuantityDisabled();'
                name='Variants2' size='1'
            >`;
            for(var k = 0; k<offer.option3_values.length; k++){
                var value = offer.option3_values[k];
                selectForThirdOptionHtml +=  `<option value="` + formatQuotes(value) +`">${value}</option>`;
            }
            selectForThirdOptionHtml += `</select>`;

            if(offer.option3_is_color === "1" && wideBundle.settings.plan !== "monthly") {
                selectForThirdOptionHtml += `<div class="wb-color-swatch-box">`;
                for(var k = 0; k<offer.option3_values.length; k++){
                    var color_hex = offer.options_color_values[offer.option3_values[k]];
                    var style = /^#(?:[0-9a-f]{3}){1,2}$/i.test(color_hex) ? `background-color: ${color_hex}` : `background-image: url(${color_hex})`;

                    selectForThirdOptionHtml +=  `<label class="wb-color-swatch">
                            <input type="radio" name="Variants3Swatch-${swatchId}-${j}"
                                class="swatch-3-radio swatch-3-radio-${j}"
                                data-variantId="3"
                                data-swatchId="${swatchId}"
                                data-dropdownId="${j}"
                                value="${offer.option3_values[k]}"
                                ${(k === 0 ? `checked="checked"` : ``)}
                                onchange="wideBundle.mergeSwatch(this)"
                            />
                            <div class="wb-color-swatch-radio" title="${offer.option3_values[k]}" style="${style}"></div>
                        </label>`;
                }
                selectForThirdOptionHtml += `</div>`;
            }
        }
        else{
            var selectForThirdOptionHtml = '';
        }
        //Add the select for the 2nd option with the options values
        var selectForSecondOptionHtml = `<p class='title-option-wb'>${optionsLabels[i]}</p>`;

        selectForSecondOptionHtml += `<select
            class='${offer.option2_values.length <= 1 ? "hide-bloc-wb" : ""} select-bundle select-class-second select-option-second select-option-second-${j} add-option-${offer.variants[0].id}-${j} ${offer.option2_is_color === "1" && wideBundle.settings.plan !== "monthly" ? 'swatch-2-select' : ''}'
            ${offer.option2_is_color === "1" && wideBundle.settings.plan !== "monthly" ? `id="swatch-2-select-` + swatchId + `-` + j + `"` : ''}
            onchange='wideBundle.updatePricesInOffer();wideBundle.updateSelectsInOffers(this);wideBundle.updateProductForm();wideBundle.updateQuantityDisabled();' name='Variants' size='1'
        >`;
        for (var k = 0; k < offer.option2_values.length; k++) {
            var value = offer.option2_values[k];
            selectForSecondOptionHtml += `<option value="` + formatQuotes(value) + `">${value}</option>`;
        }
        selectForSecondOptionHtml += `</select>`;
        if(offer.option2_is_color === "1" && wideBundle.settings.plan !== "monthly") {
            selectForSecondOptionHtml += `<div class="wb-color-swatch-box">`;
            for (var k = 0; k < offer.option2_values.length; k++) {
                var color_hex = offer.options_color_values[offer.option2_values[k]];
                var style = /^#(?:[0-9a-f]{3}){1,2}$/i.test(color_hex) ? `background-color: ${color_hex}` : `background-image: url(${color_hex})`;

                selectForSecondOptionHtml +=  `<label class="wb-color-swatch">
                            <input type="radio" name="Variants2Swatch-${swatchId}-${j}"
                                class="swatch-2-radio swatch-2-radio-${j}"
                                data-variantId="2"
                                data-swatchId="${swatchId}"
                                data-dropdownId="${j}"
                                value="${offer.option2_values[k]}"
                                ${(k === 0 ? `checked="checked"` : ``)}
                                onchange="wideBundle.mergeSwatch(this)"
                            />
                            <div class="wb-color-swatch-radio" title="${offer.option2_values[k]}" style="${style}"></div>
                        </label>`;
            }
            selectForSecondOptionHtml += `</div>`;
        }
        selectForSecondOptionHtml += `${selectForThirdOptionHtml}<p class="clear"></p>`;
        selectContainer.innerHTML = selectForSecondOptionHtml;

        //Hide the <selects> container if there is 1 option value or less for both options
        if(offer.option2_values.length <= 1 && offer.option3_values.length <= 1){
            selectContainer.classList.add('hide-bloc-wb');
        }

        contentRight.appendChild(selectContainer);
    }
}

//Display the saving text if it's enabled
wideBundle.createSavingText = function(offer, contentRight, offerContainer){
    if(wideBundle.settings.economic_display == 1 && offer.variants[0].compare_at_price != ""){
        var price = document.querySelector(`.wb_hidden_prices .wb_hidden_price[variant-id="${offer.variants[0].id}"]`).innerHTML;
        var compareAtPrice = document.querySelector(`.wb_hidden_prices .wb_hidden_compared_price[variant-id="${offer.variants[0].id}"]`).innerHTML;
        difference = getAmountDifference(price, compareAtPrice);

        if(wideBundle.settings.no_decimal == 1){ //If they enabled the feature to remove decimal
            difference.amount = parseFloat(difference.amount);
        }

        var currencyAlone = price.replace(/\d+.\d+/g,'{{amount}}').replace(/\d+/g,'{{amount}}')
        var priceDifference = wideBundle.updatePriceSeparator(currencyAlone.replace('{{amount}}', difference.amount));

        var savingTextContent = wideBundle.settings.economic_text;
        savingTextContent = savingTextContent.replace("{{percent}}", `<span class='percent-wb'>${difference.percent}</span>`);
        savingTextContent = savingTextContent.replace("{{amount}}", `<span class='money conversion-bear-money span-economic-wb transcy-money'>${wideBundle.updatePriceSeparator(priceDifference)}</span>`);

        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        today = dd + '/' + mm + '/' + yyyy;
        savingTextContent = savingTextContent.replace('{{today}}', today);

        var savingText = document.createElement('p');
        savingText.innerHTML = savingTextContent;
        savingText.classList.add('economic-wb');
        contentRight.appendChild(savingText);
        offerContainer.classList.add('with-economic-text');
    }
}

//Create a custom sentence if the user added one
wideBundle.createCustomSentence = function(message, effect, contentRight){
    if(message){
        customSentence = document.createElement('span');
        customSentence.classList.add('best-title', 'best-title-new');

        customSentence.innerHTML = message;
        if(effect == 1){ //If blinking enabled
            customSentence.classList.add('best-title-blink');
        }
        contentRight.classList.add('with-message');
        contentRight.appendChild(customSentence);
    }
}

//Add the quantity widget if it's enabled
wideBundle.createQuantityWidget = function(offerContainer){
    if(wideBundle.settings.display_quantity == 1){
        var quantityContainer = document.createElement('div');
        quantityContainer.classList.add('spinWB');
        quantityHTML = `
            <span class='quantity-wb-less'>&ndash;</span>
            <input class='quantity-wb-input' id='quantity-wb' value='1' />
            <span class='quantity-wb-more'>+</span>
        `;
        quantityContainer.innerHTML = quantityHTML;
        offerContainer.append(quantityContainer);

        //Add the event listeners
        quantityContainer.querySelector('.quantity-wb-less').addEventListener('click', function(){
            var value = Math.max(1, document.querySelector('.selectedWB .quantity-wb-input').value -1);
            wideBundle.updateQuantityInputs(value);
            wideBundle.updateQuantityDisabled(value);
        });
        quantityContainer.querySelector('.quantity-wb-more').addEventListener('click', function(){
            var value = Math.max(1, parseInt(document.querySelector('.selectedWB .quantity-wb-input').value)+1);
            wideBundle.updateQuantityInputs(value);
            wideBundle.updateQuantityDisabled(value);
        });
        offerContainer.querySelector('.quantity-wb-input').addEventListener('change', function(){
            if(isNaN(this.value.replace(',', '.'))){
                wideBundle.updateQuantityInputs(1);
                wideBundle.updateQuantityDisabled(1);
            }
            else{
                wideBundle.updateQuantityInputs(Math.round(this.value.replace(',', '.')));
                wideBundle.updateQuantityDisabled(Math.round(this.value.replace(',', '.')));
            }
        });
    }
}

//Update the quantity inputs values in the page
wideBundle.updateQuantityInputs = function(value){
    //For quantity inputs in the offers
    var quantityInputs = document.querySelectorAll('.quantity-wb-input');
    for(var i = 0; i<quantityInputs.length; i++){
        quantityInputs[i].value = value;
    }

    let inputUpdated = 0;

    //For quantity inputs in the product page
    var quantityInputsArray = ['[name="quantity"]', 'select[data-quantity-select]',
    'div[data-pf-type="Layout"] div[data-pf-type="ProductQuantity"] input', '.gf_product-quantity input[name="quantity"]', "gp-product-quantity input[name='product-quantity']"];
    for(var i = 0; i<quantityInputsArray.length; i++){
        if(wideBundle.formInfo.element){
            var quantityInput = wideBundle.formInfo.element.querySelector(quantityInputsArray[i]);
            if(quantityInput){
                quantityInput.value = value;
                inputUpdated = 1;
            }
        }
    }
    if(!inputUpdated){
      for(var i = 0; i<quantityInputsArray.length; i++){
          var quantityInput = document.querySelector(quantityInputsArray[i]);
          if(quantityInput){
              quantityInput.value = value;
              inputUpdated = 1;
          }
      }
    }
}

//Update the selects in all the WideBundle widgets to change the selected values
wideBundle.updateSelectsInOffers = function(elementUpdated){
  var valueOfElement = elementUpdated.value;
  var classSelectors = Array.from(elementUpdated.classList);
  var classOfElement = '.' + classSelectors.join('.');

  for(var i=0; i<document.querySelectorAll(classOfElement).length; i++){ //Update all the selects with this class
    document.querySelectorAll(classOfElement)[i].value = valueOfElement;
  }
}

//Add the button that redirects to the checkout so we can click on it
wideBundle.addLinkToCheckout = function(){
    var checkoutLink = document.createElement('a');
    checkoutLink.id = "checkout-xx-aa";
    checkoutLink.href = getShopifyBaseUrl() + 'checkout';

    //Handle redirection if Transcy enabled
    if (typeof _transcy !== 'undefined' &&
        typeof _transcy.variants.localeCurrent !== 'undefined' &&
        typeof _transcy.variants.localeDefault !== 'undefined' &&
        _transcy.variants.localeCurrent !== _transcy.variants.localeDefault &&
        _transcy.variants.localeDefault !== '') {
            checkoutLink.href = `/${_transcy.variants.localeCurrent}/checkout`;
    }

    //Handle redirection if Weglot enabled
    if (typeof Weglot !== 'undefined' &&
        typeof Weglot.getCurrentLang() !== 'undefined' &&
        Weglot.getCurrentLang() !== '') {
            checkoutLink.href = `/checkout?locale=${Weglot.getCurrentLang()}`;
    }

    checkoutLink.innerHTML = 'checkout';
    document.body.append(checkoutLink);
}

//Regenerate WideBundle Widget if the theme replaced WideBundle
wideBundle.regenerateWideBundle = function(){
    if(typeof Shopify != "undefined"){
        var currentWidgetCreated = document.querySelector('#new-form');
        var intervalCheckingWidgetCount = 0;
        var checkCurrentWidget = setInterval(function(){ //Check for 8 seconds if the widget has been replaced
            if(typeof currentWidgetCreated !== "undefined" && currentWidgetCreated){
                newWidgetChecked = document.querySelector('#new-form');
                if(!currentWidgetCreated.isSameNode(newWidgetChecked)){ //If the widget has been replaced
                    currentWidgetCreated.remove();
                    wideBundle.init(wideBundle.data);
                    clearInterval(checkCurrentWidget);
                }
            }
            intervalCheckingWidgetCount++;
            if(intervalCheckingWidgetCount >= 40){
                clearInterval(checkCurrentWidget);
            }
        }, 200);
    }
}

//Add the product to the cart (function called immediately after the click on the button)
wideBundle.addToCart = function(){

    //Add the loading gif
    wideBundle.displayLoadingOnATC();

    wideBundle.showErrorIfNonExistingVariant(); //Show error if the variant doesn't exist on Shopify

    console.log('clicked on the button');
    //Get currency name
    currencyName = typeof window.ShopifyAnalytics !== "undefined"
        ? window.ShopifyAnalytics.meta.currency
        : typeof window.Shopify.currency !== "undefined"
            ? Shopify.currency.active
            : wideBundle.setting.currency_code;

    //Get infos about the variant to add
    var selectedVariantId = wideBundle.getSelectedVariantId();
    var quantityVariant = document.querySelector('.selectedWB .quantity-wb-input');
    var quantityVariantValue = quantityVariant ? quantityVariant.value : 1;
    var itemsToAddToCart = {items: [{quantity: quantityVariantValue, id: selectedVariantId}]};

    const atcButtons = Array.from(document.querySelectorAll('.new-form-atc'));
    //Disable click
    atcButtons.forEach(function (atcButton) {
        atcButton.style.pointerEvents = 'none';
    });

    wideBundle.updateQuantityDisabled().then(function (continueAddToCart) {
        if (!continueAddToCart) {
            return;
        }

        if(wideBundle.settings.link_choice == "form"){ //If the user selected "side cart" redirection
            wideBundle.showErrorIfSideCart(); //Show error if the user didn't add add-to-cart button and variants selector

            wideBundle.updateVariantIdSelector(selectedVariantId); //Update the <select> in the form with name = id
            wideBundle.manageEcomSolidSideCart(itemsToAddToCart); //Open Ecom Solid Side Cart
            wideBundle.handleUploadApps(); //Handle upload apps (like Uploadlift) so we can send the file to the cart
            var addToCartButton = wideBundle.getAddToCartButton();
            if(addToCartButton){
                document.body.click();
                if(addToCartButton.element.disabled){
                    addToCartButton.element.disabled = false;
                }
                addToCartButton.element.click();
                wideBundle.handleSlideCartApp; //Open slide cart app
                //Put back WideBundle button text
                wideBundle.removeLoadingOnATC();
            }
        }
        else{ //If the user selected "checkout" or "cart" redirection
            var redirectionUrl = getShopifyBaseUrl() + wideBundle.settings.link_choice;
            wideBundle.managePixels(currencyName); //Manage pixels (Facebook, Google, etc)
            wideBundle.addToCartAjax(itemsToAddToCart)
                .then(function(responseText) {
    
                    //Manage an upsell app to open the app after the product was added to the cart
                    if(typeof initiateRaidFunnelByVariant !== 'undefined'){
                        if(initiateRaidFunnelByVariant(selectedVariantId) == true){
                          return;
                        }
                    }
                    //Manage an upsell app to open the app after the product was added to the cart
                    else if(typeof app !== 'undefined' && typeof app.showModal !== 'undefined'){
                        app.showModal = true;
                        app.configs[0].value=app.getThemeQuantity();
                        app.isCart=false;
                        //Put back WideBundle button text
                        wideBundle.removeLoadingOnATC();
                    }
                    //If the user redirects to checkout
                    else if(wideBundle.settings.link_choice == "checkout"){
                        if(document.querySelector('#checkout-xx-aa')){
                            document.body.click(); //Manage the double click problem on some themes
                            document.querySelector('#checkout-xx-aa').click();
    
                            //Put back WideBundle button text
                            wideBundle.removeLoadingOnATC();
                        }
                    }
                    //If the user redirects to cart
                    else if(wideBundle.settings.link_choice == "cart"){
                        if (typeof _transcy !== 'undefined' &&
                            typeof _transcy.variants.localeCurrent !== 'undefined' &&
                            typeof _transcy.variants.localeDefault !== 'undefined' &&
                            _transcy.variants.localeCurrent !== _transcy.variants.localeDefault &&
                            _transcy.variants.localeDefault !== '') {
                                credirectionUrl = `/${_transcy.variants.localeCurrent}/cart`;
                        }
                        //Put back WideBundle button text
                        wideBundle.removeLoadingOnATC();
                        window.location = redirectionUrl;
                    }
    
                    return Promise.resolve();
                })
                .catch(function(error) {
                    console.error(error);
                    return Promise.reject(error);
                });
        }
    });
}

wideBundle.updateQuantityDisabled = async function(quantity = 1) {
    if (Number(wideBundle.settings.enable_atc_button) !== 1) {
        return true;
    }

    try {
        wideBundle.displayLoadingOnATC();
        const selectedVariantId = wideBundle.getSelectedVariantId();
        const atcButtons = Array.from(document.querySelectorAll('.new-form-atc'));

        const response = await window.originalFetch(wideBundle.domain + 'storefront/getvariantinventory?id=' + selectedVariantId, { mode: 'cors' });
        const data = await response.json();

        // Revert original buttons state
        atcButtons.forEach(function (atcButton) {
            atcButton.classList.remove('new-form-atc--out-of-stock');
            atcButton.innerHTML = AddSVG()+wideBundle.settings.atc_text;
            atcButton.style.pointerEvents = 'auto';
        });

        if (data === false) {
            return false;
        }

        let enableButton = Number(data.add_to_cart_btn_enable) === 1;
        let continueSelling = true;
        if (Number(quantity) > 1 && Number(quantity) > Number(data.inventory_quantity)) {
            continueSelling = false;
        }

        if (enableButton && continueSelling) {
            return true;
        } else {
            atcButtons.forEach(function (atcButton) {
                atcButton.classList.add('new-form-atc--out-of-stock');
                atcButton.innerHTML = wideBundle.settings.atc_content_text;
                atcButton.style.pointerEvents = 'none';
            });

            return false;
        }
    } catch (error) {
        console.error(error);
        return false;
    }
}

//Open the side cart of the app Slide Cart
wideBundle.handleSlideCartApp = function(){
    try{
        if(typeof window.SLIDECART_UPDATE != "undefined"){
          setTimeout(() => {
            if(!window.SLIDECART_STATE().open){
              window.SLIDECART_UPDATE();
              window.SLIDECART_OPEN();
            }
          },
          600);
        }
      }catch(error){
        console.error(error);
      }
}

//Send ajax call to add to cart
wideBundle.addToCartAjax = function(itemsToAddToCart){
    return window.originalFetch("/cart/add.js", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(itemsToAddToCart)
    }).then(response => {
        if (response.ok) {
            return response.text();
        } else {
            throw new Error(response.statusText);
        }
    }).catch(error => {
        throw new Error(error);
    });
}

//Handle Ecom Solid Side cart
wideBundle.manageEcomSolidSideCart = function(itemsToAddToCart){
    if(typeof window.SOLID != 'undefined'){
        isGemPages = wideBundle.formInfo.element.closest('[class^=\'gt_section-\'][data-name], [class^=\'gf_section-\'][data-name], [class^=\'gt_widget-\'][data-name], [class^=\'gt_element-\'][data-name]');
        if(isGemPages){
            wideBundle.managePixels();

            wideBundle.addToCartAjax(itemsToAddToCart)
                .then(async function(responseText) {
                    await window.SOLID.cart.GetCart();
                    window.SOLID.store.dispatch('addToCartSuccess');
                    window.SOLID.store.dispatch('openCartPopup', 'cart_drawer');
                    return Promise.resolve();
                })
                .catch(function(error) {
                    console.error(error);
                    return Promise.reject(error);
                });
        }
      }
}

//Send pixel events to Facebook, Google, etc
wideBundle.managePixels = function(currencyName){
    var priceAmount = parseFloat(
        wideBundle.getAmountFromPrice(
            document.querySelector(`.wb_hidden_prices .wb_hidden_price[variant-id="${wideBundle.getSelectedVariantId()}"]`).innerHTML
         )
    ).toFixed(2);


    if(wideBundle.settings.add_pixel){ //Facebook Pixel
        if(typeof window.fbq !== 'undefined'){
            if(typeof meta != "undefined" && typeof meta.product !== 'undefined'){
                for(var metaVariant in meta.product.variants){
                    if(meta.product.variants[metaVariant].id == wideBundle.getSelectedVariantId()){
                        priceAmount = meta.product.variants[metaVariant].price / 100;
                        window.fbq('track', 'AddToCart', {
                            value: priceAmount.toFixed(2),
                            currency: currencyName
                        });
                    }
                    }
                }
                else{
                    price = document.querySelector('.wb_hidden_prices .wb_hidden_price[variant-id="'+wideBundle.getSelectedVariantId()+'"]');
                    window.fbq('track', 'AddToCart', {
                        value: priceAmount,
                        currency: currencyName
                    });
            }
        }

        //Pinterest Pixel
        if(typeof window.pintrk !== 'undefined'){
            console.log('pinterest pixel found');
            pintrk('track', 'addtocart', {
                value: priceAmount,
                currency: currencyName
            });
        }
    }

    //Snap pixel
    if(typeof window.snaptr !== 'undefined'){
        snaptr('track', 'ADD_CART', {'currency': currencyName, 'price': priceAmount, 'item_category': '', 'item_ids': [] });
    }

    //Tiktok Pixel
    if(typeof window.ttq !== 'undefined'){
        ttq.track('AddToCart');
    }

    //Outbrain pixel
    if(typeof window.obApi !== 'undefined'){
        obApi('track', 'Add To Cart');
    }

    //Taboola Pixel
    if(typeof _tfa !== 'undefined'){
        _tfa.push({notify: 'event', name: 'add_to_cart'});
    }

    //Klaviyo
    if(typeof _learnq != "undefined"){
        fetch(`${window.location.origin}/cart.js`)
        .then(res => res.clone().json().then(data => {
            var cart = {
                total_price: data.total_price/100,
                $value: data.total_price/100,
                total_discount: data.total_discount,
                original_total_price: data.original_total_price/100,
                items: data.items
            }
            if (typeof item != 'undefined') {
                cart = Object.assign(cart, item)
            }
            console.log(cart);
            _learnq.push(['track', 'Added to Cart', cart]);
        }))
    }
}

//Show the loading gif on the add to cart button
wideBundle.displayLoadingOnATC = function(){
    loadingHTML = `<img class="loading-wb" src='${GetLoadingGifBase64()}' width="20px" height="20px" />`;
    if(document.querySelector('#new-form-atc')){
        document.querySelector('#new-form-atc').innerHTML = loadingHTML;
    }
    for(var i=0; i<document.querySelectorAll('.new-form-atc').length; i++){
        document.querySelectorAll('.new-form-atc')[i].innerHTML = loadingHTML;
    }
    if(document.querySelector('#checkout-xx-aa')){
        document.querySelector('#checkout-xx-aa').style.display = "block";
    }
}

//Put back the text to the add to cart button
wideBundle.removeLoadingOnATC = function(){
    setTimeout(function(){
        if(document.querySelector('#new-form-atc')){
            document.querySelector('#new-form-atc').innerHTML = AddSVG()+wideBundle.settings.atc_text;
            document.querySelector('#new-form-atc').style.pointerEvents = 'auto';
        }
        for(var i=0; i<document.querySelectorAll('.new-form-atc').length; i++){
            document.querySelectorAll('.new-form-atc')[i].innerHTML = AddSVG()+wideBundle.settings.atc_text;
            document.querySelectorAll('.new-form-atc')[i].style.pointerEvents = 'auto';
        }
        if(document.querySelector('#checkout-xx-aa')){
            document.querySelector('#checkout-xx-aa').style.display = "none";
        }
    }, 2000);
}

//Handle upload apps (like Uploadlift) so we can send the file to the cart
wideBundle.handleUploadApps = function(){
    if(wideBundle.formInfo.element){
        if(document.querySelector('#new-form .upload-container')){ //Handle Upload Kit App
          UploadKitElementsInForm = wideBundle.formInfo.element.querySelectorAll('.wb-uploadlift');
          UploadKitElementsInForm.forEach(UploadKitElementInForm => {
            UploadKitElementInForm.remove();
          });
          elementsInUploadKit = document.querySelectorAll('#new-form .upload-container *');
          elementsInUploadKit.forEach(elementInUploadKit => {
            if(typeof elementInUploadKit != "undefined" && typeof elementInUploadKit.getAttribute != "undefined" && elementInUploadKit.getAttribute("name") != null && elementInUploadKit.getAttribute("name").indexOf('properties') == 0){
              newNode = elementInUploadKit.cloneNode();
              newNode.style.display = "none";
              newNode.classList.add('wb-uploadlift');
              wideBundle.formInfo.element.append(newNode);
            }
          });
        }
      }
}

//Update the <select> in the form (name = id) with another variant ID
wideBundle.updateVariantIdSelector = function(variantId){
    variantIdSelector = wideBundle.formInfo.element.querySelector('[name="id"]');
    variantIdSelectorArray = wideBundle.formInfo.element.querySelector('[name="id[]"]');
    if(variantIdSelector){
        var options = variantIdSelector.querySelectorAll('option');
        for(var i = 0; i < options.length; i++){
            if(options[i].value == variantId){
                options[i].selected = true;
            }
        }
        variantIdSelector.value = variantId;
    }
    else if(!variantIdSelectorArray){ //Create ourselves the element
        let input = document.createElement('input');
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "id");
        input.setAttribute("value", variantId);
        input.classList.add("wb-variant-selector");
        if(wideBundle.formInfo.element){
            old_input = wideBundle.formInfo.element.querySelectorAll('.wb-variant-selector'); //Remove old one
            for(var a=0; a<old_input.length; a++){
                old_input[a].remove();
            }
            wideBundle.formInfo.element.appendChild(input);
            var inputCopy = input.cloneNode(true);
            if(!window.openCart){ //Don't add the second one if the app MonsterUpsell is enabled on the store
              wideBundle.formInfo.element.insertBefore(inputCopy, wideBundle.formInfo.element.firstChild);
            }
            return true;
        }
    }
    return false;
}

//Display error if the user is on side cart redirection without add to cart and/or variants selector
wideBundle.showErrorIfSideCart = function(){
    //For GemPages variants selector and atc button
    var message = "";
    if((!wideBundle.getVariantsSelector() || !wideBundle.getAddToCartButton()) &&
    ((document.querySelector(".gf_row") && document.querySelector('body.gempage') && document.querySelector("div[data-label='Product']")) ||
        (document.querySelector('div[label="Block"]') && document.querySelector('gp-product')))
    ){
        if(!wideBundle.getVariantsSelector() && !wideBundle.getAddToCartButton()){
            message = "You need to add the variants selector and add-to-cart button from GemPages when side cart redirection is selected.";
        }
        else if(!wideBundle.getVariantsSelector()){
            message = "You need to add the variants selector from GemPages when side cart redirection is selected.";
        }
        else if(!wideBundle.getAddToCartButton()){
            message = "You need to add the add-to-cart button from GemPages when side cart redirection is selected.";
        }
        wideBundle.createError(message, "https://help.widebundle.com/en/article/how-to-use-the-side-cart-with-gempages-2q8d7q/#3-1-add-the-variant-selector-the-add-to-cart-button-and-the-quantity-selector")
        return true;
    }

    //For PageFly variants selector and atc button
    else if((!wideBundle.getVariantsSelector() || !wideBundle.getAddToCartButton()) && document.querySelector("div[data-pf-type='Body']")){
        wideBundle.createError("You have to use WideBundle's module from PageFly.", "https://help.widebundle.com/en/article/how-to-use-widebundle-with-pagefly-suqsj9/#2-add-the-widebundle-module")
        if(!wideBundle.getVariantsSelector() && !wideBundle.getAddToCartButton()){
            message = "You need to add the variants selector and add-to-cart button from PageFly when side cart redirection is selected.";
        }
        else if(!wideBundle.getVariantsSelector()){
            message = "You need to add the variants selector from PageFly when side cart redirection is selected.";
        }
        else if(!wideBundle.getAddToCartButton()){
            message = "You need to add the add-to-cart button from PageFly when side cart redirection is selected.";
        }
        wideBundle.createError(message, "https://help.widebundle.com/en/article/how-to-use-the-side-cart-with-pagefly-5q1ou9/#3-1-add-the-variant-selector-the-add-to-cart-button-and-the-quantity-selector")
        return true;
    }

    //For normal themes variants selector and atc button
    else if(!wideBundle.getAddToCartButton()){
        message = "You need to add the add-to-cart button in your theme when side cart redirection is selected.";
        wideBundle.createError(message, "https://help.widebundle.com/en/article/how-to-add-add-to-cart-button-in-your-theme-1lq4a2b/")
        return true;
    }
    else if(!wideBundle.getVariantsSelector()){
        message = "You need to add the variants selector in your theme when side cart redirection is selected.";
        wideBundle.createError(message, "https://help.widebundle.com/en/article/how-to-add-a-variant-selector-in-my-theme-1q74hv4/")
        return true;
    }
    
    return false;
}

//Show Error if the variant doesn't exist
wideBundle.showErrorIfNonExistingVariant = function(){
    if(typeof wideBundle.variantsOnShopify != "undefined"){
        var variantExisting = 0;
        for(var i = 0; i<wideBundle.variantsOnShopify.length; i++){
            var currentVariant = wideBundle.variantsOnShopify[i];
            if(typeof currentVariant["id"] != "undefined" && currentVariant["id"] == wideBundle.getSelectedVariantId()){
                variantExisting = 1;
                break;
            }
        }
        if(!variantExisting){
            message = "This variant doesn't exist on Shopify.";
            wideBundle.createError(message, "https://help.widebundle.com/en/article/i-have-the-error-this-variant-doesnt-exist-on-shopify-5lci9m/")
            return true;
        }
    }
    return false;
}
//Init WideBundle Widget
wideBundle.init = function(data){
    console.log("WideBundle init started");

    wideBundle.transformMainElement(); //If we only have secondary widgets we create one main with HD
    wideBundle.declareVariables(); //We declare the variables we need
    wideBundle.getOffersData(data); //We structure the offers data

    wideBundle.priceInfo = wideBundle.getPriceNode(); //We get the price node and the price id if the user enabled the update price design
    if(wideBundle.priceInfo.element.length > 0){
        wideBundle.replacePriceIdInDB(); //We replace the price id in the database
        wideBundle.hideUnwantedPrices(); //We hide prices duplicated if the user enabled the update price design
    }
    wideBundle.replaceSelectedPrice(); //For some exceptions we will replace the price we have in priceInfo

    wideBundle.formInfo = wideBundle.getFormNode(); //Get the form node and the form id so we can replace it with WB widget
    wideBundle.replaceSelectedForm(); //For some exceptions we will replace the form we have in formInfo
    wideBundle.manualWidget = wideBundle.getManualWidget(); //Get the widget if added manually (usually for page builders) or null
    wideBundle.secondaryWidgets = wideBundle.getSecondaryWidgets(); //Get other widebundle in the page using class

    //Hide elements only if there is form
    if(wideBundle.formInfo.element){
        wideBundle.replaceFormIdInDB(); //We replace the form id in the database
        wideBundle.hideElementsOutsideProductForm(); //We hide elements we don't want in the product form found
        if(!wideBundle.manualWidget){
          wideBundle.showElementsFromProductForm(); //We show elements that WideBundle hides in the product form using a JS function
        }
        wideBundle.showAndHideElementsWithInterval(); //Other elements that should be shown/hidden with specific system (like eventListeners)
    }
    else if(wideBundle.manualWidget){ //If there is no form but there is a manual widget we will use the form id of the manual widget
        wideBundle.formInfo.element = wideBundle.manualWidget;
        wideBundle.replaceFormIdInDB();
        //wideBundle.hideElementsOutsideProductForm(); //We hide elements we don't want in the product form found
    }

    if(wideBundle.formInfo.element || wideBundle.manualWidget){ //If we found a product form or a manual widget
        window.formWB = wideBundle.formInfo.element; //We set the formWB variable to the form we found
        window.form = wideBundle.formInfo.element; //We set the form variable to the form we found
        if(!wideBundle.manualWidget){
            wideBundle.widgetContainers.push(wideBundle.createWidgetContainer()); //We create the container for the widget
        }
        else{
            wideBundle.widgetContainers.push(wideBundle.manualWidget); //We use the container for the widget that was manually added
        }

        Array.prototype.push.apply(wideBundle.widgetContainers, wideBundle.secondaryWidgets); //We add the secondary widgets to the widgetContainers array

        wideBundle.addHiddenPrices(); //Add prices of the offers to hidden div so we can use them later

        for(var i = 0; i < wideBundle.widgetContainers.length; i++){ //For each widget container
            var widgetContainer = wideBundle.widgetContainers[i];
            wideBundle.createWidgetContent(widgetContainer); //We create the content of the widget
        }

        wideBundle.loadGoogleFonts(); //Function to create tags <link> for all used Google fonts
        wideBundle.addMainStyle(); //We add the main css style of WideBundle
        wideBundle.addStructureStyle(); //We add the css style for quantity buttons and layout structure used
        wideBundle.addPricesFromAjax(); //If we couldn't get prices from json we will get them from ajax and replace them
        wideBundle.preselectOffer(); //Select at least one offer
        wideBundle.addLinkToCheckout(); //Add the link for the checkout to make it work
        wideBundle.updatePricesInOffer(); //Update prices in the widget based on the offer selected
        wideBundle.addBlinkingEffect(); //Add the blinking effect to the widget (for custom sentences)
        addStyleToPage(wideBundle.settings.custom_css); //Add custom css added in the admin dashboard
        wideBundle.regenerateWideBundle(); //Regenerate WideBundle if for some reason the widget isn't working
        wideBundle.updateVariantSelectedInFormWithConditions(); //Update the offer selected (based on url)
        wideBundle.runTranslationApps(); //Run translations
        wideBundle.takeAppsOut(); //Take out some apps from the product form. These apps usually load later and are more complex to take out than basic elements
        wideBundle.handleErrorsPageBuilders();
        wideBundle.updateQuantityDisabled();
        wideBundle.updateDiagonalOffer();
        wideBundle.getVariantsOnShopify(); //Get the variants of the product from Shopify
        const appLoadedEvent = new Event('widebundle:loaded'); //Send event that WB loaded
        document.dispatchEvent(appLoadedEvent);
    }
};

//Get the product loaded on the page that needs WideBundle
wideBundle.getProductHandleOnPage = function() {
    var path = location.pathname.split("/");
    var pathHandle = path[path.length - 1] || path[path.length - 2];
    var urlHandles = ['products/', 'collections/', 'page/', 'pages/', 'blog/', 'blogs/'];
    var urlHandlesPos = posInUrl(location.href, urlHandles);


    //If handleWide exists
    if(typeof handleWide != 'undefined'){
        wideBundle.currentHandle = handleWide;
        return handleWide;
    }

    //If we are on product page
    if(urlHandlesPos['products/'] > -1){
        wideBundle.currentHandle = pathHandle;
        return pathHandle;
    }
    //If we are on homepage
    else if (typeof meta != 'undefined' &&
             typeof meta.page != 'undefined' &&
             meta.page.pageType == 'home' &&
             urlHandlesPos['collections/'] == -1) {
        wideBundle.currentHandle = "isOnHomePage";
        return 'isOnHomePage';
    }
    //If we are on a custom page and widebundleHandle exists
    else if (typeof meta != 'undefined' &&
             typeof meta.page != 'undefined' &&
             (meta.page.pageType == 'page' || meta.page.pageType == 'article' )&&
             (urlHandlesPos['page/'] == 1 || urlHandlesPos['pages/'] > 1 || urlHandlesPos['blog/'] == 1 || urlHandlesPos['blogs/'] > 1) &&
             typeof widebundleHandle != 'undefined') {
        wideBundle.currentHandle = widebundleHandle;
        return widebundleHandle;
    }
};

//First function run for WideBundle to get data from the server
(function(){
    wideBundle.dataRequested = false;
    shopWB = ""; //We created this variable so that other WideBundle script will think it's currently loaded
    //document.addEventListener('DOMContentLoaded', function() {
        if(!wideBundle.dataRequested){
          wideBundle.dataRequested = true;
          // Get store information
          shop = wideBundle.shop;
          productHandle = wideBundle.getProductHandleOnPage();

          var url = wideBundle.domain + 'scripttagAjax.php';
          url += '?shop=' + encodeURIComponent(shop);
          url += '&productHandle=' + encodeURIComponent(productHandle);

          function restoreFetch() { //Get original fetch to bypass theme delay problems
              if (!window._restoredFetch) {
                  const iframe = document.createElement('iframe');

                  iframe.style.display = 'none';
                  document.body.appendChild(iframe);

                  window._restoredFetch = iframe.contentWindow.fetch;
              }

              return window._restoredFetch;
          }
          if(typeof window.originalFetch == typeof undefined){
      			window.originalFetch = restoreFetch();
      		}

          // Make Ajax call after store information is available
          async function getProductData() {
              try{
                const response = await window.originalFetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-type': 'application/json;charset=UTF-8'
                    }
                });
                if(response.ok){
                    const data = await response.json();
                    wideBundle.data = data;
                    for (let i = 0; i < wideBundle.data.length; i++) {
                        for (let key in wideBundle.data[i]) {
                            if (!isNaN(parseInt(key))) {
                                delete wideBundle.data[i][key];
                            }
                        }
                    }
                    if (wideBundle.data.length > 0) {
                        if(wideBundle.currentHandle == "isOnHomePage"){
                          wideBundle.currentHandle = wideBundle.data[0].handle;
                        }

                        if (wideBundle.settings.plan !== "monthly") {
                            const productTemplate = wideBundle.templates.find(template => template.product_id == wideBundle.data[0].product_id);
                            if (productTemplate) {
                                wideBundle.settings = { ...wideBundle.settings, ...productTemplate };
                            }
                        }

                        wideBundle.init(wideBundle.data);
                    }
                }
                else{
                    console.error('Error:', response.statusText);
                }
              }catch(error){
                  console.error('Error:', error);
              }
          }

          // Call the function to make the Ajax call
          getProductData();
        }
    //});
})()

}
